

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>bioat.lib.libjgi &mdash; bioat Documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=03e43079" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=e59714d7" />

  
      <script src="../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../_static/documentation_options.js?v=3a3a8e7f"></script>
      <script src="../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            bioat
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../modules.html">Modules</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">bioat</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">bioat.lib.libjgi</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for bioat.lib.libjgi</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span><span class="w"> </span><span class="nn">datetime</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">gzip</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">tarfile</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">textwrap</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">xml.etree.ElementTree</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">ET</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">defaultdict</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">hashlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">md5</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">requests</span><span class="w"> </span><span class="kn">import</span> <span class="n">HTTPError</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">requests.exceptions</span><span class="w"> </span><span class="kn">import</span> <span class="n">ChunkedEncodingError</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">tqdm</span><span class="w"> </span><span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">urllib3.exceptions</span><span class="w"> </span><span class="kn">import</span> <span class="n">InvalidChunkLength</span><span class="p">,</span> <span class="n">ProtocolError</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">bioat.exceptions</span><span class="w"> </span><span class="kn">import</span> <span class="n">BioatInvalidOptionError</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">bioat.lib.libpath</span><span class="w"> </span><span class="kn">import</span> <span class="n">HOME</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">bioat.lib.libspider</span><span class="w"> </span><span class="kn">import</span> <span class="n">ProxyPool</span><span class="p">,</span> <span class="n">get_random_user_agents</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">bioat.logger</span><span class="w"> </span><span class="kn">import</span> <span class="n">LoggerManager</span>

<span class="n">lm</span> <span class="o">=</span> <span class="n">LoggerManager</span><span class="p">(</span><span class="n">mod_name</span><span class="o">=</span><span class="s2">&quot;bioat.lib.libjgi&quot;</span><span class="p">)</span>


<div class="viewcode-block" id="JGIDoc">
<a class="viewcode-back" href="../../../bioat.lib.html#bioat.lib.libjgi.JGIDoc">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">JGIDoc</span><span class="p">:</span>
    <span class="n">lm</span><span class="o">.</span><span class="n">set_names</span><span class="p">(</span><span class="n">cls_name</span><span class="o">=</span><span class="s2">&quot;JGIDoc&quot;</span><span class="p">)</span>
    <span class="n">DEFAULT_CATEGORIES</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;ESTs&quot;</span><span class="p">,</span>
        <span class="s2">&quot;EST Clusters&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Assembled scaffolds (unmasked)&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Assembled scaffolds (masked)&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Transcripts&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Genes&quot;</span><span class="p">,</span>
        <span class="s2">&quot;CDS&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Proteins&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Additional Files&quot;</span><span class="p">,</span>
    <span class="p">]</span>
    <span class="n">usage_example_blurb</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">        This tool will retrieve files from JGI</span>
<span class="s2">        It will return a list of possible files for downloading.</span>
<span class="s2">    </span>
<span class="s2">        To get &lt;jgi_address&gt;, go to: http://genome.jgi.doe.gov/ and search for your</span>
<span class="s2">        species of interest. Click through until you are at the &quot;Info&quot; page. For</span>
<span class="s2">        </span><span class="se">\x1B</span><span class="s2">[3mNematostella vectensis</span><span class="se">\x1B</span><span class="s2">[23m, the appropriate page is</span>
<span class="s2">        &quot;http://genome.jgi.doe.gov/Nemve1/Nemve1.info.html&quot;.</span>
<span class="s2">    </span>
<span class="s2">        To query using only the name simply requires the specific JGI organism</span>
<span class="s2">        abbreviation, as referenced in the full url.</span>
<span class="s2">    </span>
<span class="s2">        For the above example, the proper input syntax for this script would be:</span>
<span class="s2">    </span>
<span class="s2">        $ bioat meta JGI_query -q http://genome.jgi.doe.gov/Nemve1/Nemve1.info.html</span>
<span class="s2">    </span>
<span class="s2">                                 -or-</span>
<span class="s2">    </span>
<span class="s2">        $ bioat meta JGI_query -q Nemve1</span>
<span class="s2">    </span>
<span class="s2">        If you already have the XML file for the query in the directory, you may use</span>
<span class="s2">        the --xml flag to avoid redownloading it (particularly useful if querying</span>
<span class="s2">        large, top-level groups with many sub-species, such as &quot;fungi&quot;):</span>
<span class="s2">    </span>
<span class="s2">        $ bioat meta JGI_query -x &lt;your_xml_index&gt;</span>
<span class="s2">        </span>
<span class="s2">        If the XML filename is omitted when using the -x/--xml flag, it is assumed that</span>
<span class="s2">        the XML file is named &quot;jgi-xml-query.result_&lt;organism-name&gt;.xml&quot;. In such cases, the</span>
<span class="s2">        organism name is required.</span>
<span class="s2">        &quot;&quot;&quot;</span>
    <span class="n">select_blurb</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">        # SYNTAX ///////////////////////////////////////////////////////////////////////</span>
<span class="s2">        Using the following format syntax to download selected file:</span>
<span class="s2">            &lt;category number&gt;:&lt;i&gt;[,&lt;i&gt;, &lt;i&gt;];&lt;category number&gt;:&lt;i&gt;-&lt;i&gt;;...</span>
<span class="s2">        </span>
<span class="s2">        Indices (&lt;i&gt;) may be a mixture of comma-separated values and hyphen-separated </span>
<span class="s2">        ranges. </span>
<span class="s2">        </span>
<span class="s2">        Example:</span>
<span class="s2">            &#39;3:4,5; 7:1-10,13&#39; will select elements 4 and 5 from category 3, and 1-10 </span>
<span class="s2">            plus 13 from category 7.</span>
<span class="s2">        # /SYNTAX ///////////////////////////////////////////////////////////////////////</span>
<span class="s2">        &quot;&quot;&quot;</span></div>



<div class="viewcode-block" id="JGIConfig">
<a class="viewcode-back" href="../../../bioat.lib.html#bioat.lib.libjgi.JGIConfig">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">JGIConfig</span><span class="p">:</span>
    <span class="n">lm</span><span class="o">.</span><span class="n">set_names</span><span class="p">(</span><span class="n">cls_name</span><span class="o">=</span><span class="s2">&quot;JGIConfig&quot;</span><span class="p">)</span>
    <span class="n">URL_JGI_MAIN</span> <span class="o">=</span> <span class="s2">&quot;https://genome.jgi.doe.gov&quot;</span>  <span class="c1"># url home for jgi-img database</span>
    <span class="n">URL_JGI_LOGIN</span> <span class="o">=</span> <span class="s2">&quot;https://signon.jgi.doe.gov/signon/create&quot;</span>  <span class="c1"># url login</span>
    <span class="n">URL_JGI_FETCH_XML</span> <span class="o">=</span> <span class="s2">&quot;https://genome.jgi.doe.gov/portal/ext-api/downloads/get-directory&quot;</span>  <span class="c1"># url fetch xml</span>
    <span class="n">FILENAME_TEMPLATE_XML</span> <span class="o">=</span> <span class="s2">&quot;jgi-xml-query.result_</span><span class="si">{}</span><span class="s2">.xml&quot;</span>
    <span class="n">FILENAME_TEMPLATE_LOG_FAIL</span> <span class="o">=</span> <span class="s2">&quot;jgi-xml-query.failed_</span><span class="si">{}</span><span class="s2">.log&quot;</span>
    <span class="n">FILENAME_COOKIE</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">HOME</span><span class="p">,</span> <span class="s2">&quot;.bioat&quot;</span><span class="p">,</span> <span class="s2">&quot;JGI&quot;</span><span class="p">,</span> <span class="s2">&quot;cookie&quot;</span><span class="p">)</span>
    <span class="n">FILENAME_CONFIG_PATH</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">HOME</span><span class="p">,</span> <span class="s2">&quot;.bioat&quot;</span><span class="p">,</span> <span class="s2">&quot;JGI&quot;</span><span class="p">,</span> <span class="s2">&quot;account.conf&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">overwrite_conf</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
        <span class="n">lm</span><span class="o">.</span><span class="n">set_names</span><span class="p">(</span><span class="n">func_name</span><span class="o">=</span><span class="s2">&quot;__init__&quot;</span><span class="p">)</span>
        <span class="n">lm</span><span class="o">.</span><span class="n">set_level</span><span class="p">(</span><span class="s2">&quot;DEBUG&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;user&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;password&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;categories&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;start to set / load user info...&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">overwrite_conf</span><span class="p">:</span>
            <span class="c1"># 只要指定重写参数就重写，无需判断其他</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">input_user_info</span><span class="p">()</span>  <span class="c1"># 从终端手动输入JGI用户信息</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">save_config</span><span class="p">()</span>  <span class="c1"># 保存用户信息</span>
            <span class="c1"># 然后直接退出</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;Configuration complete.</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;Script may now be used to query JGI.</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;You need re-run your command without parameter `--overwrite_conf`</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="c1"># self.load_config()  # 从文件加载用户信息</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">FILENAME_CONFIG_PATH</span><span class="p">)</span>
                    <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getsize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">FILENAME_CONFIG_PATH</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
            <span class="p">):</span>
                <span class="c1"># 直接加载配置信息</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">load_config</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># 配置信息保存文件异常</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;errors occur when loading file: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">FILENAME_CONFIG_PATH</span><span class="si">}</span><span class="s2">!</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;try to get user info by manual inputting...&quot;</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">input_user_info</span><span class="p">()</span>  <span class="c1"># 从终端手动输入JGI用户信息</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">save_config</span><span class="p">()</span>  <span class="c1"># 保存用户信息</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">load_config</span><span class="p">()</span>  <span class="c1"># 从文件加载用户信息</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;set / load user info success!&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="JGIConfig.load_config">
<a class="viewcode-back" href="../../../bioat.lib.html#bioat.lib.libjgi.JGIConfig.load_config">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">load_config</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reads &quot;user&quot;, &quot;password&quot; and &quot;categories&quot; entries</span>
<span class="sd">        from config file.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;loading JGI account info...&quot;</span><span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">FILENAME_CONFIG_PATH</span><span class="p">,</span> <span class="s2">&quot;rt&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;user&quot;</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;user&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;password&quot;</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;password&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;categories&quot;</span><span class="p">):</span>
                    <span class="n">cats</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;categories&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">e</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">cats</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;user&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;password&quot;</span><span class="p">]]):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Config file present (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">FILENAME_CONFIG_PATH</span><span class="si">}</span><span class="s2">), but user and/or password not found.&quot;</span>
            <span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;loading JGI account info done&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="JGIConfig.input_user_info">
<a class="viewcode-back" href="../../../bioat.lib.html#bioat.lib.libjgi.JGIConfig.input_user_info">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">input_user_info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Dialog with user to gather user information for</span>
<span class="sd">        use with the curl query. Returns a dict.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">blurb</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        === USER SETUP ===</span>

<span class="s2">        JGI access configuration:</span>

<span class="s2">        Before continuing, you will need to provide your JGI login credentials.</span>
<span class="s2">        These are required by JGI&#39;s curl api, and will be stored in a config</span>
<span class="s2">        file for future use (unless you choose to delete them).</span>

<span class="s2">        If you need to sign up for a JGI account, use the registration link at</span>
<span class="s2">        https://contacts.jgi.doe.gov/registration/new</span>

<span class="s2">        === CREDENTIALS ===</span>
<span class="s2">        &quot;&quot;&quot;</span>
        <span class="c1"># Print left-justified triple-quoted text blocks</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">textwrap</span><span class="o">.</span><span class="n">dedent</span><span class="p">(</span><span class="n">blurb</span><span class="p">))</span>
        <span class="n">user_query</span> <span class="o">=</span> <span class="s2">&quot;JGI account username/email (or &#39;q&#39; to quit): &quot;</span>

        <span class="c1"># write user and passwd from interactive terminal</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;user&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="n">user_query</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;user&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;q&quot;</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s2">&quot;Exiting now.&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;password&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;JGI account password (or &#39;q&#39; to quit): &quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;password&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;q&quot;</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s2">&quot;Exiting now.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;user&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;password&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;user and password can not be None!&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">input_user_info</span><span class="p">()</span>

        <span class="n">input_blurb</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Proceed with USER=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">, PASSWORD=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;password&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> to configure &quot;</span>
            <span class="s2">&quot;script?</span><span class="se">\n</span><span class="s2">([y]es, [n]o, [r]estart): &quot;</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;categories&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">JGIDoc</span><span class="o">.</span><span class="n">DEFAULT_CATEGORIES</span>

        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>  <span class="c1"># catch invalid responses</span>
            <span class="n">choice</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="n">input_blurb</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">choice</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;y&quot;</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="k">elif</span> <span class="n">choice</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;n&quot;</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s2">&quot;Exiting now.&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">choice</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;r&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">input_user_info</span><span class="p">()</span></div>


<div class="viewcode-block" id="JGIConfig.save_config">
<a class="viewcode-back" href="../../../bioat.lib.html#bioat.lib.libjgi.JGIConfig.save_config">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">save_config</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates a config file &lt;config_path&gt; using</span>
<span class="sd">        credentials from dict &lt;config_info&gt;.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;saving JGI account info...&quot;</span><span class="p">)</span>
        <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;user&quot;</span><span class="p">]</span>
        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;password&quot;</span><span class="p">]</span>
        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;categories&quot;</span><span class="p">]</span>
        <span class="n">c</span> <span class="o">=</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
        <span class="n">header</span> <span class="o">=</span> <span class="s2">&quot;# bioat meta JGI_query: JGI account info and essentials </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="s2">&quot;#&quot;</span> <span class="o">*</span> <span class="mi">24</span>
        <span class="p">)</span>
        <span class="n">info</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;user=</span><span class="si">{</span><span class="n">u</span><span class="si">}</span><span class="se">\n</span><span class="s2">password=</span><span class="si">{</span><span class="n">p</span><span class="si">}</span><span class="se">\n</span><span class="s2">categories=</span><span class="si">{</span><span class="n">c</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">FILENAME_CONFIG_PATH</span><span class="p">)):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">FILENAME_CONFIG_PATH</span><span class="p">))</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">FILENAME_CONFIG_PATH</span><span class="p">,</span> <span class="s2">&quot;wt&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">info</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;saving JGI account info done&quot;</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="JGIOperator">
<a class="viewcode-back" href="../../../bioat.lib.html#bioat.lib.libjgi.JGIOperator">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">JGIOperator</span><span class="p">:</span>
    <span class="n">lm</span><span class="o">.</span><span class="n">set_names</span><span class="p">(</span><span class="n">cls_name</span><span class="o">=</span><span class="s2">&quot;JGIOperator&quot;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="c1"># pick one from three</span>
            <span class="n">query_info</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">xml</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">log_fails</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="c1"># runtime params</span>
            <span class="n">nretry</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
            <span class="n">timeout</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">regex</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">all_get</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
            <span class="n">overwrite_conf</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
            <span class="n">filter_files</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
            <span class="n">proxy_pool</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">just_query_xml</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
            <span class="c1"># doc helper</span>
            <span class="n">syntax_help</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
            <span class="n">usage</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
            <span class="c1"># log</span>
            <span class="n">log_level</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;INFO&quot;</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="n">lm</span><span class="o">.</span><span class="n">set_names</span><span class="p">(</span><span class="n">func_name</span><span class="o">=</span><span class="s2">&quot;__init__&quot;</span><span class="p">)</span>
        <span class="n">lm</span><span class="o">.</span><span class="n">set_level</span><span class="p">(</span><span class="n">log_level</span><span class="p">)</span>
        <span class="c1"># from cmd parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">query_info</span> <span class="o">=</span> <span class="n">query_info</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xml</span> <span class="o">=</span> <span class="n">xml</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_fails</span> <span class="o">=</span> <span class="n">log_fails</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nretry</span> <span class="o">=</span> <span class="n">nretry</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">timeout</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="k">else</span> <span class="n">timeout</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">regex</span> <span class="o">=</span> <span class="n">regex</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">all_get</span> <span class="o">=</span> <span class="n">all_get</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">overwrite_conf</span> <span class="o">=</span> <span class="n">overwrite_conf</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filter_files</span> <span class="o">=</span> <span class="n">filter_files</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">just_query_xml</span> <span class="o">=</span> <span class="n">just_query_xml</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">syntax_help</span> <span class="o">=</span> <span class="n">syntax_help</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">usage</span> <span class="o">=</span> <span class="n">usage</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_level</span> <span class="o">=</span> <span class="n">log_level</span>
        <span class="c1"># self</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dict_to_get</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_urls_to_get</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_url_to_validate</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_selections</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_downloaded_files</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_failed_urls</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log_fails_loaded</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_desired_categories</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cookie</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_user_agent</span> <span class="o">=</span> <span class="n">get_random_user_agents</span><span class="p">()</span>
        <span class="c1"># From other obj #</span>
        <span class="c1"># load configs; auto check if you need overwrite user info or not</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">JGIConfig</span><span class="p">(</span><span class="n">overwrite_conf</span><span class="o">=</span><span class="n">overwrite_conf</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interactive</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># load docs;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">docs</span> <span class="o">=</span> <span class="n">JGIDoc</span>
        <span class="c1"># load proxy</span>
        <span class="k">if</span> <span class="n">proxy_pool</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_proxy_pool</span> <span class="o">=</span> <span class="n">ProxyPool</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">proxy_pool</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_proxy_ip</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_proxy_pool</span><span class="o">.</span><span class="n">get_proxy</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;proxy&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_proxies</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;http&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;http://</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_proxy_ip</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">}</span>
            <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;use proxy mode! proxy_pool = </span><span class="si">{</span><span class="n">proxy_pool</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;now proxy IP = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_proxy_ip</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_proxy_pool</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_proxy_ip</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_proxies</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># / From other obj</span>
        <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;checker for doc mode&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_run_doc</span><span class="p">()</span>
        <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;checker for input&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_parse_input</span><span class="p">()</span>
        <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;run login&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_load_cookie</span><span class="p">()</span>

    <span class="c1"># step 01 print and exit</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_run_doc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Checker for doc mode.</span>

<span class="sd">        print syntax_help and/or usage if these parameters are defined. And then, exit progress.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">lm</span><span class="o">.</span><span class="n">set_names</span><span class="p">(</span><span class="n">func_name</span><span class="o">=</span><span class="s2">&quot;_run_doc&quot;</span><span class="p">)</span>
        <span class="n">lm</span><span class="o">.</span><span class="n">set_level</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log_level</span><span class="p">)</span>

        <span class="n">run_docs</span> <span class="o">=</span> <span class="nb">any</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">syntax_help</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">usage</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">run_docs</span><span class="p">:</span>
            <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;doc mode is selected&quot;</span><span class="p">)</span>
            <span class="c1"># Check if user wants query help</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">syntax_help</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[syntax_help]:</span><span class="se">\n</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">docs</span><span class="o">.</span><span class="n">select_blurb</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">usage</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[usage]:</span><span class="se">\n</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">docs</span><span class="o">.</span><span class="n">usage_example_blurb</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s2">&quot;Done. exit.&quot;</span><span class="p">)</span>
            <span class="c1"># finally exit</span>

    <span class="c1"># step 02 update self.query_info and self.log_fails and followed by self.login</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_parse_input</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Checker for input.</span>

<span class="sd">        A checker for this rule: ONLY ONE of the parameters (&#39;query_info&#39;, &#39;xml&#39; and &#39;log_fails&#39;) can be specified;</span>
<span class="sd">        Parse query_info/xml/log_fails to update self.query_info and self.log_fails.</span>
<span class="sd">        After this method, you should call self.login method and then self.query method</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">lm</span><span class="o">.</span><span class="n">set_names</span><span class="p">(</span><span class="n">func_name</span><span class="o">=</span><span class="s2">&quot;_parse_input&quot;</span><span class="p">)</span>
        <span class="n">lm</span><span class="o">.</span><span class="n">set_level</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log_level</span><span class="p">)</span>
        <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;update JGIOperator obj.query_info and obj.log_fails using parameters:&quot;</span>
            <span class="s2">&quot; &#39;query_info&#39;, &#39;xml&#39; and &#39;log_fails&#39;&quot;</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">bool</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">query_info</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_fails</span><span class="p">]))</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># 这三个参数只可以指定一个！</span>
            <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s2">&quot;ONLY ONE of the parameters (&#39;query_info&#39;, &#39;xml&#39; and &#39;log_fails&#39;) can be specified!&quot;</span>
            <span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s2">&quot;Done. exit.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;pass param checker: &#39;query_info&#39;, &#39;xml&#39; and &#39;log_fails&#39;&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_info</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># if query_info is a URL</span>
                <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;attempt to parse query_info as a url&quot;</span><span class="p">)</span>
                <span class="c1"># query_regex = re.compile(r&#39;\.jgi.+\.(?:gov|org).*\/(.+)\/(?!\/)&#39;)</span>
                <span class="n">query_regex</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\.jgi.+\.(?:gov|org).*/(.+)/(?!/)&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">query_info</span> <span class="o">=</span> <span class="n">query_regex</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">query_info</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="c1"># if query_info is an organism name</span>
                <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="s2">&quot;not a url, try to define query_info as an organism name abbreviation&quot;</span>
                <span class="p">)</span>
                <span class="c1"># query_info = query_info</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_fails</span><span class="p">:</span>
            <span class="c1"># load failed info from log file if provided</span>
            <span class="c1"># filename see: class JGIConfig.FILENAME_TEMPLATE_LOG_FAIL</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">query_info</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log_fails</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;failed_&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="p">)</span>

            <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;get self.query_info = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">query_info</span><span class="si">}</span><span class="s2"> from self.log_fails = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">log_fails</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log_fails</span><span class="p">,</span> <span class="s2">&quot;rt&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_log_fails_loaded</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
            <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;get self._log_fails_loaded = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_log_fails_loaded</span><span class="si">}</span><span class="s2"> from self.log_fails = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">log_fails</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml</span><span class="p">:</span>
            <span class="c1"># parse query_info from xml file content</span>
            <span class="n">name_pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;name=</span><span class="se">\&quot;</span><span class="s2">(.+)</span><span class="se">\&quot;</span><span class="s2">&quot;</span>
            <span class="n">_org_line</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xml</span><span class="p">,</span> <span class="s2">&quot;rt&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s2">&quot;organismDownloads&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                        <span class="c1"># standardized name indicator</span>
                        <span class="c1"># &lt;organismDownloads name=&quot;Nemve1&quot;&gt;</span>
                        <span class="n">_org_line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                        <span class="k">break</span>  <span class="c1"># don&#39;t keep looking, already found</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">query_info</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">name_pattern</span><span class="p">,</span> <span class="n">_org_line</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>  <span class="c1"># org_line still None</span>
                <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s2">&quot;the xml file seems wrong&quot;</span><span class="p">)</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s2">&quot;Exit with errors.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s2">&quot;one of the parameters &#39;query_info&#39; and &#39;xml&#39; should be specified&quot;</span>
            <span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s2">&quot;Done. exit.&quot;</span><span class="p">)</span>

    <span class="c1"># step 03 login</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_load_cookie</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">lm</span><span class="o">.</span><span class="n">set_names</span><span class="p">(</span><span class="n">func_name</span><span class="o">=</span><span class="s2">&quot;_load_cookie&quot;</span><span class="p">)</span>
        <span class="n">lm</span><span class="o">.</span><span class="n">set_level</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log_level</span><span class="p">)</span>

        <span class="c1"># prepare info</span>
        <span class="n">url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">URL_JGI_LOGIN</span>
        <span class="n">cookie_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">FILENAME_COOKIE</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">cookie_file</span><span class="p">):</span>
            <span class="c1"># if local</span>
            <span class="n">exist_time</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getmtime</span><span class="p">(</span><span class="n">cookie_file</span><span class="p">))</span>
                    <span class="o">-</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">()</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="n">exist_time</span> <span class="o">&lt;=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;cookie is expired, try to re-loginning&quot;</span><span class="p">)</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">cookie_file</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_load_cookie</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">cookie_file</span><span class="p">,</span> <span class="s2">&quot;rt&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">cookies_dict</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_cookie</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">cookiejar_from_dict</span><span class="p">(</span><span class="n">cookies_dict</span><span class="p">)</span>
                <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;update self._cookie from [local], self._cookie = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_cookie</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;update self._cookie from [JGI website], trying...&quot;</span><span class="p">)</span>
            <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;User-Agent&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_user_agent</span><span class="p">}</span>
            <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;login&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;user&quot;</span><span class="p">],</span>
                <span class="s2">&quot;password&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;password&quot;</span><span class="p">],</span>
                <span class="s2">&quot;commit&quot;</span><span class="p">:</span> <span class="s2">&quot;Sign In&quot;</span><span class="p">,</span>
            <span class="p">}</span>

            <span class="n">retry_count</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">requests</span><span class="o">.</span><span class="n">session</span><span class="p">()</span> <span class="k">as</span> <span class="n">s</span><span class="p">:</span>  <span class="c1"># set session</span>
                    <span class="c1"># requests.session和直接访问的主要区别在于会话的保持和请求效率。</span>
                    <span class="c1"># - 会话保持, 会话能让我们在跨请求的时候保持某些参数，比如在同一个session实例发出的所有请求之间保持cookie信息。</span>
                    <span class="c1">#            这对于需要登录状态的请求特别有用，因为登录信息可以在整个会话期间保持，而不需要每次请求时都重新输入。</span>
                    <span class="c1"># - 请求效率: 使用requests.session可以避免在每次发送请求时都将cookie信息放到请求内容中，因为session对象能够</span>
                    <span class="c1">#            自动获取到cookie并且可以在下一次请求时自动带上。这可以提高请求效率。</span>
                    <span class="k">if</span> <span class="n">retry_count</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nretry</span><span class="p">:</span>
                        <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;retry_count (</span><span class="si">{</span><span class="n">retry_count</span><span class="si">}</span><span class="s2">) reaching max of self.nretry (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">nretry</span><span class="si">}</span><span class="s2">)...&quot;</span>
                        <span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_clean_exit</span><span class="p">(</span>  <span class="c1"># exit</span>
                            <span class="n">exit_message</span><span class="o">=</span><span class="s2">&quot;exit with error&quot;</span><span class="p">,</span>
                            <span class="n">exit_code</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                            <span class="n">rm_cookie</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                            <span class="n">rm_xml</span><span class="o">=</span><span class="kc">False</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml</span> <span class="k">else</span> <span class="kc">False</span><span class="p">,</span>
                        <span class="p">)</span>  <span class="c1"># exit</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">with</span> <span class="n">s</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
                                <span class="n">url</span><span class="p">,</span>
                                <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span>
                                <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
                                <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">,</span>
                                <span class="n">proxies</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_proxies</span><span class="p">,</span>
                        <span class="p">)</span> <span class="k">as</span> <span class="n">response</span><span class="p">:</span>
                            <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;request.post seems success&quot;</span><span class="p">)</span>
                            <span class="c1"># check response status code</span>
                            <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                                <span class="sa">f</span><span class="s2">&quot;check response status code: </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s2">&quot;</span>
                            <span class="p">)</span>
                            <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
                                <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;login successes, get cookie...&quot;</span><span class="p">)</span>
                                <span class="c1"># save cookie to file</span>
                                <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;save cookie to </span><span class="si">{</span><span class="n">cookie_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                                <span class="n">cookies_dict</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">dict_from_cookiejar</span><span class="p">(</span>
                                    <span class="n">s</span><span class="o">.</span><span class="n">cookies</span>
                                <span class="p">)</span>
                                <span class="n">cookies_str</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">cookies_dict</span><span class="p">)</span>

                                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">cookie_file</span><span class="p">,</span> <span class="s2">&quot;wt&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">cookies_str</span><span class="p">)</span>
                                <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                                    <span class="sa">f</span><span class="s2">&quot;successfully login, write cookie @ </span><span class="si">{</span><span class="n">cookie_file</span><span class="si">}</span><span class="s2">&quot;</span>
                                <span class="p">)</span>
                                <span class="k">break</span>  <span class="c1"># 跳出循环进入</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span>
                                    <span class="s2">&quot;Couldn&#39;t connect with server. Please check Internet connection and retry.&quot;</span>
                                <span class="p">)</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">_clean_exit</span><span class="p">(</span>
                                    <span class="n">exit_message</span><span class="o">=</span><span class="s2">&quot;exit with error&quot;</span><span class="p">,</span>
                                    <span class="n">exit_code</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                    <span class="n">rm_cookie</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                    <span class="n">rm_xml</span><span class="o">=</span><span class="kc">False</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml</span> <span class="k">else</span> <span class="kc">False</span><span class="p">,</span>
                                <span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="c1"># 删除代理池中代理 if self._proxy_ip not None</span>
                        <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;request.post seems fail, remove proxy (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_proxy_ip</span><span class="si">}</span><span class="s2">) in pool&quot;</span>
                        <span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_proxy_pool</span><span class="o">.</span><span class="n">delete_proxy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_proxy_ip</span><span class="p">)</span>
                        <span class="n">retry_count</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="c1"># step 04 query</span>
<div class="viewcode-block" id="JGIOperator.query">
<a class="viewcode-back" href="../../../bioat.lib.html#bioat.lib.libjgi.JGIOperator.query">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">query</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">lm</span><span class="o">.</span><span class="n">set_names</span><span class="p">(</span><span class="n">func_name</span><span class="o">=</span><span class="s2">&quot;query&quot;</span><span class="p">)</span>
        <span class="n">lm</span><span class="o">.</span><span class="n">set_level</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log_level</span><span class="p">)</span>
        <span class="c1"># prepare info</span>
        <span class="n">url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">URL_JGI_FETCH_XML</span>
        <span class="n">cookie_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">FILENAME_COOKIE</span>
        <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;User-Agent&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_user_agent</span><span class="p">}</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;organism&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_info</span><span class="p">}</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">cookie_file</span><span class="p">,</span> <span class="s2">&quot;rt&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">cookies_dict</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
        <span class="n">cookies</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">cookiejar_from_dict</span><span class="p">(</span><span class="n">cookies_dict</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="n">url</span><span class="p">,</span>
                <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span>
                <span class="n">cookies</span><span class="o">=</span><span class="n">cookies</span><span class="p">,</span>
                <span class="n">allow_redirects</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">stream</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span>
                <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">,</span>
                <span class="c1"># proxies=self._proxies</span>
        <span class="p">)</span> <span class="k">as</span> <span class="n">response</span><span class="p">:</span>
            <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;login url requests.get: </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">url</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_proxies</span><span class="p">:</span>
                <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;query using IP: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_proxy_ip</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># 如果响应的状态码不是200，将引发HTTPError异常</span>
                <span class="n">response</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
            <span class="k">except</span> <span class="n">HTTPError</span><span class="p">:</span>
                <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;response status: </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span>
                    <span class="s2">&quot;Couldn&#39;t connect with server. &quot;</span>
                    <span class="s2">&quot;Please check Internet connection (or accession rights) and retry.&quot;</span>
                <span class="p">)</span>
                <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;response.text = </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_clean_exit</span><span class="p">(</span>
                    <span class="n">exit_message</span><span class="o">=</span><span class="s2">&quot;exit with HTTPError&quot;</span><span class="p">,</span>
                    <span class="n">exit_code</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                    <span class="n">rm_cookie</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">rm_xml</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="n">xml_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">FILENAME_TEMPLATE_XML</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">query_info</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">xml_file</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="c1"># 使用二进制写入模式（&quot;wb&quot;）来保存结果文件，</span>
                <span class="c1"># 因为response.content返回的是一个字节字符串</span>
                <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;successfully query, write xml @ </span><span class="si">{</span><span class="n">xml_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>

            <span class="c1"># if just_query_xml = True, exit from here</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">just_query_xml</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_clean_exit</span><span class="p">(</span>
                    <span class="n">exit_message</span><span class="o">=</span><span class="s2">&quot;exit reason: just_query_xml = True&quot;</span><span class="p">,</span>
                    <span class="n">exit_code</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                    <span class="n">rm_cookie</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">rm_xml</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="p">)</span></div>


    <span class="c1"># step 05 parse xml info to update url</span>
<div class="viewcode-block" id="JGIOperator.parse_xml">
<a class="viewcode-back" href="../../../bioat.lib.html#bioat.lib.libjgi.JGIOperator.parse_xml">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">parse_xml</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Moves through the xml document &lt;xml_file&gt; and returns information</span>
<span class="sd">        about matches to elements in &lt;DESIRED_CATEGORIES&gt; if</span>
<span class="sd">        &lt;filter_categories&gt; is True, or all files otherwise</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">lm</span><span class="o">.</span><span class="n">set_names</span><span class="p">(</span><span class="n">func_name</span><span class="o">=</span><span class="s2">&quot;parse_xml&quot;</span><span class="p">)</span>
        <span class="n">lm</span><span class="o">.</span><span class="n">set_level</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log_level</span><span class="p">)</span>

        <span class="c1"># Parse xml file for content to download</span>

        <span class="n">xml_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">FILENAME_TEMPLATE_XML</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">query_info</span><span class="p">)</span>

        <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;start to parse_xml using parameter filter_categories = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">filter_files</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="n">display_cats</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;filename&quot;</span><span class="p">,</span>
            <span class="s2">&quot;url&quot;</span><span class="p">,</span>
            <span class="s2">&quot;size&quot;</span><span class="p">,</span>
            <span class="s2">&quot;label&quot;</span><span class="p">,</span>
            <span class="s2">&quot;sizeInBytes&quot;</span><span class="p">,</span>
            <span class="s2">&quot;timestamp&quot;</span><span class="p">,</span>
            <span class="s2">&quot;md5&quot;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="c1"># Choose between different XML parsers</span>
        <span class="c1"># Will only be used if --filter_files flag</span>
        <span class="c1"># if filter_files, user wants only those files in &lt;_desired_categories&gt;</span>
        <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;_xml_hunt...&quot;</span><span class="p">)</span>
        <span class="n">found</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_xml_hunt</span><span class="p">(</span><span class="n">xml_file</span><span class="p">)</span>
        <span class="n">found</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format_found</span><span class="p">(</span><span class="n">found</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter_files</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">list</span><span class="p">(</span><span class="n">found</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;successfully parsed xml @ </span><span class="si">{</span><span class="n">xml_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;start to update file_list&quot;</span><span class="p">)</span>

        <span class="n">category_id</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">for</span> <span class="n">category</span><span class="p">,</span> <span class="n">sub_cat</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">found</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="k">if</span> <span class="n">category</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_desired_categories</span><span class="p">:</span>
                <span class="n">category_id</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_desired_categories</span><span class="p">[</span><span class="n">category</span><span class="p">]</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_desired_categories</span><span class="p">[</span><span class="n">category</span><span class="p">][</span><span class="s2">&quot;catID&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">category_id</span>
            <span class="n">uid</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">for</span> <span class="n">parent</span><span class="p">,</span> <span class="n">children</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">sub_cat</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_desired_categories</span><span class="p">[</span><span class="n">category</span><span class="p">][</span><span class="s2">&quot;results&quot;</span><span class="p">][</span><span class="n">parent</span><span class="p">]</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span>
                    <span class="nb">dict</span>
                <span class="p">)</span>
                <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_desired_categories</span><span class="p">[</span><span class="n">category</span><span class="p">][</span><span class="s2">&quot;results&quot;</span><span class="p">][</span><span class="n">parent</span><span class="p">]</span>
                <span class="n">unique_children</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_uniqueify</span><span class="p">(</span><span class="n">children</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">unique_children</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;filename&quot;</span><span class="p">]):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">results</span><span class="p">[</span><span class="n">uid</span><span class="p">]</span>
                    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                        <span class="n">results</span><span class="p">[</span><span class="n">uid</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="k">for</span> <span class="n">dc</span> <span class="ow">in</span> <span class="n">display_cats</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">results</span><span class="p">[</span><span class="n">uid</span><span class="p">][</span><span class="n">dc</span><span class="p">]</span> <span class="o">=</span> <span class="n">child</span><span class="p">[</span><span class="n">dc</span><span class="p">]</span>
                        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                            <span class="k">continue</span>
                    <span class="n">uid</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;successfully update self._desired_categories = </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_desired_categories</span><span class="p">)[:</span><span class="mi">400</span><span class="p">]</span><span class="si">}</span><span class="s2">...(omit)...&quot;</span>
        <span class="p">)</span>

        <span class="c1"># Check if file has any categories of interest</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="s2">&quot;results&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_desired_categories</span><span class="o">.</span><span class="n">values</span><span class="p">())):</span>
            <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s2">&quot;no results found for &#39;</span><span class="si">{}</span><span class="s2">&#39; in any of the following &quot;</span>
                <span class="s2">&quot;categories:</span><span class="se">\n</span><span class="s2">---</span><span class="se">\n</span><span class="si">{}</span><span class="se">\n</span><span class="s2">---&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">query_info</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;categories&quot;</span><span class="p">])</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_clean_exit</span><span class="p">(</span>
                <span class="n">exit_message</span><span class="o">=</span><span class="s2">&quot;exit with error&quot;</span><span class="p">,</span>
                <span class="n">exit_code</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                <span class="n">rm_cookie</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">rm_xml</span><span class="o">=</span><span class="kc">False</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml</span> <span class="k">else</span> <span class="kc">False</span><span class="p">,</span>
            <span class="p">)</span></div>


    <span class="c1"># step 06 download from url</span>
<div class="viewcode-block" id="JGIOperator.download">
<a class="viewcode-back" href="../../../bioat.lib.html#bioat.lib.libjgi.JGIOperator.download">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">download</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">lm</span><span class="o">.</span><span class="n">set_names</span><span class="p">(</span><span class="n">func_name</span><span class="o">=</span><span class="s2">&quot;download&quot;</span><span class="p">)</span>
        <span class="n">lm</span><span class="o">.</span><span class="n">set_level</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log_level</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_decision_tree</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_urls_to_get</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_urls_to_get</span><span class="p">)</span>
        <span class="n">filenames</span> <span class="o">=</span> <span class="p">[</span><span class="n">u</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_urls_to_get</span><span class="p">]</span>

        <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;self._desired_categories = </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_desired_categories</span><span class="p">)[:</span><span class="mi">400</span><span class="p">]</span><span class="si">}</span><span class="s2">...(omit)...&quot;</span>
        <span class="p">)</span>
        <span class="n">file_sizes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_sizes</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_desired_categories</span><span class="p">,</span> <span class="n">sizes_by_url</span><span class="o">=</span><span class="p">{})</span>
        <span class="c1"># lm.logger.debug(f&#39;file_sizes = {file_sizes}&#39;)</span>
        <span class="n">total_size</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="p">[</span><span class="n">file_sizes</span><span class="p">[</span><span class="n">url</span><span class="p">]</span> <span class="k">for</span> <span class="n">url</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_urls_to_get</span><span class="p">]))</span>
        <span class="n">size_string</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_byte_convert</span><span class="p">(</span><span class="n">total_size</span><span class="p">)</span>
        <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Total download size for </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_urls_to_get</span><span class="p">)</span><span class="si">}</span><span class="s2"> files: </span><span class="si">{</span><span class="n">size_string</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">interactive</span><span class="p">:</span>
            <span class="n">select</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span>
                <span class="s2">&quot;Continue? (y/n/b/p for yes/no/back/preview files): &quot;</span>
            <span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">select</span> <span class="o">==</span> <span class="s2">&quot;p&quot;</span><span class="p">:</span>
                <span class="k">while</span> <span class="n">select</span> <span class="o">==</span> <span class="s2">&quot;p&quot;</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">filenames</span><span class="p">))</span>
                    <span class="n">select</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span>
                        <span class="s2">&quot;Continue? (y/n/b/p for yes/no/back/preview files): &quot;</span>
                    <span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">select</span> <span class="o">==</span> <span class="s2">&quot;n&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_clean_exit</span><span class="p">(</span>
                    <span class="n">exit_message</span><span class="o">=</span><span class="s2">&quot;ABORTING DOWNLOAD&quot;</span><span class="p">,</span>
                    <span class="n">exit_code</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                    <span class="n">rm_cookie</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">rm_xml</span><span class="o">=</span><span class="kc">False</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml</span> <span class="k">else</span> <span class="kc">False</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="n">select</span> <span class="o">==</span> <span class="s2">&quot;b&quot;</span><span class="p">:</span>
                <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;back to select files...&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">interactive</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;!!! re-call self.download position1&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">download</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">select</span> <span class="o">==</span> <span class="s2">&quot;y&quot;</span> <span class="ow">or</span> <span class="n">select</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_failed_urls</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_download_list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_urls_to_get</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;illegal selection, back to select files...&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">interactive</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;!!! re-call self.download position2&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">download</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># non interactive</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">regex</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_get</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_fails</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_failed_urls</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_download_list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_urls_to_get</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">BioatInvalidOptionError</span>

        <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;Finished downloading </span><span class="si">{}</span><span class="s2"> files.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_downloaded_files</span><span class="p">))</span>
        <span class="p">)</span>

        <span class="n">failed_happen</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">interactive</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_failed_urls</span><span class="p">:</span>
                <span class="n">n_broken</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_failed_urls</span><span class="p">)</span>
                <span class="n">nretry_broken</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span>
                    <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> files failed to download; nretry them? (y/n): &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n_broken</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">nretry_broken</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;yes&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_failed_urls</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_download_list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_failed_urls</span><span class="p">)</span>
            <span class="c1"># Kindly offer to unpack files, if files remain after error check</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_downloaded_files</span><span class="p">:</span>
                <span class="n">decompress</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span>
                    <span class="p">(</span>
                        <span class="s2">&quot;Decompress all downloaded files? &quot;</span>
                        <span class="s2">&quot;(y/n/k, k=decompress and keep original): &quot;</span>
                    <span class="p">)</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">decompress</span> <span class="o">!=</span> <span class="s2">&quot;n&quot;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">decompress</span> <span class="o">==</span> <span class="s2">&quot;k&quot;</span><span class="p">:</span>
                        <span class="n">keep_original</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">keep_original</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_decompress_files</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_downloaded_files</span><span class="p">,</span> <span class="n">keep_original</span><span class="p">)</span>
                    <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Finished decompressing all files.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># non-interactive</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_failed_urls</span><span class="p">:</span>
                <span class="c1"># Write failed URLs to a local log file.</span>
                <span class="n">fail_log_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">FILENAME_TEMPLATE_LOG_FAIL</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">query_info</span>
                <span class="p">)</span>
                <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_failed_urls</span><span class="p">)</span><span class="si">}</span><span class="s2"> failed downloads record into </span><span class="si">{</span><span class="n">fail_log_file</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
                <span class="c1"># write failed URLs to local file</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fail_log_file</span><span class="p">,</span> <span class="s2">&quot;wt&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_failed_urls</span><span class="p">))</span>
                <span class="n">failed_happen</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">failed_happen</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># Clean up and exit</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">interactive</span><span class="p">:</span>
            <span class="c1"># interactive</span>
            <span class="n">keep_temp</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Keep temporary files (&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">FILENAME_TEMPLATE_XML</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">query_info</span><span class="p">)</span><span class="si">}</span><span class="s2">&#39; &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;and &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">FILENAME_COOKIE</span><span class="si">}</span><span class="s2">&#39;)? (y/n): &quot;</span>
            <span class="p">)</span>
            <span class="n">exit_message</span> <span class="o">=</span> <span class="s2">&quot;User choose to exit&quot;</span>
            <span class="k">if</span> <span class="n">keep_temp</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="s2">&quot;y, yes&quot;</span><span class="p">:</span>
                <span class="n">rm_cookie</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">rm_xml</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">rm_cookie</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">rm_xml</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># non-interactive</span>
            <span class="n">rm_xml</span> <span class="o">=</span> <span class="kc">False</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml</span> <span class="k">else</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">failed_happen</span><span class="p">:</span>  <span class="c1"># failed files in non-interactive mode</span>
                <span class="n">exit_message</span> <span class="o">=</span> <span class="s2">&quot;Some files failed downloading&quot;</span>
                <span class="n">rm_cookie</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">exit_message</span> <span class="o">=</span> <span class="s2">&quot;Exit.&quot;</span>
                <span class="n">rm_cookie</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="n">exit_code</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">failed_happen</span> <span class="k">else</span> <span class="mi">0</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_clean_exit</span><span class="p">(</span>
            <span class="n">exit_message</span><span class="o">=</span><span class="n">exit_message</span><span class="p">,</span>
            <span class="n">exit_code</span><span class="o">=</span><span class="n">exit_code</span><span class="p">,</span>
            <span class="n">rm_cookie</span><span class="o">=</span><span class="n">rm_cookie</span><span class="p">,</span>
            <span class="n">rm_xml</span><span class="o">=</span><span class="n">rm_xml</span><span class="p">,</span>
        <span class="p">)</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_byte_convert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">byte_size</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Converts a number of bytes to a more human-readable</span>
<span class="sd">        format.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Calculate and display total size of selected data</span>
        <span class="n">adjusted</span> <span class="o">=</span> <span class="n">byte_size</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">)</span>  <span class="c1"># bytes to MB</span>
        <span class="k">if</span> <span class="n">adjusted</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">adjusted</span> <span class="o">=</span> <span class="n">byte_size</span> <span class="o">/</span> <span class="mi">1024</span>
            <span class="n">unit</span> <span class="o">=</span> <span class="s2">&quot;KB&quot;</span>
        <span class="k">elif</span> <span class="n">adjusted</span> <span class="o">&lt;</span> <span class="mi">1024</span><span class="p">:</span>
            <span class="n">unit</span> <span class="o">=</span> <span class="s2">&quot;MB&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">adjusted</span> <span class="o">/=</span> <span class="mi">1024</span>
            <span class="n">unit</span> <span class="o">=</span> <span class="s2">&quot;GB&quot;</span>
        <span class="n">size_string</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{:.2f}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">adjusted</span><span class="p">,</span> <span class="n">unit</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">size_string</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_clean_exit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exit_message</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">exit_code</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">rm_cookie</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">rm_xml</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Perform a sys.exit() while removing temporary files and</span>
<span class="sd">        informing the user.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">lm</span><span class="o">.</span><span class="n">set_names</span><span class="p">(</span><span class="n">func_name</span><span class="o">=</span><span class="s2">&quot;_clean_exit&quot;</span><span class="p">)</span>
        <span class="n">lm</span><span class="o">.</span><span class="n">set_level</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log_level</span><span class="p">)</span>

        <span class="n">to_remove</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="n">rm_xml</span><span class="p">:</span>
            <span class="n">xml_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">FILENAME_TEMPLATE_XML</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">query_info</span><span class="p">)</span>
            <span class="n">to_remove</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">xml_file</span><span class="p">)</span>
            <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Removing xml @ </span><span class="si">{</span><span class="n">xml_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">rm_cookie</span><span class="p">:</span>
            <span class="n">to_remove</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">FILENAME_COOKIE</span><span class="p">)</span>
            <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Removing cookie @ </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">FILENAME_COOKIE</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">to_remove</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                <span class="k">continue</span>

        <span class="k">if</span> <span class="n">exit_message</span><span class="p">:</span>
            <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">exit_message</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="n">exit_code</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_check_for_xml</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Uses hex code at the beginning of a file to try to determine if it&#39;s an</span>
<span class="sd">        XML file or not. This seems to be occasionally necessary; if pulling</span>
<span class="sd">        files from JGI tape archives, the server may error out and provide an</span>
<span class="sd">        XML error document instead of the intended file. This function should</span>
<span class="sd">        return False on all downloaded files, although false positives have not</span>
<span class="sd">        been thoroughly investigated.</span>

<span class="sd">        Adapted from http://stackoverflow.com/a/13044946/3076552</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">lm</span><span class="o">.</span><span class="n">set_names</span><span class="p">(</span><span class="n">func_name</span><span class="o">=</span><span class="s2">&quot;_check_for_xml&quot;</span><span class="p">)</span>
        <span class="n">lm</span><span class="o">.</span><span class="n">set_level</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log_level</span><span class="p">)</span>

        <span class="n">xml_hex</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\x3c</span><span class="s2">&quot;</span>  <span class="c1"># hex code at beginning of XML file</span>
        <span class="n">read_length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">xml_hex</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">file_start</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">read_length</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">file_start</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">xml_hex</span><span class="p">):</span>  <span class="c1"># XML file</span>
                    <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;cheker for xml: XML file&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="kc">True</span>
                <span class="k">else</span><span class="p">:</span>  <span class="c1"># hopefully all other file types</span>
                    <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;cheker for xml: hopefully all other file types&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="kc">False</span>
            <span class="k">except</span> <span class="ne">UnicodeDecodeError</span><span class="p">:</span>  <span class="c1"># compressed file</span>
                <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;cheker for xml: compressed file&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_check_md5</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">md5_hash</span><span class="p">):</span>
        <span class="n">lm</span><span class="o">.</span><span class="n">set_names</span><span class="p">(</span><span class="n">func_name</span><span class="o">=</span><span class="s2">&quot;_check_md5&quot;</span><span class="p">)</span>
        <span class="n">lm</span><span class="o">.</span><span class="n">set_level</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log_level</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">md5_hash</span><span class="p">:</span>
            <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No MD5 hash listed for </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">; skipping check&quot;</span><span class="p">)</span>
            <span class="n">ret_val</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">file_md5</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_md5</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">file_md5</span> <span class="o">==</span> <span class="n">md5_hash</span><span class="p">:</span>
                <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;MD5 hashes match for </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">md5_hash</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
                <span class="n">ret_val</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;MD5 hash mismatch for </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2"> (local: </span><span class="si">{</span><span class="n">file_md5</span><span class="si">}</span><span class="s2">, remote: </span><span class="si">{</span><span class="n">md5_hash</span><span class="si">}</span><span class="s2">)&quot;</span>
                <span class="p">)</span>
                <span class="n">ret_val</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="n">ret_val</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_check_sizeInBytes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">sizeInBytes</span><span class="p">):</span>
        <span class="n">lm</span><span class="o">.</span><span class="n">set_names</span><span class="p">(</span><span class="n">func_name</span><span class="o">=</span><span class="s2">&quot;_check_sizeInBytes&quot;</span><span class="p">)</span>
        <span class="n">lm</span><span class="o">.</span><span class="n">set_level</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log_level</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">sizeInBytes</span><span class="p">:</span>
            <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No sizeInBytes listed for </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">; skipping check&quot;</span><span class="p">)</span>
            <span class="n">ret_val</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">file_size_in_bytes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_sizeInBytes</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">file_size_in_bytes</span> <span class="o">==</span> <span class="n">sizeInBytes</span><span class="p">:</span>
                <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;sizeInBytes match for </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">sizeInBytes</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
                <span class="n">ret_val</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;sizeInBytes mismatch for </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2"> (local: </span><span class="si">{</span><span class="n">file_size_in_bytes</span><span class="si">}</span><span class="s2">, remote: </span><span class="si">{</span><span class="n">sizeInBytes</span><span class="si">}</span><span class="s2">)&quot;</span>
                <span class="p">)</span>
                <span class="n">ret_val</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="n">ret_val</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_decision_tree</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">lm</span><span class="o">.</span><span class="n">set_names</span><span class="p">(</span><span class="n">func_name</span><span class="o">=</span><span class="s2">&quot;_decision_tree&quot;</span><span class="p">)</span>
        <span class="n">lm</span><span class="o">.</span><span class="n">set_level</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log_level</span><span class="p">)</span>

        <span class="c1"># Decision tree depending on if non-interactive options given</span>
        <span class="n">regex_filter</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">user_choice</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interactive</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_get</span><span class="p">:</span>  <span class="c1"># 参数指定get all</span>
            <span class="c1"># non-interactive</span>
            <span class="n">user_choice</span> <span class="o">=</span> <span class="s2">&quot;a&quot;</span>  <span class="c1"># &quot;all_get mode&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">interactive</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">regex</span><span class="p">:</span>  <span class="c1"># 参数指定regex</span>
            <span class="c1"># non-interactive</span>
            <span class="n">user_choice</span> <span class="o">=</span> <span class="s2">&quot;r&quot;</span>  <span class="c1"># &quot;regex mode&quot;</span>
            <span class="n">regex_filter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">regex</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">interactive</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="c1"># non-interactive</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_fails</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># 参数指定</span>
            <span class="n">user_choice</span> <span class="o">=</span> <span class="s2">&quot;l&quot;</span>  <span class="c1"># &quot;re-download log_fails mode&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">interactive</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;regex_filter = </span><span class="si">{</span><span class="n">regex_filter</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;user_choice = </span><span class="si">{</span><span class="n">user_choice</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;interactive_and_display_info = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">interactive</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;QUERY RESULTS FOR &#39;</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_desired_categories</span><span class="p">)[:</span><span class="mi">400</span><span class="p">]</span><span class="si">}</span><span class="s2">...(omit)...&#39;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="p">)</span>

        <span class="k">for</span> <span class="n">query_cat</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span>
                <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_desired_categories</span><span class="o">.</span><span class="n">items</span><span class="p">()),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">k_v</span><span class="p">:</span> <span class="n">k_v</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;catID&quot;</span><span class="p">]</span>
        <span class="p">):</span>
            <span class="n">print_list</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">v</span><span class="p">[</span><span class="s2">&quot;results&quot;</span><span class="p">]:</span>
                <span class="k">continue</span>

            <span class="n">catID</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="s2">&quot;catID&quot;</span><span class="p">]</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_dict_to_get</span><span class="p">[</span><span class="n">catID</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">print_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="n">catID</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">query_cat</span><span class="si">}</span><span class="s2"> &quot;</span><span class="o">.</span><span class="n">center</span><span class="p">(</span><span class="mi">80</span><span class="p">,</span> <span class="s2">&quot;=&quot;</span><span class="p">))</span>
            <span class="n">results</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="s2">&quot;results&quot;</span><span class="p">]</span>

            <span class="k">for</span> <span class="n">sub_cat</span><span class="p">,</span> <span class="n">items</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span>
                    <span class="nb">iter</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">items</span><span class="p">()),</span>
                    <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">sub_cat_items</span><span class="p">:</span> <span class="p">(</span><span class="n">sub_cat_items</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">sub_cat_items</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
            <span class="p">):</span>
                <span class="n">print_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">:&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sub_cat</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">items</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
                    <span class="n">url</span> <span class="o">=</span> <span class="n">i</span><span class="p">[</span><span class="s2">&quot;url&quot;</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_dict_to_get</span><span class="p">[</span><span class="n">catID</span><span class="p">][</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">url</span>
                    <span class="k">if</span> <span class="s2">&quot;md5&quot;</span> <span class="ow">in</span> <span class="n">i</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_url_to_validate</span><span class="p">[</span><span class="n">url</span><span class="p">][</span><span class="s2">&quot;md5&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span><span class="p">[</span><span class="s2">&quot;md5&quot;</span><span class="p">]</span>
                    <span class="c1"># the following elif takes care of MD5 &gt; sizeInBytes rank-order</span>
                    <span class="c1"># in downstream processing</span>
                    <span class="k">if</span> <span class="s2">&quot;sizeInBytes&quot;</span> <span class="ow">in</span> <span class="n">i</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_url_to_validate</span><span class="p">[</span><span class="n">url</span><span class="p">][</span><span class="s2">&quot;sizeInBytes&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span>
                            <span class="n">i</span><span class="p">[</span><span class="s2">&quot;sizeInBytes&quot;</span><span class="p">]</span>
                        <span class="p">)</span>
                    <span class="n">print_index</span> <span class="o">=</span> <span class="s2">&quot; </span><span class="si">{}</span><span class="s2">:[</span><span class="si">{}</span><span class="s2">] &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">catID</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">index</span><span class="p">))</span>
                    <span class="n">date</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format_timestamp</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="s2">&quot;timestamp&quot;</span><span class="p">])</span>
                    <span class="n">date_string</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{:02d}</span><span class="s2">/</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">date</span><span class="o">.</span><span class="n">tm_mon</span><span class="p">,</span> <span class="n">date</span><span class="o">.</span><span class="n">tm_year</span><span class="p">)</span>
                    <span class="n">size_date</span> <span class="o">=</span> <span class="s2">&quot;[</span><span class="si">{}</span><span class="s2">|</span><span class="si">{}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="s2">&quot;size&quot;</span><span class="p">],</span> <span class="n">date_string</span><span class="p">)</span>
                    <span class="n">filename</span> <span class="o">=</span> <span class="n">i</span><span class="p">[</span><span class="s2">&quot;filename&quot;</span><span class="p">]</span>
                    <span class="n">margin</span> <span class="o">=</span> <span class="mi">80</span> <span class="o">-</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">size_date</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">print_index</span><span class="p">))</span>
                    <span class="n">file_info</span> <span class="o">=</span> <span class="n">filename</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="n">margin</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">)</span>
                    <span class="n">print_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">print_index</span><span class="p">,</span> <span class="n">file_info</span><span class="p">,</span> <span class="n">size_date</span><span class="p">]))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">interactive</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">print_list</span><span class="p">))</span>
                <span class="nb">print</span><span class="p">()</span>  <span class="c1"># padding</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">user_choice</span><span class="p">:</span>
            <span class="c1"># Ask user which files to download from xml</span>
            <span class="n">user_choice</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_user_choice</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">user_choice</span> <span class="o">==</span> <span class="s2">&quot;r&quot;</span><span class="p">:</span>  <span class="c1"># regex-based filename matching</span>
            <span class="n">regex_filter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_regex</span><span class="p">()</span>
        <span class="c1"># special case for downloading all available files</span>
        <span class="c1"># or filtering with a regular expression</span>
        <span class="k">if</span> <span class="n">user_choice</span> <span class="ow">in</span> <span class="p">(</span>  <span class="c1"># non interactive</span>
                <span class="s2">&quot;a&quot;</span><span class="p">,</span>  <span class="c1"># all_get mode</span>
                <span class="s2">&quot;r&quot;</span><span class="p">,</span>  <span class="c1"># regex mode</span>
                <span class="s2">&quot;l&quot;</span><span class="p">,</span>  <span class="c1"># re-download log_fails mode</span>
        <span class="p">):</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dict_to_get</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
                <span class="k">for</span> <span class="n">url</span> <span class="ow">in</span> <span class="n">v</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                    <span class="c1"># lm.logger.debug(f&#39;deal with v.values() = {str(v.values())[:200]}...(omit)...&#39;)</span>
                    <span class="k">if</span> <span class="n">regex_filter</span><span class="p">:</span>
                        <span class="c1"># fn = re.search(r&quot;.+/([^\/]+$)&quot;, u).group(1)</span>
                        <span class="n">fn</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;.+/([^/]+$)&quot;</span><span class="p">,</span> <span class="n">url</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                        <span class="n">match</span> <span class="o">=</span> <span class="n">regex_filter</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">match</span><span class="p">:</span>
                            <span class="c1"># 匹配失败</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_urls_to_get</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_urls_to_get</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_urls_to_get</span><span class="o">.</span><span class="n">discard</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
                            <span class="k">continue</span>  <span class="c1"># 进入下一个文件进行判断</span>
                    <span class="k">elif</span> <span class="n">user_choice</span> <span class="o">==</span> <span class="s2">&quot;l&quot;</span> <span class="ow">and</span> <span class="n">url</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_log_fails_loaded</span><span class="p">:</span>
                        <span class="k">continue</span>  <span class="c1"># 无需添加此文件，进入下一个文件进行判断</span>
                    <span class="c1"># final add to download</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_urls_to_get</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_urls_to_get</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_urls_to_get</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>  <span class="c1"># self._urls_to_get is a set()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># interactive</span>
            <span class="c1"># 选2:3-5这种</span>
            <span class="c1"># Retrieve user-selected file urls from dict</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_parse_selection</span><span class="p">(</span><span class="n">user_choice</span><span class="p">)</span>  <span class="c1"># update self._selections</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_selections</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">v</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_urls_to_get</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dict_to_get</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>

        <span class="c1"># lm.logger.debug(&#39;update self._dict_to_get, self._url_to_validate&#39;)</span>
        <span class="c1"># lm.logger.debug(f&#39;self._urls_to_get = {str(self._urls_to_get)[:1000]}...(omit)...&#39;)</span>
        <span class="c1"># lm.logger.debug(f&#39;self._dict_to_get = {str(self._dict_to_get)[:1000]}...(omit)...&#39;)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_decompress_files</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">local_file_list</span><span class="p">,</span> <span class="n">keep_original</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Decompresses list of files, and deletes compressed</span>
<span class="sd">        copies unless &lt;keep_original&gt; is True.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">lm</span><span class="o">.</span><span class="n">set_names</span><span class="p">(</span><span class="n">func_name</span><span class="o">=</span><span class="s2">&quot;_decompress_files&quot;</span><span class="p">)</span>
        <span class="n">lm</span><span class="o">.</span><span class="n">set_level</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log_level</span><span class="p">)</span>

        <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;decompress_files...&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">local_file_list</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_extract_file</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">keep_original</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_download_from_url</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Attempts to download a file from JGI servers using cURL.</span>

<span class="sd">        Returns a tuple of (filename, cURL command used, success boolean)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">lm</span><span class="o">.</span><span class="n">set_names</span><span class="p">(</span><span class="n">func_name</span><span class="o">=</span><span class="s2">&quot;_download_from_url&quot;</span><span class="p">)</span>
        <span class="n">lm</span><span class="o">.</span><span class="n">set_level</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log_level</span><span class="p">)</span>

        <span class="n">url_no_prefix</span> <span class="o">=</span> <span class="n">url</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&amp;amp;&quot;</span><span class="p">,</span> <span class="s2">&quot;&amp;&quot;</span><span class="p">)</span>  <span class="c1"># for query local xml info</span>

        <span class="c1"># get md5 value for this file from xml</span>
        <span class="c1"># lm.logger.debug(f&#39;self._url_to_validate = {self._url_to_validate}&#39;)</span>
        <span class="n">md5_hash</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_url_to_validate</span><span class="p">[</span><span class="n">url_no_prefix</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;md5&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>  <span class="c1"># local xml</span>
        <span class="c1"># get sizeInBytes (local xml) and file_size (internet) for size checking</span>
        <span class="n">sizeInBytes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_url_to_validate</span><span class="p">[</span><span class="n">url_no_prefix</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s2">&quot;sizeInBytes&quot;</span><span class="p">,</span> <span class="kc">None</span>
        <span class="p">)</span>  <span class="c1"># local xml</span>
        <span class="c1"># counter</span>
        <span class="n">error_counter</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># download status</span>
        <span class="n">loop</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">success</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># filename to write in, parse from last of url</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s2">&quot;.+/(.+$)&quot;</span><span class="p">,</span> <span class="n">url</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>  <span class="c1"># pass when loop == False</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">loop</span><span class="p">:</span>
                <span class="k">break</span>

            <span class="k">if</span> <span class="n">error_counter</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nretry</span><span class="p">:</span>
                <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;error_counter is reaching to max size -&gt; self.nretry = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">nretry</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
                <span class="c1"># FUTURE, 支持了断点续传再改回来</span>
                <span class="c1"># lm.logger.warning(</span>
                <span class="c1">#     &#39;you can rerun your command and the unfinished file is needed for continuing download&#39;)</span>
                <span class="n">success</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">loop</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">continue</span>

            <span class="c1"># temp_stemp_sizeize = 0  # 获取已写入的字节 temp_size</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>  <span class="c1"># filename exists</span>
                <span class="c1"># check md5 for filename</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_broken</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">md5_hash</span><span class="o">=</span><span class="n">md5_hash</span><span class="p">,</span> <span class="n">sizeInBytes</span><span class="o">=</span><span class="n">sizeInBytes</span><span class="p">):</span>
                    <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;File </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2"> exists and passed md5 checking. Go on next task.&quot;</span>
                    <span class="p">)</span>
                    <span class="n">success</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">loop</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">continue</span>
                <span class="k">else</span><span class="p">:</span>  <span class="c1"># failed</span>
                    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span>
                            <span class="n">filename</span> <span class="o">+</span> <span class="s2">&quot;.tmp&quot;</span>
                    <span class="p">):</span>  <span class="c1"># filename.tmp exists at the sametime!</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_broken</span><span class="p">(</span>
                                <span class="n">filename</span> <span class="o">+</span> <span class="s2">&quot;.tmp&quot;</span><span class="p">,</span>
                                <span class="n">md5_hash</span><span class="o">=</span><span class="n">md5_hash</span><span class="p">,</span>
                                <span class="n">sizeInBytes</span><span class="o">=</span><span class="n">sizeInBytes</span><span class="p">,</span>
                        <span class="p">):</span>
                            <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                                <span class="sa">f</span><span class="s2">&quot;File </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">.tmp passed md5 checking! Renaming&quot;</span>
                            <span class="p">)</span>
                            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
                            <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">filename</span> <span class="o">+</span> <span class="s2">&quot;.tmp&quot;</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
                            <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                                <span class="sa">f</span><span class="s2">&quot;File </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2"> exists and passed md5 checking. Go on next task.&quot;</span>
                            <span class="p">)</span>
                            <span class="n">success</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="n">loop</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="k">continue</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="c1"># FUTURE: 由于JGI不支持断点续传，这个代码以后再用</span>
                            <span class="c1"># lm.logger.error(f&#39;File {filename} exists but is broken, file {filename}.tmp exists but is &#39;</span>
                            <span class="c1">#              f&#39;broken too. File {filename} is removed now.&#39;)</span>
                            <span class="c1"># os.remove(filename)</span>
                            <span class="c1"># temp_size = os.path.getsize(filename + &#39;.tmp&#39;)</span>
                            <span class="c1"># lm.logger.info(f&#39;Try continuing download using {filename}.tmp. temp_size = {temp_size}&#39;)</span>
                            <span class="c1"># /FUTURE: 由于JGI不支持断点续传，这个代码以后再用</span>
                            <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                                <span class="sa">f</span><span class="s2">&quot;File </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2"> exists but is broken, file </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">.tmp exists but is &quot;</span>
                                <span class="sa">f</span><span class="s2">&quot;broken too.&quot;</span>
                            <span class="p">)</span>
                            <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                                <span class="s2">&quot;Because JGI does not support continuing download now, the two files will be removed&quot;</span>
                            <span class="p">)</span>
                            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
                            <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;File </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2"> is removed now.&quot;</span><span class="p">)</span>
                            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">filename</span> <span class="o">+</span> <span class="s2">&quot;.tmp&quot;</span><span class="p">)</span>
                            <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;File </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">.tmp is removed now.&quot;</span><span class="p">)</span>
                            <span class="n">success</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="n">loop</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="k">continue</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;File </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2"> exists but is broken, file </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">.tmp does not exists.&quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;File </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2"> is removed now.&quot;</span>
                        <span class="p">)</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
                        <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Try to start a new download task.&quot;</span><span class="p">)</span>
                        <span class="n">success</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="n">loop</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">continue</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># filename don&#39;t exist</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">filename</span> <span class="o">+</span> <span class="s2">&quot;.tmp&quot;</span><span class="p">):</span>  <span class="c1"># filename.tmp exists</span>
                    <span class="c1"># 如果.tmp文件已存在，则打开文件并获取已写入的字节 temp_size</span>
                    <span class="c1"># print(f&#39;found tmp file for {filename}, attempt to continuing download&#39;)</span>
                    <span class="c1"># temp_size = os.path.getsize(filename + &#39;.tmp&#39;)</span>

                    <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="s2">&quot;Because JGI does not support continuing download now, the tmp file will be removed&quot;</span>
                    <span class="p">)</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">filename</span> <span class="o">+</span> <span class="s2">&quot;.tmp&quot;</span><span class="p">)</span>
                    <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;File </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">.tmp is removed now.&quot;</span><span class="p">)</span>
            <span class="c1"># set requests</span>
            <span class="c1"># https://dabing1022.github.io/2016/12/24/%E8%81%8A%E4%B8%80%E8%81%8AHTTP%E7%9A%84Range,%20Content-Range/</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">url</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;http&quot;</span><span class="p">):</span>
                <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">URL_JGI_MAIN</span><span class="si">}{</span><span class="n">url</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;download aim file from url = </span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">cookie_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">FILENAME_COOKIE</span>
            <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;User-Agent&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_user_agent</span><span class="p">}</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">cookie_file</span><span class="p">,</span> <span class="s2">&quot;rt&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">cookies_dict</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
            <span class="n">cookies</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">cookiejar_from_dict</span><span class="p">(</span><span class="n">cookies_dict</span><span class="p">)</span>

            <span class="c1"># 想在Python中在不下载文件的情况下获取文件大小，可以使用requests库发送HEAD请求</span>
            <span class="c1"># HEAD请求不会下载文件，而是仅获取关于文件的一些元数据，如文件大小</span>
            <span class="k">with</span> <span class="n">requests</span><span class="o">.</span><span class="n">head</span><span class="p">(</span>
                    <span class="n">url</span><span class="p">,</span>
                    <span class="n">cookies</span><span class="o">=</span><span class="n">cookies</span><span class="p">,</span>
                    <span class="n">stream</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span>
                    <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">,</span>
                    <span class="n">proxies</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_proxies</span><span class="p">,</span>
            <span class="p">)</span> <span class="k">as</span> <span class="n">pre_response</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_proxies</span><span class="p">:</span>
                    <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;requests.head using IP: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_proxy_ip</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="c1"># check response status</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">pre_response</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>  <span class="c1"># 如果响应的状态码不是200，将引发HTTPError异常</span>
                <span class="k">except</span> <span class="n">HTTPError</span><span class="p">:</span>
                    <span class="n">error_counter</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="s2">&quot;encounter HTTPError;&quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;error_counter = </span><span class="si">{</span><span class="n">error_counter</span><span class="si">}</span><span class="s2">; pre_response.status_code = </span><span class="si">{</span><span class="n">pre_response</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s2">; &quot;</span>
                        <span class="s2">&quot;could not connect with server. Retry after 5s...&quot;</span>
                    <span class="p">)</span>
                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
                    <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;start next loop&quot;</span><span class="p">)</span>
                    <span class="n">loop</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">continue</span>  <span class="c1"># next try</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">error_counter</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;encounter </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2"> (error);&quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;error_counter = </span><span class="si">{</span><span class="n">error_counter</span><span class="si">}</span><span class="s2">; pre_response.status_code = </span><span class="si">{</span><span class="n">pre_response</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s2">; &quot;</span>
                        <span class="s2">&quot;unexpected error. Retry after 5s...&quot;</span>
                    <span class="p">)</span>
                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
                    <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;start next loop&quot;</span><span class="p">)</span>
                    <span class="n">success</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">loop</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">continue</span>  <span class="c1"># next try</span>

                <span class="c1"># get file size, if pre_response.header do not have it, replace it from sizeInBytes in xml file</span>
                <span class="n">remote_file_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">pre_response</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Content-Length&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
                <span class="n">remote_file_size</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">remote_file_size</span> <span class="k">if</span> <span class="n">remote_file_size</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">sizeInBytes</span>
                <span class="p">)</span>
                <span class="c1"># FUTURE: 由于JGI不支持断点续传，这个代码以后再用</span>
                <span class="c1"># if temp_size &gt; remote_file_size:</span>
                <span class="c1">#     # error</span>
                <span class="c1">#     lm.logger.error(&#39;local size = {temp_size} &gt; remote_file_size = {remote_file_size}, nretry...&#39;)</span>
                <span class="c1">#     error_counter += 1</span>
                <span class="c1">#     os.remove(filename + &#39;.tmp&#39;)</span>
                <span class="c1">#     success = False</span>
                <span class="c1">#     loop = True</span>
                <span class="c1">#     continue</span>

            <span class="c1"># core part for download</span>
            <span class="c1"># re-request use fixed headers</span>
            <span class="c1"># https://cizixs.com/2015/10/06/http-resume-download/</span>
            <span class="c1"># headers[&quot;Range&quot;] = f&quot;bytes={temp_size}-&quot;</span>
            <span class="c1"># /FUTURE: 由于JGI不支持断点续传，这个代码以后再用</span>
            <span class="k">with</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                    <span class="n">url</span><span class="p">,</span>
                    <span class="n">cookies</span><span class="o">=</span><span class="n">cookies</span><span class="p">,</span>
                    <span class="n">stream</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="c1"># 如果要下载大文件的话，就将steam设置为True，慢慢下载，而不是等整个文件下载完才返回。</span>
                    <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span>
                    <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">,</span>
                    <span class="n">proxies</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_proxies</span><span class="p">,</span>
            <span class="p">)</span> <span class="k">as</span> <span class="n">file_response</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_proxies</span><span class="p">:</span>
                    <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;requests.get using IP: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_proxy_ip</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="c1"># 分段下载</span>
                <span class="c1"># FUTURE: 由于JGI不支持断点续传，代码以后再测试</span>
                <span class="c1"># print(file_response.headers)</span>
                <span class="c1"># print(file_response.status_code)</span>
                <span class="c1"># ################### core ########################</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span> <span class="o">+</span> <span class="s2">&quot;.tmp&quot;</span><span class="p">,</span> <span class="s2">&quot;ab&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">,</span> <span class="n">tqdm</span><span class="p">(</span>
                        <span class="n">desc</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span>
                        <span class="n">total</span><span class="o">=</span><span class="n">remote_file_size</span><span class="p">,</span>
                        <span class="c1"># initial=temp_size,  # FUTURE: 由于JGI不支持断点续传，这个代码以后再用</span>
                        <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;iB&quot;</span><span class="p">,</span>
                        <span class="n">unit_scale</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                        <span class="n">unit_divisor</span><span class="o">=</span><span class="mi">1024</span><span class="p">,</span>
                <span class="p">)</span> <span class="k">as</span> <span class="n">pbar</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">file_response</span><span class="o">.</span><span class="n">iter_content</span><span class="p">(</span><span class="n">chunk_size</span><span class="o">=</span><span class="mi">1024</span><span class="p">):</span>
                            <span class="n">data_size</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                            <span class="n">pbar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">data_size</span><span class="p">)</span>
                    <span class="k">except</span> <span class="p">(</span>
                            <span class="n">InvalidChunkLength</span> <span class="ow">or</span> <span class="n">ProtocolError</span> <span class="ow">or</span> <span class="n">ChunkedEncodingError</span>
                    <span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid chunk encoding </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="n">success</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="n">loop</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">continue</span>
                <span class="c1"># ################### /core ########################</span>
                <span class="c1"># finish download</span>
                <span class="c1"># start check</span>
                <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;File </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">.tmp seems done, checking md5 value&quot;</span><span class="p">)</span>
                <span class="c1"># 如果filename md5通过则删除tmp</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_broken</span><span class="p">(</span>
                        <span class="n">filename</span> <span class="o">+</span> <span class="s2">&quot;.tmp&quot;</span><span class="p">,</span>
                        <span class="n">md5_hash</span><span class="o">=</span><span class="n">md5_hash</span><span class="p">,</span>
                        <span class="n">sizeInBytes</span><span class="o">=</span><span class="n">remote_file_size</span><span class="p">,</span>
                <span class="p">):</span>
                    <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;File </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">.tmp passed md5 checking! Renaming&quot;</span>
                    <span class="p">)</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">filename</span> <span class="o">+</span> <span class="s2">&quot;.tmp&quot;</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
                    <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;File </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2"> passed md5 checking. Go on next task.&quot;</span>
                    <span class="p">)</span>
                    <span class="n">success</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">loop</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">continue</span>  <span class="c1"># next task</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">error_counter</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;File </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">.tmp is broken! Removing and retry after 2 seconds...&quot;</span>
                    <span class="p">)</span>
                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">filename</span> <span class="o">+</span> <span class="s2">&quot;.tmp&quot;</span><span class="p">)</span>
                    <span class="n">success</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">loop</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">continue</span>  <span class="c1"># next try</span>
        <span class="k">return</span> <span class="n">filename</span><span class="p">,</span> <span class="n">success</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_download_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url_list</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Attempts download command on a list of partial file</span>
<span class="sd">        URLs (completed by download_from_url()).</span>

<span class="sd">        Returns a list of successfully-downloaded files and a</span>
<span class="sd">        list of unsuccessful URLs</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">lm</span><span class="o">.</span><span class="n">set_names</span><span class="p">(</span><span class="n">func_name</span><span class="o">=</span><span class="s2">&quot;_download_list&quot;</span><span class="p">)</span>
        <span class="n">lm</span><span class="o">.</span><span class="n">set_level</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log_level</span><span class="p">)</span>

        <span class="c1"># Run curl commands to retrieve selected files</span>
        <span class="c1"># Make sure the URL formats conforms to the Genome Portal format</span>

        <span class="n">broken_urls</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">broken_files</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">url</span> <span class="ow">in</span> <span class="n">url_list</span><span class="p">:</span>
            <span class="n">current_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="c1"># refresh the session cookie every 5 minutes</span>
            <span class="k">if</span> <span class="n">current_time</span> <span class="o">-</span> <span class="n">start_time</span> <span class="o">&gt;</span> <span class="mi">300</span><span class="p">:</span>
                <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;refresh the session cookie every 5 minutes&quot;</span><span class="p">)</span>
                <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;run self.login.&quot;</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">FILENAME_COOKIE</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_load_cookie</span><span class="p">()</span>
                <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;login succeed.&quot;</span><span class="p">)</span>
                <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

            <span class="n">fn</span><span class="p">,</span> <span class="n">success</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_download_from_url</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">success</span><span class="p">:</span>
                <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;File </span><span class="si">{</span><span class="n">fn</span><span class="si">}</span><span class="s2"> failed to download, appending to the file &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;@ </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">FILENAME_TEMPLATE_LOG_FAIL</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">query_info</span><span class="p">)</span><span class="si">}</span><span class="s2">. &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;You can use parameter --log_fails to re-download these failed files &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;after this run finish.&quot;</span>
                <span class="p">)</span>
                <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">&quot;tips: it is possible that the md5 value on JGI is wrong. If retry failed too, you can &quot;</span>
                    <span class="s2">&quot;download it from the website manually!&quot;</span>
                <span class="p">)</span>
                <span class="n">broken_urls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
                <span class="n">broken_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_downloaded_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
        <span class="n">broken_urls</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">u</span>
            <span class="k">for</span> <span class="n">u</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">broken_urls</span><span class="p">,</span> <span class="n">broken_files</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">f</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_downloaded_files</span>
        <span class="p">]</span>
        <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot; self._download_list return broken_urls = </span><span class="si">{</span><span class="n">broken_urls</span><span class="si">}</span><span class="s2">, broken_files = </span><span class="si">{</span><span class="n">broken_files</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">broken_urls</span><span class="p">,</span> <span class="n">broken_files</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_extract_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_path</span><span class="p">,</span> <span class="n">keep_compressed</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Native Python file decompression for tar.gz and .gz files.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">lm</span><span class="o">.</span><span class="n">set_names</span><span class="p">(</span><span class="n">func_name</span><span class="o">=</span><span class="s2">&quot;_extract_file&quot;</span><span class="p">)</span>
        <span class="n">lm</span><span class="o">.</span><span class="n">set_level</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log_level</span><span class="p">)</span>

        <span class="n">tar_pattern</span> <span class="o">=</span> <span class="s2">&quot;tar.gz$&quot;</span>  <span class="c1"># matches tar.gz</span>
        <span class="n">gz_pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;(?&lt;!tar)\.gz$&quot;</span>
        <span class="n">endings_map</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;tar&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">tarfile</span><span class="p">,</span> <span class="s2">&quot;r:gz&quot;</span><span class="p">,</span> <span class="s2">&quot;.tar.gz&quot;</span><span class="p">),</span> <span class="s2">&quot;gz&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">gzip</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">,</span> <span class="s2">&quot;.gz&quot;</span><span class="p">)}</span>
        <span class="n">relative_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">tar_pattern</span><span class="p">,</span> <span class="n">file_path</span><span class="p">):</span>
            <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;tar.gz file decompression for </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">opener</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">ext</span> <span class="o">=</span> <span class="n">endings_map</span><span class="p">[</span><span class="s2">&quot;tar&quot;</span><span class="p">]</span>
            <span class="k">with</span> <span class="n">opener</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">file_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">getmembers</span><span class="p">())</span>
                <span class="k">if</span> <span class="n">file_count</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># make sub-directory to unpack into</span>
                    <span class="n">dir_name</span> <span class="o">=</span> <span class="n">relative_name</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="n">ext</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">dir_name</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">FileExistsError</span><span class="p">:</span>
                        <span class="k">pass</span>
                    <span class="n">destination</span> <span class="o">=</span> <span class="n">dir_name</span>
                <span class="k">else</span><span class="p">:</span>  <span class="c1"># single file, extract into working directory</span>
                    <span class="n">destination</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span>

                <span class="k">def</span><span class="w"> </span><span class="nf">is_within_directory</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
                    <span class="n">abs_directory</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
                    <span class="n">abs_target</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>

                    <span class="n">prefix</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">commonprefix</span><span class="p">([</span><span class="n">abs_directory</span><span class="p">,</span> <span class="n">abs_target</span><span class="p">])</span>

                    <span class="k">return</span> <span class="n">prefix</span> <span class="o">==</span> <span class="n">abs_directory</span>

                <span class="k">def</span><span class="w"> </span><span class="nf">safe_extract</span><span class="p">(</span><span class="n">tar</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="n">members</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">numeric_owner</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">member</span> <span class="ow">in</span> <span class="n">tar</span><span class="o">.</span><span class="n">getmembers</span><span class="p">():</span>
                        <span class="n">member_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">member</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_within_directory</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">member_path</span><span class="p">):</span>
                            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Attempted Path Traversal in Tar File&quot;</span><span class="p">)</span>

                    <span class="n">tar</span><span class="o">.</span><span class="n">extractall</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">members</span><span class="p">,</span> <span class="n">numeric_owner</span><span class="o">=</span><span class="n">numeric_owner</span><span class="p">)</span>

                <span class="n">safe_extract</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">destination</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">gz_pattern</span><span class="p">,</span> <span class="n">file_path</span><span class="p">):</span>
            <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;gz file decompression for </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">opener</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">ext</span> <span class="o">=</span> <span class="n">endings_map</span><span class="p">[</span><span class="s2">&quot;gz&quot;</span><span class="p">]</span>
            <span class="c1"># out_name = file_path.rstrip(ext)</span>
            <span class="n">out_name</span> <span class="o">=</span> <span class="n">relative_name</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="n">ext</span><span class="p">)</span>
            <span class="k">with</span> <span class="n">opener</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">,</span> <span class="nb">open</span><span class="p">(</span><span class="n">out_name</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">out</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Skipped decompression for &#39;</span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">keep_compressed</span><span class="p">:</span>
            <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;remove compressed files&quot;</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_format_found</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">filter_found</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reformats the output from xml_hunt()</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">lm</span><span class="o">.</span><span class="n">set_names</span><span class="p">(</span><span class="n">func_name</span><span class="o">=</span><span class="s2">&quot;_format_found&quot;</span><span class="p">)</span>
        <span class="n">lm</span><span class="o">.</span><span class="n">set_level</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log_level</span><span class="p">)</span>

        <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;get categories from config (including possible user additions)&quot;</span>
        <span class="p">)</span>
        <span class="n">output</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">p</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="n">layers</span> <span class="o">=</span> <span class="p">[</span><span class="n">e</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">e</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">filter_found</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">cat</span> <span class="ow">in</span> <span class="n">layers</span> <span class="k">for</span> <span class="n">cat</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;categories&quot;</span><span class="p">]):</span>
                    <span class="k">continue</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">layers</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">top</span> <span class="o">=</span> <span class="n">parent</span> <span class="o">=</span> <span class="n">layers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">top</span> <span class="o">=</span> <span class="n">layers</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>  <span class="c1"># either -2 or -1 works well, != parent</span>
                <span class="n">parent</span> <span class="o">=</span> <span class="n">layers</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># either -2 or -1 works well, != top</span>
            <span class="k">if</span> <span class="n">top</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">output</span><span class="p">:</span>
                <span class="n">output</span><span class="p">[</span><span class="n">top</span><span class="p">]</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">parent</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">output</span><span class="p">[</span><span class="n">top</span><span class="p">]:</span>
                <span class="n">output</span><span class="p">[</span><span class="n">top</span><span class="p">][</span><span class="n">parent</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">output</span><span class="p">[</span><span class="n">top</span><span class="p">][</span><span class="n">parent</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">output</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_format_timestamp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">time_string</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parses the timestamp string from an XML document</span>
<span class="sd">        of the form &quot;Thu Feb 27 16:38:54 PST 2014&quot;</span>
<span class="sd">        and returns a string of the form &quot;2014&quot;.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Remove platform-dependent timezone substring</span>
        <span class="c1"># of the general form &quot;xxT&quot;</span>

        <span class="n">tz_pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\s[A-Z]</span><span class="si">{3}</span><span class="s2">\s&quot;</span><span class="p">)</span>
        <span class="n">time_string</span> <span class="o">=</span> <span class="n">tz_pattern</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="n">time_string</span><span class="p">)</span>
        <span class="c1"># get the desired time info</span>
        <span class="n">time_info</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">time_string</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%a</span><span class="s2"> %b </span><span class="si">%d</span><span class="s2"> %H:%M:%S %Y&quot;</span><span class="p">)</span>
        <span class="c1"># year = str(time_info.tm_year)</span>
        <span class="k">return</span> <span class="n">time_info</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_sizes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">sizes_by_url</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Builds a dictionary of url:sizes from</span>
<span class="sd">        output of get_file_list()</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="k">if</span> <span class="s2">&quot;url&quot;</span> <span class="ow">in</span> <span class="n">v</span><span class="p">:</span>
                    <span class="n">address</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="s2">&quot;url&quot;</span><span class="p">]</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="s2">&quot;sizeInBytes&quot;</span><span class="p">])</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">size</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">sizes_by_url</span><span class="p">[</span><span class="n">address</span><span class="p">]</span> <span class="o">=</span> <span class="n">size</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_get_sizes</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">sizes_by_url</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">sizes_by_url</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_md5</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">fns</span><span class="p">,</span> <span class="n">buffer_size</span><span class="o">=</span><span class="mi">65536</span><span class="p">):</span>
        <span class="nb">hash</span> <span class="o">=</span> <span class="n">md5</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">fn</span> <span class="ow">in</span> <span class="n">fns</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">buffer_size</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span><span class="p">:</span>
                        <span class="k">break</span>
                    <span class="nb">hash</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="k">return</span> <span class="nb">hash</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_sizeInBytes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">file_size_in_bytes</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getsize</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">file_size_in_bytes</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">return</span> <span class="n">file_size_in_bytes</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_regex</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get regex pattern from user, compile and return.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># manage to get a working regex</span>
        <span class="n">compile_success</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">pattern</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">while</span> <span class="n">compile_success</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">interactive</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">regex</span><span class="p">:</span>
                <span class="n">pattern</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;Regex pattern: &quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">pattern</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">regex</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span>
                <span class="n">compile_success</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Your pattern = </span><span class="si">{</span><span class="n">pattern</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[!] ERROR: Regex pattern failed to compile.&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_user_choice</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get user file selection choice(s)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">lm</span><span class="o">.</span><span class="n">set_names</span><span class="p">(</span><span class="n">func_name</span><span class="o">=</span><span class="s2">&quot;_get_user_choice&quot;</span><span class="p">)</span>
        <span class="n">lm</span><span class="o">.</span><span class="n">set_level</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log_level</span><span class="p">)</span>

        <span class="n">choice</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span>
            <span class="s2">&quot;Enter file selection (&#39;q&#39; to quit, &quot;</span>
            <span class="s2">&quot;&#39;u&#39; to review syntax/usage, &#39;a&#39; for all, &quot;</span>
            <span class="s2">&quot;&#39;r&#39; for regex-based filename matching):</span><span class="se">\n</span><span class="s2">&gt; &quot;</span>
        <span class="p">)</span>
        <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;choice = </span><span class="si">{</span><span class="n">choice</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">choice</span> <span class="o">==</span> <span class="s2">&quot;u&quot;</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">JGIDoc</span><span class="o">.</span><span class="n">select_blurb</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">()</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_user_choice</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">choice</span> <span class="o">==</span> <span class="s2">&quot;a&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">choice</span>
        <span class="k">elif</span> <span class="n">choice</span> <span class="o">==</span> <span class="s2">&quot;r&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">choice</span>
        <span class="k">elif</span> <span class="n">choice</span> <span class="o">==</span> <span class="s2">&quot;q&quot;</span><span class="p">:</span>
            <span class="n">keep_temp</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Keep temporary files (&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">FILENAME_TEMPLATE_XML</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">query_info</span><span class="p">)</span><span class="si">}</span><span class="s2">&#39; &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;and &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">FILENAME_COOKIE</span><span class="si">}</span><span class="s2">&#39;)? (y/n): &quot;</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">keep_temp</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;yes&quot;</span><span class="p">):</span>
                <span class="n">rm_cookie</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">rm_xml</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">rm_cookie</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">rm_xml</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_clean_exit</span><span class="p">(</span>
                <span class="n">exit_message</span><span class="o">=</span><span class="s2">&quot;User choose to exit&quot;</span><span class="p">,</span>
                <span class="n">exit_code</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                <span class="n">rm_cookie</span><span class="o">=</span><span class="n">rm_cookie</span><span class="p">,</span>
                <span class="n">rm_xml</span><span class="o">=</span><span class="n">rm_xml</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">choice</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_is_broken</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">min_size_bytes</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">md5_hash</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sizeInBytes</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Rudimentary check to see if a file appears to be broken.</span>

<span class="sd">        filename without &quot;.tmp&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">lm</span><span class="o">.</span><span class="n">set_names</span><span class="p">(</span><span class="n">func_name</span><span class="o">=</span><span class="s2">&quot;_is_broken&quot;</span><span class="p">)</span>
        <span class="n">lm</span><span class="o">.</span><span class="n">set_level</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log_level</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span>
                <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
                <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getsize</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">min_size_bytes</span>
                <span class="ow">or</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_check_for_xml</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
                <span class="ow">and</span> <span class="ow">not</span> <span class="n">filename</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;xml&quot;</span><span class="p">)</span>
        <span class="p">)</span>
                <span class="ow">or</span> <span class="p">(</span>
                <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_md5</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">md5_hash</span><span class="p">)</span>
                <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_sizeInBytes</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">sizeInBytes</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="p">):</span>
            <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;File is broken.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;File is intact.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_parse_selection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_input</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parses the user choice string and returns a dictionary</span>
<span class="sd">        of categories (keys) and choices within each category</span>
<span class="sd">        (values).</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">lm</span><span class="o">.</span><span class="n">set_names</span><span class="p">(</span><span class="n">func_name</span><span class="o">=</span><span class="s2">&quot;_parse_selection&quot;</span><span class="p">)</span>
        <span class="n">lm</span><span class="o">.</span><span class="n">set_level</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log_level</span><span class="p">)</span>

        <span class="n">parts</span> <span class="o">=</span> <span class="n">user_input</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">parts</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="ow">or</span> <span class="n">p</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Can&#39;t parse desired input</span><span class="se">\n</span><span class="s2">?--&gt;&#39;</span><span class="si">{</span><span class="n">p</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
                <span class="n">user_choice</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_user_choice</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_parse_selection</span><span class="p">(</span><span class="n">user_choice</span><span class="p">)</span>
            <span class="n">category</span><span class="p">,</span> <span class="n">indices</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)</span>
            <span class="n">category</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">category</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_selections</span><span class="p">[</span><span class="n">category</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">indices</span> <span class="o">=</span> <span class="n">indices</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">indices</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_selections</span><span class="p">[</span><span class="n">category</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                    <span class="p">)</span>  <span class="c1"># if it&#39;s already an integer</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">start</span><span class="p">,</span> <span class="n">stop</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">i</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">)))</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;can&#39;t parse desired input</span><span class="se">\n</span><span class="s2">?--&gt;&#39;</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_clean_exit</span><span class="p">(</span>
                            <span class="n">exit_message</span><span class="o">=</span><span class="s2">&quot;exit with error&quot;</span><span class="p">,</span>
                            <span class="n">exit_code</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                            <span class="n">rm_cookie</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                            <span class="n">rm_xml</span><span class="o">=</span><span class="kc">False</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml</span> <span class="k">else</span> <span class="kc">True</span><span class="p">,</span>
                        <span class="p">)</span>

                    <span class="n">add_range</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>

                    <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">add_range</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_selections</span><span class="p">[</span><span class="n">category</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_xml_hunt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xml_file</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gets list of all XML entries with &quot;filename&quot; attribute,</span>
<span class="sd">        and returns a dictionary of the file attributes keyed</span>
<span class="sd">        by a &quot;:&quot;-joined string of parent names.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">lm</span><span class="o">.</span><span class="n">set_names</span><span class="p">(</span><span class="n">func_name</span><span class="o">=</span><span class="s2">&quot;_xml_hunt&quot;</span><span class="p">)</span>
        <span class="n">lm</span><span class="o">.</span><span class="n">set_level</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log_level</span><span class="p">)</span>

        <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;xml_hunt...&quot;</span><span class="p">)</span>
        <span class="n">root</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">iterparse</span><span class="p">(</span><span class="n">xml_file</span><span class="p">,</span> <span class="n">events</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;start&quot;</span><span class="p">,</span> <span class="s2">&quot;end&quot;</span><span class="p">))</span>
        <span class="n">parents</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">matches</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">event</span><span class="p">,</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">root</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">element</span><span class="o">.</span><span class="n">tag</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;folder&quot;</span><span class="p">,</span> <span class="s2">&quot;file&quot;</span><span class="p">]:</span>  <span class="c1"># skip topmost categories</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="n">element</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;folder&quot;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">event</span> <span class="o">==</span> <span class="s2">&quot;start&quot;</span><span class="p">:</span>  <span class="c1"># add to parents</span>
                        <span class="n">parents</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">])</span>
                    <span class="k">elif</span> <span class="n">event</span> <span class="o">==</span> <span class="s2">&quot;end&quot;</span><span class="p">:</span>  <span class="c1"># strip from parents</span>
                        <span class="k">del</span> <span class="n">parents</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="n">event</span> <span class="o">==</span> <span class="s2">&quot;start&quot;</span> <span class="ow">and</span> <span class="n">element</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;file&quot;</span><span class="p">:</span>
                    <span class="n">parent_string</span> <span class="o">=</span> <span class="s2">&quot;:&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parents</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">matches</span><span class="p">[</span><span class="n">parent_string</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">attrib</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                        <span class="n">matches</span><span class="p">[</span><span class="n">parent_string</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">element</span><span class="o">.</span><span class="n">attrib</span><span class="p">]</span>
        <span class="k">except</span> <span class="n">ET</span><span class="o">.</span><span class="n">ParseError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span>
                <span class="s2">&quot;Query or parse xml failed, start to remove cookie. Please try again. &quot;</span>
                <span class="s2">&quot;If it is still failed, maybe the username / password is wrong? &quot;</span>
                <span class="s2">&quot;Try to use --overwrite_conf parameter to re-login&quot;</span>
            <span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">FILENAME_COOKIE</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Exit with error </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">matches</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_uniqueify</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">children</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Takes a list of child XML elements (dicts of attribs) as</span>
<span class="sd">        returns a filtered list of only unique filenames for a given</span>
<span class="sd">        month/year timestamp (e.g. duplicates are allowed if month/year</span>
<span class="sd">        is different).</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">unique</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">children</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">fn</span> <span class="o">=</span> <span class="n">child</span><span class="p">[</span><span class="s2">&quot;filename&quot;</span><span class="p">]</span>
                <span class="n">date</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format_timestamp</span><span class="p">(</span><span class="n">child</span><span class="p">[</span><span class="s2">&quot;timestamp&quot;</span><span class="p">])</span>
                <span class="n">date_string</span> <span class="o">=</span> <span class="p">(</span><span class="n">date</span><span class="o">.</span><span class="n">tm_mon</span><span class="p">,</span> <span class="n">date</span><span class="o">.</span><span class="n">tm_year</span><span class="p">)</span>
                <span class="n">uid</span> <span class="o">=</span> <span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">date_string</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">fn</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">unique</span><span class="p">:</span>
                <span class="n">unique</span><span class="p">[</span><span class="n">uid</span><span class="p">]</span> <span class="o">=</span> <span class="n">child</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">existing</span> <span class="o">=</span> <span class="n">unique</span><span class="p">[</span><span class="n">uid</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;fileType&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">existing</span> <span class="o">==</span> <span class="s2">&quot;Unknown&quot;</span><span class="p">:</span>
                    <span class="n">existing</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">current</span> <span class="o">=</span> <span class="n">child</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;fileType&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">current</span> <span class="o">==</span> <span class="s2">&quot;Unknown&quot;</span><span class="p">:</span>
                    <span class="n">current</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="n">current</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">existing</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">unique</span><span class="p">[</span><span class="n">uid</span><span class="p">]</span> <span class="o">=</span> <span class="n">child</span>

        <span class="k">return</span> <span class="n">unique</span><span class="o">.</span><span class="n">values</span><span class="p">()</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright .</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>