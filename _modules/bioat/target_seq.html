

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>bioat.target_seq &mdash; Unknown Project Documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=03e43079" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />

  
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=01f34227"></script>
      <script src="../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            Unknown Project
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">Modules</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Unknown Project</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">bioat.target_seq</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for bioat.target_seq</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;_summary_.</span>

<span class="sd">author: Herman Huanan Zhao</span>
<span class="sd">email: hermanzhaozzzz@gmail.com</span>
<span class="sd">homepage: https://github.com/hermanzhaozzzz</span>

<span class="sd">_description_</span>

<span class="sd">example 1:</span>
<span class="sd">    bioat list</span>
<span class="sd">        &lt;in shell&gt;:</span>
<span class="sd">            $ bioat list</span>
<span class="sd">        &lt;in python consolo&gt;:</span>
<span class="sd">            &gt;&gt;&gt; from bioat.cli import Cli</span>
<span class="sd">            &gt;&gt;&gt; bioat = Cli()</span>
<span class="sd">            &gt;&gt;&gt; bioat.list()</span>
<span class="sd">            &gt;&gt;&gt; print(bioat.list())</span>

<span class="sd">example 2:</span>
<span class="sd">    _example_</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">gzip</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os.path</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">mpl</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">Bio.Seq</span><span class="w"> </span><span class="kn">import</span> <span class="n">Seq</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib.collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">PatchCollection</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib.patches</span><span class="w"> </span><span class="kn">import</span> <span class="n">Rectangle</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">tabulate</span><span class="w"> </span><span class="kn">import</span> <span class="n">tabulate</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">bioat.exceptions</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">BioatFileFormatError</span><span class="p">,</span>
    <span class="n">BioatInvalidInputError</span><span class="p">,</span>
    <span class="n">BioatInvalidOptionError</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">bioat.lib.libalignment</span><span class="w"> </span><span class="kn">import</span> <span class="n">instantiate_pairwise_aligner</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">bioat.lib.libcolor</span><span class="w"> </span><span class="kn">import</span> <span class="n">convert_hex_to_rgb</span><span class="p">,</span> <span class="n">make_color_list</span><span class="p">,</span> <span class="n">map_color</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">bioat.lib.libcrispr</span><span class="w"> </span><span class="kn">import</span> <span class="n">TARGET_SEQ_LIB</span><span class="p">,</span> <span class="n">run_target_seq_align</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">bioat.lib.libpandas</span><span class="w"> </span><span class="kn">import</span> <span class="n">set_option</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">bioat.logger</span><span class="w"> </span><span class="kn">import</span> <span class="n">LoggerManager</span>

<span class="n">lm</span> <span class="o">=</span> <span class="n">LoggerManager</span><span class="p">(</span><span class="n">mod_name</span><span class="o">=</span><span class="s2">&quot;bioat.target_seq&quot;</span><span class="p">)</span>

<span class="n">set_option</span><span class="p">(</span><span class="n">log_level</span><span class="o">=</span><span class="s2">&quot;ERROR&quot;</span><span class="p">)</span>


<div class="viewcode-block" id="TargetSeq">
<a class="viewcode-back" href="../../bioat.html#bioat.target_seq.TargetSeq">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">TargetSeq</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Target Deep Sequencing toolbox.&quot;&quot;&quot;</span>

    <span class="n">lm</span><span class="o">.</span><span class="n">set_names</span><span class="p">(</span><span class="n">cls_name</span><span class="o">=</span><span class="s2">&quot;TargetSeq&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

<div class="viewcode-block" id="TargetSeq.region_heatmap">
<a class="viewcode-back" href="../../bioat.html#bioat.target_seq.TargetSeq.region_heatmap">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">region_heatmap</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">input_table</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">output_fig</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">target_seq</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># sgRNA</span>
        <span class="n">reference_seq</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># target locus</span>
        <span class="n">input_table_header</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">output_fig_fmt</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;pdf&quot;</span><span class="p">,</span>
        <span class="n">output_fig_dpi</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
        <span class="n">show_indel</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">show_index</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">box_border</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">box_space</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.03</span><span class="p">,</span>
        <span class="n">min_color</span><span class="p">:</span> <span class="nb">tuple</span> <span class="o">=</span> <span class="p">(</span><span class="mi">250</span><span class="p">,</span> <span class="mi">239</span><span class="p">,</span> <span class="mi">230</span><span class="p">),</span>
        <span class="n">max_color</span><span class="p">:</span> <span class="nb">tuple</span> <span class="o">=</span> <span class="p">(</span><span class="mi">154</span><span class="p">,</span> <span class="mi">104</span><span class="p">,</span> <span class="mi">57</span><span class="p">),</span>
        <span class="n">min_ratio</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.001</span><span class="p">,</span>
        <span class="n">max_ratio</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.99</span><span class="p">,</span>
        <span class="n">region_extend_length</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
        <span class="n">local_alignment_scoring_matrix</span><span class="p">:</span> <span class="nb">tuple</span> <span class="o">=</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="o">-</span><span class="mi">4</span><span class="p">,</span> <span class="o">-</span><span class="mi">24</span><span class="p">,</span> <span class="o">-</span><span class="mi">8</span><span class="p">),</span>
        <span class="n">local_alignment_min_score</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">15</span><span class="p">,</span>
        <span class="n">PAM_priority_weight</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
        <span class="n">get_built_in_target_seq</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">log_level</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;INFO&quot;</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Plot region mutation information using a table generated by `bioat bam mpileup_to_table`.</span>

<span class="sd">        This function generates a visualization of mutation information for a specific genomic region</span>
<span class="sd">        based on a table created by the `bioat bam mpileup_to_table` command.</span>

<span class="sd">        Args:</span>
<span class="sd">            input_table (str): Path to the table generated by `bioat bam mpileup_to_table`.</span>
<span class="sd">                This table should contain base mutation information for a short genome region (no more than 1k nt).</span>
<span class="sd">            output_fig (str): Path to the output figure file.</span>
<span class="sd">            target_seq (str, optional): Target sequence to align against the reference sequence in `mpileup.table`.</span>

<span class="sd">        Examples:</span>
<span class="sd">                    - &#39;GAGTCCGAGCAGAAGAAGAA^GGG^&#39; for SpCas9-BE (PAM: ^GGG^).</span>
<span class="sd">                    - &#39;^TTTA^GCCCCAATAATCCCCACATGTCA&#39; for cpf1-BE (PAM: ^TTTA^).</span>
<span class="sd">                    - &#39;TGCTAGTAACCACGTTCTCCTGATCAAATATCACTCTCCTACTTACAGGA&#39; for no PAM.</span>
<span class="sd">                Defaults to None.</span>
<span class="sd">            reference_seq (str, optional): Custom reference sequence to overwrite the one in `mpileup.table`.</span>
<span class="sd">                Can be a FASTA file or a DNA sequence. Defaults to None.</span>
<span class="sd">            input_table_header (bool, optional): Whether the `input_table` contains a header. Defaults to True.</span>
<span class="sd">            output_fig_fmt (str, optional): Format of the output figure (&quot;pdf&quot; or &quot;png&quot;). Defaults to &quot;pdf&quot;.</span>
<span class="sd">            output_fig_dpi (int, optional): DPI for the output figure. Defaults to 300.</span>
<span class="sd">            show_indel (bool, optional): Whether to show indel information in the output figure. Defaults to True.</span>
<span class="sd">            show_index (bool, optional): Whether to display index information in the output figure. Defaults to True.</span>
<span class="sd">            box_border (bool, optional): Whether to display box borders in the output figure. Defaults to True.</span>
<span class="sd">            box_space (int, optional): Space size between two boxes. Defaults to 1.</span>
<span class="sd">            min_color (tuple, optional): Minimum color for the heatmap in RGB format. Defaults to (255, 255, 255).</span>
<span class="sd">            max_color (tuple, optional): Maximum color for the heatmap in RGB format. Defaults to (0, 0, 0).</span>
<span class="sd">            min_ratio (float, optional): Mutation ratio below `min_ratio` will be shown as white. Defaults to 0.0.</span>
<span class="sd">            max_ratio (float, optional): Mutation ratio above `max_ratio` will be capped. Defaults to 1.0.</span>
<span class="sd">            region_extend_length (int, optional): Number of base pairs to extend on either side of the region. Defaults to 0.</span>
<span class="sd">            local_alignment_scoring_matrix (tuple, optional): Alignment scoring parameters as a tuple:</span>
<span class="sd">                (&lt;align_match_score&gt;, &lt;align_mismatch_score&gt;, &lt;align_gap_open_score&gt;, &lt;align_gap_extension_score&gt;).</span>
<span class="sd">                Defaults to None.</span>
<span class="sd">            local_alignment_min_score (int, optional): Minimum alignment score to consider as a valid alignment. Defaults to 0.</span>
<span class="sd">            PAM_priority_weight (float, optional): Weight multiplier for PAM alignment scores. Defaults to 1.0.</span>
<span class="sd">            get_built_in_target_seq (bool, optional): Set to True to return built-in target sequence information. Defaults to False.</span>
<span class="sd">            log_level (str, optional): Logging level. One of &#39;CRITICAL&#39;, &#39;ERROR&#39;, &#39;WARNING&#39;, &#39;INFO&#39;, &#39;DEBUG&#39;, &#39;NOTSET&#39;. Defaults to &quot;INFO&quot;.</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>

<span class="sd">        Examples:</span>
<span class="sd">            &gt;&gt;&gt; # Generate mutation table</span>
<span class="sd">            &gt;&gt;&gt; samtools mpileup test_sorted.bam --reference HK4-AOut-1.ref.upper.fa | gzip &gt; test_sorted.mpileup.gz</span>
<span class="sd">            &gt;&gt;&gt; bioat bam mpileup_to_table test_sorted.mpileup.gz &gt; test_sorted.mpileup.info.tsv</span>
<span class="sd">            &gt;&gt;&gt; # Generate region heatmap</span>
<span class="sd">            &gt;&gt;&gt; bioat target_seq region_heatmap --input_table test_sorted.mpileup.info.tsv --output_fig test_sorted.mpileup.info.pdf</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">lm</span><span class="o">.</span><span class="n">set_names</span><span class="p">(</span><span class="n">func_name</span><span class="o">=</span><span class="s2">&quot;region_heatmap&quot;</span><span class="p">)</span>
        <span class="n">lm</span><span class="o">.</span><span class="n">set_level</span><span class="p">(</span><span class="n">log_level</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">get_built_in_target_seq</span><span class="p">:</span>
            <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;You can use &lt;key&gt; in built-in &lt;target_seq&gt; to represent your target_seq:</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&lt;key&gt;</span><span class="se">\t</span><span class="s2">&lt;target_seq&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="se">\t</span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">TARGET_SEQ_LIB</span><span class="o">.</span><span class="n">items</span><span class="p">()]),</span>
            <span class="p">)</span>
            <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;exit because of the defination for get_built_in_target_seq&quot;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># set sgRNA info</span>
            <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;load target_seq = </span><span class="si">{</span><span class="n">target_seq</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">target_seq</span> <span class="ow">in</span> <span class="n">TARGET_SEQ_LIB</span><span class="p">:</span>
                <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;target_seq information is abtained from the &lt;key&gt;=</span><span class="si">{</span><span class="n">target_seq</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">target_seq</span> <span class="o">=</span> <span class="n">TARGET_SEQ_LIB</span><span class="p">[</span><span class="n">target_seq</span><span class="p">]</span>
                <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;target_seq is refered to </span><span class="si">{</span><span class="n">target_seq</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">target_seq</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">target_seq</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;target_seq is refered to </span><span class="si">{</span><span class="n">target_seq</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="s2">&quot;&lt;target_seq&gt; should be set as:&quot;</span>
                    <span class="s2">&quot;DNA sequence / &lt;key&gt; in &lt;get_built_in_target_seq&gt; / None,&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;but your &lt;target_seq&gt; is </span><span class="si">{</span><span class="n">target_seq</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># set alignment</span>
        <span class="n">aligner</span> <span class="o">=</span> <span class="n">instantiate_pairwise_aligner</span><span class="p">(</span><span class="o">*</span><span class="n">local_alignment_scoring_matrix</span><span class="p">)</span>

        <span class="c1"># load mpileup.info.tsv</span>
        <span class="k">if</span> <span class="n">input_table_header</span><span class="p">:</span>
            <span class="n">df_bases</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">input_table</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">df_bases</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">input_table</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

        <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;df_bases.head(10):</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="o">+</span> <span class="n">tabulate</span><span class="p">(</span><span class="n">df_bases</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span> <span class="n">headers</span><span class="o">=</span><span class="s2">&quot;keys&quot;</span><span class="p">,</span> <span class="n">tablefmt</span><span class="o">=</span><span class="s2">&quot;psql&quot;</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="c1"># ref_seq &amp; ref_seq_rc</span>
        <span class="k">if</span> <span class="n">reference_seq</span><span class="p">:</span>
            <span class="c1"># fa file or seq str     to seq str</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">reference_seq</span><span class="p">):</span>
                <span class="n">f</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="nb">open</span><span class="p">(</span><span class="n">reference_seq</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">reference_seq</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.gz&quot;</span><span class="p">)</span>
                    <span class="k">else</span> <span class="n">gzip</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">reference_seq</span><span class="p">,</span> <span class="s2">&quot;rt&quot;</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="n">reference_seq</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">i</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()[</span><span class="mi">1</span><span class="p">:]])</span>
                <span class="k">if</span> <span class="n">reference_seq</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s2">&quot;&gt;&quot;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">BioatFileFormatError</span>

            <span class="n">ref_seq</span> <span class="o">=</span> <span class="n">Seq</span><span class="p">(</span><span class="n">reference_seq</span><span class="p">)</span>
            <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;load ref_seq from parameter:</span><span class="se">\n</span><span class="si">{</span><span class="n">ref_seq</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ref_seq</span> <span class="o">=</span> <span class="n">Seq</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">df_bases</span><span class="o">.</span><span class="n">ref_base</span><span class="p">))</span>
            <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;load ref_seq from df_bases.ref_base:</span><span class="se">\n</span><span class="si">{</span><span class="n">ref_seq</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Seq object for ref_seq:</span><span class="se">\n</span><span class="si">{</span><span class="n">ref_seq</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">ref_seq_rc</span> <span class="o">=</span> <span class="n">ref_seq</span><span class="o">.</span><span class="n">reverse_complement</span><span class="p">()</span>
        <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Seq object for ref_seq_rc (reverse_complement):</span><span class="se">\n</span><span class="si">{</span><span class="n">ref_seq_rc</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># target_seq</span>
        <span class="k">if</span> <span class="n">target_seq</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">target_seq</span> <span class="o">=</span> <span class="n">ref_seq</span>
            <span class="n">PAM</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">elif</span> <span class="s2">&quot;^&quot;</span> <span class="ow">in</span> <span class="n">target_seq</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">target_seq</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;^&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">PAM</span><span class="p">,</span> <span class="n">target_seq</span> <span class="o">=</span> <span class="n">target_seq</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;^&quot;</span><span class="p">)</span>
                <span class="n">target_seq</span> <span class="o">=</span> <span class="n">Seq</span><span class="p">(</span><span class="n">target_seq</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>
                <span class="n">PAM</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;PAM&quot;</span><span class="p">:</span> <span class="n">PAM</span><span class="p">,</span> <span class="s2">&quot;position&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;weight&quot;</span><span class="p">:</span> <span class="n">PAM_priority_weight</span><span class="p">}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">target_seq</span><span class="p">,</span> <span class="n">PAM</span> <span class="o">=</span> <span class="n">target_seq</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;^&quot;</span><span class="p">)</span>
                <span class="n">target_seq</span> <span class="o">=</span> <span class="n">Seq</span><span class="p">(</span><span class="n">target_seq</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>
                <span class="n">PAM</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;PAM&quot;</span><span class="p">:</span> <span class="n">PAM</span><span class="p">,</span>
                    <span class="s2">&quot;position&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">target_seq</span><span class="p">),</span>
                    <span class="s2">&quot;weight&quot;</span><span class="p">:</span> <span class="n">PAM_priority_weight</span><span class="p">,</span>
                <span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;no PAM sequence is defined from target_seq = </span><span class="si">{</span><span class="n">target_seq</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">target_seq</span> <span class="o">=</span> <span class="n">Seq</span><span class="p">(</span><span class="n">target_seq</span><span class="p">)</span>
            <span class="n">PAM</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;parse target_seq: target_seq=</span><span class="si">{</span><span class="n">target_seq</span><span class="si">}</span><span class="s2">, PAM=</span><span class="si">{</span><span class="n">PAM</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># fwd alignment &amp; rev alignment</span>
        <span class="c1"># 为了判断target_seq (sgRNA) 是设计在fwd还是rev链上</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">PAM</span><span class="p">:</span>
            <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;use PAMless mode to align&quot;</span><span class="p">)</span>
            <span class="n">fwd</span> <span class="o">=</span> <span class="n">run_target_seq_align</span><span class="p">(</span><span class="n">ref_seq</span><span class="p">,</span> <span class="n">target_seq</span><span class="p">,</span> <span class="n">aligner</span><span class="p">)</span>
            <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;final_align_forward:</span><span class="se">\n</span><span class="si">{</span><span class="n">fwd</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">rev</span> <span class="o">=</span> <span class="n">run_target_seq_align</span><span class="p">(</span><span class="n">ref_seq_rc</span><span class="p">,</span> <span class="n">target_seq</span><span class="p">,</span> <span class="n">aligner</span><span class="p">)</span>
            <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;final_align_reverse:</span><span class="se">\n</span><span class="si">{</span><span class="n">rev</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;use PAM mode to align&quot;</span><span class="p">)</span>
            <span class="c1"># fwd = run_target_seq_align(ref_seq, target_seq, aligner, PAM=PAM)</span>
            <span class="c1"># lm.logger.debug(f&#39;final_align_forward:\n{fwd}&#39;)</span>
            <span class="c1"># rev = run_target_seq_align(ref_seq_rc, target_seq, aligner, PAM=PAM)</span>
            <span class="c1"># lm.logger.debug(f&#39;final_align_reverse:\n{rev}&#39;)</span>
            <span class="n">fwd</span> <span class="o">=</span> <span class="n">run_target_seq_align</span><span class="p">(</span><span class="n">ref_seq</span><span class="p">,</span> <span class="n">target_seq</span><span class="p">,</span> <span class="n">aligner</span><span class="p">)</span>
            <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;final_align_forward:</span><span class="se">\n</span><span class="si">{</span><span class="n">fwd</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">rev</span> <span class="o">=</span> <span class="n">run_target_seq_align</span><span class="p">(</span><span class="n">ref_seq_rc</span><span class="p">,</span> <span class="n">target_seq</span><span class="p">,</span> <span class="n">aligner</span><span class="p">)</span>
            <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;final_align_reverse:</span><span class="se">\n</span><span class="si">{</span><span class="n">rev</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># get fwd alignment info</span>
        <span class="n">reference_seq</span> <span class="o">=</span> <span class="n">fwd</span><span class="p">[</span><span class="s2">&quot;alignment&quot;</span><span class="p">][</span><span class="s2">&quot;reference_seq&quot;</span><span class="p">][</span>
            <span class="n">fwd</span><span class="p">[</span><span class="s2">&quot;ref_aln_start&quot;</span><span class="p">]</span> <span class="p">:</span> <span class="n">fwd</span><span class="p">[</span><span class="s2">&quot;ref_aln_end&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="p">]</span>
        <span class="n">align_info</span> <span class="o">=</span> <span class="n">fwd</span><span class="p">[</span><span class="s2">&quot;alignment&quot;</span><span class="p">][</span><span class="s2">&quot;aln_info&quot;</span><span class="p">][</span>
            <span class="n">fwd</span><span class="p">[</span><span class="s2">&quot;ref_aln_start&quot;</span><span class="p">]</span> <span class="p">:</span> <span class="n">fwd</span><span class="p">[</span><span class="s2">&quot;ref_aln_end&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="p">]</span>
        <span class="n">target_seq</span> <span class="o">=</span> <span class="n">fwd</span><span class="p">[</span><span class="s2">&quot;alignment&quot;</span><span class="p">][</span><span class="s2">&quot;target_seq&quot;</span><span class="p">][</span>
            <span class="n">fwd</span><span class="p">[</span><span class="s2">&quot;ref_aln_start&quot;</span><span class="p">]</span> <span class="p">:</span> <span class="n">fwd</span><span class="p">[</span><span class="s2">&quot;ref_aln_end&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="p">]</span>
        <span class="n">aln_score</span> <span class="o">=</span> <span class="n">fwd</span><span class="p">[</span><span class="s2">&quot;aln_score&quot;</span><span class="p">]</span>
        <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Forward best alignment:</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;reference  : </span><span class="si">{</span><span class="n">reference_seq</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;align_info : </span><span class="si">{</span><span class="n">align_info</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;target_seq : </span><span class="si">{</span><span class="n">target_seq</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;align_score: </span><span class="si">{</span><span class="n">aln_score</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># get rev alignment info</span>
        <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">rev</span><span class="p">)</span>
        <span class="n">reference_seq_rev</span> <span class="o">=</span> <span class="n">rev</span><span class="p">[</span><span class="s2">&quot;alignment&quot;</span><span class="p">][</span><span class="s2">&quot;reference_seq&quot;</span><span class="p">][</span>
            <span class="n">rev</span><span class="p">[</span><span class="s2">&quot;ref_aln_start&quot;</span><span class="p">]</span> <span class="p">:</span> <span class="n">rev</span><span class="p">[</span><span class="s2">&quot;ref_aln_end&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="p">]</span>
        <span class="n">align_info_rev</span> <span class="o">=</span> <span class="n">rev</span><span class="p">[</span><span class="s2">&quot;alignment&quot;</span><span class="p">][</span><span class="s2">&quot;aln_info&quot;</span><span class="p">][</span>
            <span class="n">rev</span><span class="p">[</span><span class="s2">&quot;ref_aln_start&quot;</span><span class="p">]</span> <span class="p">:</span> <span class="n">rev</span><span class="p">[</span><span class="s2">&quot;ref_aln_end&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="p">]</span>
        <span class="n">target_seq_rev</span> <span class="o">=</span> <span class="n">rev</span><span class="p">[</span><span class="s2">&quot;alignment&quot;</span><span class="p">][</span><span class="s2">&quot;target_seq&quot;</span><span class="p">][</span>
            <span class="n">rev</span><span class="p">[</span><span class="s2">&quot;ref_aln_start&quot;</span><span class="p">]</span> <span class="p">:</span> <span class="n">rev</span><span class="p">[</span><span class="s2">&quot;ref_aln_end&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="p">]</span>
        <span class="n">aln_score_rev</span> <span class="o">=</span> <span class="n">rev</span><span class="p">[</span><span class="s2">&quot;aln_score&quot;</span><span class="p">]</span>
        <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Reverse best alignment:</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;reference  : </span><span class="si">{</span><span class="n">reference_seq_rev</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;align_info : </span><span class="si">{</span><span class="n">align_info_rev</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;target_seq : </span><span class="si">{</span><span class="n">target_seq_rev</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;align_score: </span><span class="si">{</span><span class="n">aln_score_rev</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># define align direction and final align res</span>
        <span class="c1"># make alignment info</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span>
            <span class="n">x</span> <span class="o">&gt;=</span> <span class="n">local_alignment_min_score</span>
                <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">(</span><span class="n">fwd</span><span class="p">[</span><span class="s2">&quot;aln_score&quot;</span><span class="p">],</span> <span class="n">rev</span><span class="p">[</span><span class="s2">&quot;aln_score&quot;</span><span class="p">])</span>
        <span class="p">):</span>
            <span class="k">if</span> <span class="n">fwd</span><span class="p">[</span><span class="s2">&quot;aln_score&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">rev</span><span class="p">[</span><span class="s2">&quot;aln_score&quot;</span><span class="p">]:</span>
                <span class="n">aln_direction</span> <span class="o">=</span> <span class="s2">&quot;Forward Alignment&quot;</span>
                <span class="n">aln</span> <span class="o">=</span> <span class="n">fwd</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">aln_direction</span> <span class="o">=</span> <span class="s2">&quot;Reverse Alignment&quot;</span>
                <span class="n">aln</span> <span class="o">=</span> <span class="n">rev</span>
                <span class="n">reference_seq</span> <span class="o">=</span> <span class="n">reference_seq_rev</span>
                <span class="n">align_info</span> <span class="o">=</span> <span class="n">align_info_rev</span>
                <span class="n">target_seq</span> <span class="o">=</span> <span class="n">target_seq_rev</span>
                <span class="n">aln_score</span> <span class="o">=</span> <span class="n">aln_score_rev</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s2">&quot;Alignment Error!&quot;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># mark aligned all bases in target_seq</span>
        <span class="n">ref_seq_length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ref_seq</span><span class="p">)</span>
        <span class="n">target_seq_aln</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">ref_seq_length</span>
        <span class="c1"># mark inserted bases in target_seq</span>
        <span class="n">target_seq_aln_insert</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">ref_seq_length</span>
        <span class="n">DNA_rev_cmp_dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;A&quot;</span><span class="p">:</span> <span class="s2">&quot;T&quot;</span><span class="p">,</span>
            <span class="s2">&quot;T&quot;</span><span class="p">:</span> <span class="s2">&quot;A&quot;</span><span class="p">,</span>
            <span class="s2">&quot;C&quot;</span><span class="p">:</span> <span class="s2">&quot;G&quot;</span><span class="p">,</span>
            <span class="s2">&quot;G&quot;</span><span class="p">:</span> <span class="s2">&quot;C&quot;</span><span class="p">,</span>
            <span class="s2">&quot;N&quot;</span><span class="p">:</span> <span class="s2">&quot;N&quot;</span><span class="p">,</span>
            <span class="s2">&quot;-&quot;</span><span class="p">:</span> <span class="s2">&quot;-&quot;</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="n">reference_seq</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">)</span>
        <span class="n">target_seq</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">)</span>

        <span class="n">ref_gap_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">ref_del_str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

        <span class="n">aln_start</span> <span class="o">=</span> <span class="n">aln</span><span class="p">[</span><span class="s2">&quot;ref_aln_start&quot;</span><span class="p">]</span>
        <span class="n">aln_end</span> <span class="o">=</span> <span class="n">aln</span><span class="p">[</span><span class="s2">&quot;ref_aln_end&quot;</span><span class="p">]</span>

        <span class="c1"># update target_seq_aln</span>
        <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;target_seq_aln (before update) = </span><span class="si">{</span><span class="n">target_seq_aln</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;target_seq_aln_insert (before update) = </span><span class="si">{</span><span class="n">target_seq_aln_insert</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">ref_base</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">reference_seq</span><span class="p">):</span>
            <span class="c1"># reference  : GCCTCTGGAGAGGGAGGAGGG</span>
            <span class="c1"># align_info : |.|.|||..|..|||||.||-</span>
            <span class="c1"># target_seq : GGCACTGCGGCTGGAGGTGG-</span>
            <span class="k">if</span> <span class="n">ref_base</span> <span class="o">!=</span> <span class="s2">&quot;-&quot;</span><span class="p">:</span>
                <span class="n">ref_gap_count</span> <span class="o">+=</span> <span class="mi">0</span>
                <span class="n">ref_del_str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                <span class="n">target_seq_aln</span><span class="p">[</span><span class="n">aln_start</span> <span class="o">+</span> <span class="n">idx</span> <span class="o">-</span> <span class="n">ref_gap_count</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">ref_del_str</span> <span class="o">+</span> <span class="n">target_seq</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ref_gap_count</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">ref_del_str</span> <span class="o">+=</span> <span class="n">target_seq</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>  <span class="c1"># for continuous gap</span>
                <span class="n">target_seq_aln_insert</span><span class="p">[</span><span class="n">aln_start</span> <span class="o">+</span> <span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">target_seq</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;update target_seq_aln: show &#39;&#39;.join(target_seq_aln)</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;target_seq_aln = </span><span class="si">{</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">target_seq_aln</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;target_seq     = </span><span class="si">{</span><span class="n">target_seq</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;update target_seq_aln: Done&quot;</span><span class="p">)</span>
        <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;target_seq_aln (after update) = </span><span class="si">{</span><span class="n">target_seq_aln</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;target_seq_aln_insert (after update) = </span><span class="si">{</span><span class="n">target_seq_aln_insert</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># if reverse alignment</span>
        <span class="k">if</span> <span class="n">aln_direction</span> <span class="o">==</span> <span class="s2">&quot;Reverse Alignment&quot;</span><span class="p">:</span>
            <span class="c1"># illustrate reverse alignment as forward alignment</span>
            <span class="n">target_seq_aln</span> <span class="o">=</span> <span class="n">target_seq_aln</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">target_seq_aln_insert</span> <span class="o">=</span> <span class="n">target_seq_aln_insert</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;use reverse alignment&quot;</span><span class="p">)</span>
            <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;target_seq_aln = </span><span class="si">{</span><span class="n">target_seq_aln</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;target_seq_aln_insert = </span><span class="si">{</span><span class="n">target_seq_aln_insert</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># add PAM info</span>

        <span class="c1"># print(target_seq_aln)</span>
        <span class="c1"># print(target_seq_aln_insert)</span>
        <span class="c1"># target_seq_aln</span>
        <span class="c1"># [&#39;-&#39;,&#39;-&#39;,&#39;G&#39;,&#39;G&#39;,&#39;C&#39;,&#39;A&#39;,&#39;G&#39;,&#39;C&#39;,&#39;G&#39;,&#39;G&#39;,&#39;C&#39;,&#39;T&#39;,&#39;G&#39;,&#39;G&#39;,&#39;A&#39;,&#39;A&#39;,&#39;A&#39;,&#39;A&#39;,&#39;A&#39;,&#39;A&#39;,&#39;A&#39;,&#39;A&#39;,&#39;A&#39;,&#39;A&#39;,&#39;A&#39;,&#39;A&#39;,</span>
        <span class="c1"># &#39;A&#39;,&#39;A&#39;,&#39;A&#39;,&#39;G&#39;,&#39;T&#39;,&#39;&#39;,&#39;&#39;]</span>
        <span class="c1"># target_seq_aln_insert</span>
        <span class="c1"># [&#39;&#39;,&#39;&#39;,&#39;&#39;,&#39;&#39;,&#39;&#39;,&#39;&#39;,&#39;&#39;,&#39;&#39;,&#39;&#39;,&#39;&#39;,&#39;&#39;,&#39;&#39;,&#39;&#39;,&#39;&#39;,&#39;&#39;,&#39;&#39;,&#39;&#39;,&#39;&#39;,&#39;&#39;,&#39;&#39;,&#39;&#39;,&#39;&#39;,&#39;&#39;,&#39;&#39;,&#39;&#39;,&#39;&#39;,&#39;&#39;,&#39;&#39;,&#39;&#39;,&#39;A&#39;,&#39;G&#39;,&#39;&#39;,&#39;&#39;]</span>

        <span class="c1"># set plot_region</span>
        <span class="c1"># print(aln_start, aln_end, region_extend_length, ref_seq_length)</span>
        <span class="c1"># 56 76 25 266</span>
        <span class="c1"># print(aln_start - region_extend_length)</span>
        <span class="c1"># 31</span>
        <span class="c1"># print(aln_end + region_extend_length)</span>
        <span class="c1"># 101</span>
        <span class="n">possible_target_region_start</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">aln_start</span> <span class="o">-</span> <span class="n">region_extend_length</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">possible_target_region_end</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span>
            <span class="n">aln_end</span> <span class="o">+</span> <span class="n">region_extend_length</span><span class="p">,</span> <span class="n">ref_seq_length</span>
        <span class="p">)</span>  <span class="c1"># 266: 0~255 266 - 1</span>
        <span class="n">plot_region</span> <span class="o">=</span> <span class="p">(</span><span class="n">possible_target_region_start</span><span class="p">,</span> <span class="n">possible_target_region_end</span><span class="p">)</span>
        <span class="n">df_bases_select</span> <span class="o">=</span> <span class="n">df_bases</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">plot_region</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">:</span> <span class="n">plot_region</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">:]</span>
        <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;df_bases_select:</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="o">+</span> <span class="n">tabulate</span><span class="p">(</span><span class="n">df_bases_select</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="s2">&quot;keys&quot;</span><span class="p">,</span> <span class="n">tablefmt</span><span class="o">=</span><span class="s2">&quot;psql&quot;</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="c1"># make plot</span>
        <span class="c1"># set color</span>
        <span class="c1"># show indel</span>
        <span class="n">mpl</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s2">&quot;Agg&quot;</span><span class="p">)</span>
        <span class="n">np</span><span class="o">.</span><span class="n">set_printoptions</span><span class="p">(</span><span class="n">suppress</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">indel_plot_state</span> <span class="o">=</span> <span class="n">show_indel</span>
        <span class="n">box_border_plot_state</span> <span class="o">=</span> <span class="n">box_border</span>

        <span class="c1"># set panel size</span>
        <span class="n">panel_box_width</span> <span class="o">=</span> <span class="mf">0.4</span>
        <span class="n">panel_box_heigth</span> <span class="o">=</span> <span class="mf">0.4</span>
        <span class="n">panel_space</span> <span class="o">=</span> <span class="mf">0.05</span>
        <span class="n">panel_box_space</span> <span class="o">=</span> <span class="n">box_space</span>

        <span class="c1"># color part</span>
        <span class="n">base_colors</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;A&quot;</span><span class="p">:</span> <span class="s2">&quot;#04E3E3&quot;</span><span class="p">,</span>
            <span class="s2">&quot;T&quot;</span><span class="p">:</span> <span class="s2">&quot;#F9B874&quot;</span><span class="p">,</span>
            <span class="s2">&quot;C&quot;</span><span class="p">:</span> <span class="s2">&quot;#B9E76B&quot;</span><span class="p">,</span>
            <span class="s2">&quot;G&quot;</span><span class="p">:</span> <span class="s2">&quot;#F53798&quot;</span><span class="p">,</span>
            <span class="s2">&quot;N&quot;</span><span class="p">:</span> <span class="s2">&quot;#AAAAAA&quot;</span><span class="p">,</span>
            <span class="s2">&quot;-&quot;</span><span class="p">:</span> <span class="s2">&quot;#AAAAAA&quot;</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="c1"># make color breaks</span>
        <span class="n">color_break_num</span> <span class="o">=</span> <span class="mi">20</span>
        <span class="n">break_step</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">color_break_num</span>
        <span class="c1"># mutation ratio of box lower than min_ratio will show as white</span>
        <span class="n">min_color_value</span> <span class="o">=</span> <span class="n">min_ratio</span>
        <span class="c1"># mutation ratio of box lower than max_ratio will show as white</span>
        <span class="n">max_color_value</span> <span class="o">=</span> <span class="n">max_ratio</span>
        <span class="n">color_break</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">min_color_value</span><span class="p">,</span> <span class="n">max_color_value</span><span class="p">,</span> <span class="n">break_step</span><span class="p">),</span> <span class="mi">5</span>
        <span class="p">)</span>
        <span class="c1"># min_color: min color to plot heatmap with RGB format</span>
        <span class="c1"># max_color: max color to plot heatmap with RGB format</span>
        <span class="n">color_list</span> <span class="o">=</span> <span class="n">make_color_list</span><span class="p">(</span><span class="n">min_color</span><span class="p">,</span> <span class="n">max_color</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">color_break</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;HEX&quot;</span><span class="p">)</span>
        <span class="n">color_list</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;#FFFFFF&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">color_list</span><span class="p">]</span>
        <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;color_list = </span><span class="si">{</span><span class="n">color_list</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># get plot info</span>
        <span class="n">total_box_count</span> <span class="o">=</span> <span class="n">plot_region</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">plot_region</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># calculate base info and fix zero</span>
        <span class="n">base_sum_count</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">df_bases_select</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="p">[</span><span class="s2">&quot;A&quot;</span><span class="p">,</span> <span class="s2">&quot;G&quot;</span><span class="p">,</span> <span class="s2">&quot;C&quot;</span><span class="p">,</span> <span class="s2">&quot;T&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;base_sum_count =</span><span class="se">\n</span><span class="si">{</span><span class="n">base_sum_count</span><span class="o">.</span><span class="n">values</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">total_sum_count</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">df_bases_select</span><span class="p">[[</span><span class="s2">&quot;A&quot;</span><span class="p">,</span> <span class="s2">&quot;G&quot;</span><span class="p">,</span> <span class="s2">&quot;C&quot;</span><span class="p">,</span> <span class="s2">&quot;T&quot;</span><span class="p">,</span> <span class="s2">&quot;del_count&quot;</span><span class="p">,</span> <span class="s2">&quot;insert_count&quot;</span><span class="p">]]</span>
            <span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;total_sum_count =</span><span class="se">\n</span><span class="si">{</span><span class="n">total_sum_count</span><span class="o">.</span><span class="n">values</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="c1"># fix 0 -&gt; [&quot;A.ratio&quot;, list(df_bases_select[&quot;A&quot;] / base_sum_count)]</span>
        <span class="n">base_sum_count</span><span class="p">[</span><span class="n">base_sum_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">total_sum_count</span><span class="p">[</span><span class="n">total_sum_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="c1"># make plot size</span>
        <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;aln =</span><span class="se">\n</span><span class="si">{</span><span class="n">aln</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">indel_plot_state</span><span class="p">:</span>
            <span class="n">panel_height_coef</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">]</span> <span class="o">*</span> <span class="mi">6</span> <span class="o">+</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">]</span> <span class="o">*</span> <span class="mi">6</span>
            <span class="n">panel_space_coef</span> <span class="o">=</span> <span class="p">(</span>
                <span class="p">[</span><span class="mf">1.0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">+</span> <span class="p">[</span><span class="mf">0.3</span><span class="p">]</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">+</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="mf">0.3</span><span class="p">]</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">+</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="n">plot_data_list</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">[</span><span class="s2">&quot;Ref_index&quot;</span><span class="p">,</span> <span class="n">df_bases_select</span><span class="o">.</span><span class="n">chr_index</span><span class="p">],</span>
                <span class="p">[</span><span class="s2">&quot;Target_seq&quot;</span><span class="p">,</span> <span class="n">target_seq_aln</span><span class="p">[</span><span class="n">plot_region</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">:</span> <span class="n">plot_region</span><span class="p">[</span><span class="mi">1</span><span class="p">]]],</span>
                <span class="p">[</span><span class="s2">&quot;Ref_seq&quot;</span><span class="p">,</span> <span class="n">df_bases_select</span><span class="o">.</span><span class="n">ref_base</span><span class="p">],</span>
                <span class="p">[</span><span class="s2">&quot;A&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">df_bases_select</span><span class="p">[</span><span class="s2">&quot;A&quot;</span><span class="p">])],</span>
                <span class="p">[</span><span class="s2">&quot;G&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">df_bases_select</span><span class="p">[</span><span class="s2">&quot;G&quot;</span><span class="p">])],</span>
                <span class="p">[</span><span class="s2">&quot;C&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">df_bases_select</span><span class="p">[</span><span class="s2">&quot;C&quot;</span><span class="p">])],</span>
                <span class="p">[</span><span class="s2">&quot;T&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">df_bases_select</span><span class="p">[</span><span class="s2">&quot;T&quot;</span><span class="p">])],</span>
                <span class="p">[</span><span class="s2">&quot;Del&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">df_bases_select</span><span class="p">[</span><span class="s2">&quot;del_count&quot;</span><span class="p">])],</span>
                <span class="p">[</span><span class="s2">&quot;Ins&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">df_bases_select</span><span class="p">[</span><span class="s2">&quot;insert_count&quot;</span><span class="p">])],</span>
                <span class="p">[</span><span class="s2">&quot;A %&quot;</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">df_bases_select</span><span class="p">[</span><span class="s2">&quot;A&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">base_sum_count</span><span class="p">)],</span>
                <span class="p">[</span><span class="s2">&quot;G %&quot;</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">df_bases_select</span><span class="p">[</span><span class="s2">&quot;G&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">base_sum_count</span><span class="p">)],</span>
                <span class="p">[</span><span class="s2">&quot;C %&quot;</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">df_bases_select</span><span class="p">[</span><span class="s2">&quot;C&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">base_sum_count</span><span class="p">)],</span>
                <span class="p">[</span><span class="s2">&quot;T %&quot;</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">df_bases_select</span><span class="p">[</span><span class="s2">&quot;T&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">base_sum_count</span><span class="p">)],</span>
                <span class="p">[</span><span class="s2">&quot;Del %&quot;</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">df_bases_select</span><span class="p">[</span><span class="s2">&quot;del_count&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">total_sum_count</span><span class="p">)],</span>
                <span class="p">[</span><span class="s2">&quot;Ins %&quot;</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">df_bases_select</span><span class="p">[</span><span class="s2">&quot;insert_count&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">total_sum_count</span><span class="p">)],</span>
            <span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">panel_height_coef</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">]</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">]</span> <span class="o">*</span> <span class="mi">4</span>
            <span class="n">panel_space_coef</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">+</span> <span class="p">[</span><span class="mf">0.3</span><span class="p">]</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">+</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="mf">0.3</span><span class="p">]</span> <span class="o">*</span> <span class="mi">3</span>
            <span class="n">plot_data_list</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">[</span><span class="s2">&quot;Ref_index&quot;</span><span class="p">,</span> <span class="n">df_bases_select</span><span class="o">.</span><span class="n">chr_index</span><span class="p">],</span>
                <span class="p">[</span><span class="s2">&quot;Target_seq&quot;</span><span class="p">,</span> <span class="n">target_seq_aln</span><span class="p">[</span><span class="n">plot_region</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">:</span> <span class="n">plot_region</span><span class="p">[</span><span class="mi">1</span><span class="p">]]],</span>
                <span class="p">[</span><span class="s2">&quot;Ref_seq&quot;</span><span class="p">,</span> <span class="n">df_bases_select</span><span class="o">.</span><span class="n">ref_base</span><span class="p">],</span>
                <span class="p">[</span><span class="s2">&quot;A&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">df_bases_select</span><span class="p">[</span><span class="s2">&quot;A&quot;</span><span class="p">])],</span>
                <span class="p">[</span><span class="s2">&quot;G&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">df_bases_select</span><span class="p">[</span><span class="s2">&quot;G&quot;</span><span class="p">])],</span>
                <span class="p">[</span><span class="s2">&quot;C&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">df_bases_select</span><span class="p">[</span><span class="s2">&quot;C&quot;</span><span class="p">])],</span>
                <span class="p">[</span><span class="s2">&quot;T&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">df_bases_select</span><span class="p">[</span><span class="s2">&quot;T&quot;</span><span class="p">])],</span>
                <span class="p">[</span><span class="s2">&quot;A %&quot;</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">df_bases_select</span><span class="p">[</span><span class="s2">&quot;A&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">base_sum_count</span><span class="p">)],</span>
                <span class="p">[</span><span class="s2">&quot;G %&quot;</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">df_bases_select</span><span class="p">[</span><span class="s2">&quot;G&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">base_sum_count</span><span class="p">)],</span>
                <span class="p">[</span><span class="s2">&quot;C %&quot;</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">df_bases_select</span><span class="p">[</span><span class="s2">&quot;C&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">base_sum_count</span><span class="p">)],</span>
                <span class="p">[</span><span class="s2">&quot;T %&quot;</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">df_bases_select</span><span class="p">[</span><span class="s2">&quot;T&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">base_sum_count</span><span class="p">)],</span>
            <span class="p">]</span>

        <span class="c1"># get box and space info</span>
        <span class="n">box_height_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">panel_height_coef</span><span class="p">)</span> <span class="o">*</span> <span class="n">panel_box_heigth</span>
        <span class="n">panel_space_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">panel_space_coef</span><span class="p">)</span> <span class="o">*</span> <span class="n">panel_space</span>
        <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;box_height_list = </span><span class="si">{</span><span class="n">box_height_list</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;panel_space_list = </span><span class="si">{</span><span class="n">panel_space_list</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># calculate figure total width and height</span>
        <span class="n">figure_width</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">total_box_count</span> <span class="o">*</span> <span class="n">panel_box_width</span>
            <span class="o">+</span> <span class="p">(</span><span class="n">total_box_count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">panel_box_space</span>
            <span class="o">+</span> <span class="n">panel_box_width</span> <span class="o">*</span> <span class="mi">2</span>
        <span class="p">)</span>
        <span class="n">figure_height</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">box_height_list</span><span class="p">)</span> <span class="o">+</span> <span class="nb">sum</span><span class="p">(</span><span class="n">panel_space_list</span><span class="p">)</span>

        <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;figure_width = </span><span class="si">{</span><span class="n">figure_width</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;figure_height = </span><span class="si">{</span><span class="n">figure_height</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># make all box_x</span>
        <span class="n">box_x_vec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span>
            <span class="mi">0</span><span class="p">,</span> <span class="n">figure_width</span> <span class="o">+</span> <span class="n">panel_box_width</span><span class="p">,</span> <span class="n">panel_box_width</span> <span class="o">+</span> <span class="n">panel_box_space</span>
        <span class="p">)</span>
        <span class="n">box_x_vec</span> <span class="o">=</span> <span class="n">box_x_vec</span><span class="p">[:</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ref_seq</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span>
        <span class="c1"># lm.logger.debug(f&#39;box_x_vec (x for each column) =\n{box_x_vec}&#39;)</span>

        <span class="c1"># make box border</span>
        <span class="k">if</span> <span class="n">box_border_plot_state</span><span class="p">:</span>
            <span class="n">box_edgecolor</span> <span class="o">=</span> <span class="s2">&quot;#AAAAAA&quot;</span>
            <span class="n">box_linestyle</span> <span class="o">=</span> <span class="s2">&quot;-&quot;</span>
            <span class="n">box_linewidth</span> <span class="o">=</span> <span class="mi">2</span>
            <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;box_border_plot_state = </span><span class="si">{</span><span class="n">box_border_plot_state</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;box_edgecolor = </span><span class="si">{</span><span class="n">box_edgecolor</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;box_linestyle = </span><span class="si">{</span><span class="n">box_linestyle</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;box_linewidth = </span><span class="si">{</span><span class="n">box_linewidth</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">box_edgecolor</span> <span class="o">=</span> <span class="s2">&quot;#FFFFFF&quot;</span>
            <span class="n">box_linestyle</span> <span class="o">=</span> <span class="s2">&quot;None&quot;</span>
            <span class="n">box_linewidth</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;box_border_plot_state = </span><span class="si">{</span><span class="n">box_border_plot_state</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;box_edgecolor = </span><span class="si">{</span><span class="n">box_edgecolor</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;box_linestyle = </span><span class="si">{</span><span class="n">box_linestyle</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;box_linewidth = </span><span class="si">{</span><span class="n">box_linewidth</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># make box_y initialize</span>
        <span class="n">current_y</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;start to plot&quot;</span><span class="p">)</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">figure_width</span> <span class="o">*</span> <span class="mf">1.1</span><span class="p">,</span> <span class="n">figure_height</span> <span class="o">*</span> <span class="mf">1.1</span><span class="p">))</span>
        <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;set new figure, figsize = (</span><span class="si">{</span><span class="n">figure_width</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">1.1</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">figure_height</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">1.1</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">set_loglevel</span><span class="p">(</span><span class="s2">&quot;info&quot;</span><span class="p">)</span>
        <span class="c1"># will show matplotlib debug log with logging</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="s2">&quot;equal&quot;</span><span class="p">)</span>
        <span class="c1"># will show matplotlib debug log with logging</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="n">figure_width</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">([</span><span class="o">-</span><span class="n">figure_height</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
        <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;plt.xlim([0, </span><span class="si">{</span><span class="n">figure_width</span><span class="si">}</span><span class="s2">])&quot;</span><span class="p">)</span>
        <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;plt.ylim([-</span><span class="si">{</span><span class="n">figure_height</span><span class="si">}</span><span class="s2">, 0])&quot;</span><span class="p">)</span>
        <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;plt.axis(&quot;off&quot;)&#39;</span><span class="p">)</span>

        <span class="c1"># make plot</span>
        <span class="n">text_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">patches</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">panel_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">panel_height_coef</span><span class="p">)):</span>
            <span class="c1"># panel name</span>
            <span class="n">panel_name</span> <span class="o">=</span> <span class="n">plot_data_list</span><span class="p">[</span><span class="n">panel_index</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">panel_name_x</span> <span class="o">=</span> <span class="n">box_x_vec</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">panel_name_y</span> <span class="o">=</span> <span class="n">current_y</span> <span class="o">-</span> <span class="n">box_height_list</span><span class="p">[</span><span class="n">panel_index</span><span class="p">]</span> <span class="o">*</span> <span class="mf">0.5</span>
            <span class="n">text_list</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">panel_name_x</span><span class="p">,</span> <span class="n">panel_name_y</span><span class="p">,</span> <span class="n">panel_name</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>

            <span class="c1"># plot panel box</span>
            <span class="k">if</span> <span class="n">panel_name</span> <span class="o">==</span> <span class="s2">&quot;Ref_index&quot;</span><span class="p">:</span>
                <span class="c1"># don&#39;t draw box, only add text</span>
                <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">box_value</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">plot_data_list</span><span class="p">[</span><span class="n">panel_index</span><span class="p">][</span><span class="mi">1</span><span class="p">]):</span>
                    <span class="n">box_x</span> <span class="o">=</span> <span class="n">box_x_vec</span><span class="p">[</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
                    <span class="n">text_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="p">(</span>
                            <span class="n">box_x</span> <span class="o">+</span> <span class="n">panel_box_width</span> <span class="o">*</span> <span class="mf">0.5</span><span class="p">,</span>
                            <span class="n">current_y</span> <span class="o">-</span> <span class="n">box_height_list</span><span class="p">[</span><span class="n">panel_index</span><span class="p">]</span> <span class="o">*</span> <span class="mf">0.5</span><span class="p">,</span>
                            <span class="nb">str</span><span class="p">(</span><span class="n">box_value</span><span class="p">),</span>
                            <span class="mi">7</span><span class="p">,</span>
                        <span class="p">),</span>
                    <span class="p">)</span>

                <span class="c1"># make next panel_y</span>
                <span class="n">current_y</span> <span class="o">=</span> <span class="n">current_y</span> <span class="o">-</span> <span class="p">(</span>
                    <span class="n">box_height_list</span><span class="p">[</span><span class="n">panel_index</span><span class="p">]</span> <span class="o">+</span> <span class="n">panel_space_list</span><span class="p">[</span><span class="n">panel_index</span><span class="p">]</span>
                <span class="p">)</span>

            <span class="k">elif</span> <span class="n">panel_name</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;Target_seq&quot;</span><span class="p">,</span> <span class="s2">&quot;Ref_seq&quot;</span><span class="p">]:</span>
                <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">box_value</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">plot_data_list</span><span class="p">[</span><span class="n">panel_index</span><span class="p">][</span><span class="mi">1</span><span class="p">]):</span>
                    <span class="k">if</span> <span class="n">box_value</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                        <span class="n">box_fill</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="n">box_color</span> <span class="o">=</span> <span class="s2">&quot;#FFFFFF&quot;</span>

                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="s2">&quot;Reverse&quot;</span> <span class="ow">in</span> <span class="n">aln_direction</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">panel_name</span> <span class="o">==</span> <span class="s2">&quot;Ref_seq&quot;</span><span class="p">:</span>
                                <span class="n">box_value</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                                    <span class="p">[</span><span class="n">DNA_rev_cmp_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">box_value</span><span class="p">]</span>
                                <span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="k">pass</span>

                            <span class="n">box_color</span> <span class="o">=</span> <span class="n">base_colors</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">box_value</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">box_color</span> <span class="o">=</span> <span class="n">base_colors</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">box_value</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

                        <span class="k">if</span> <span class="ow">not</span> <span class="n">box_color</span><span class="p">:</span>
                            <span class="n">box_fill</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="n">box_color</span> <span class="o">=</span> <span class="s2">&quot;#FFFFFF&quot;</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">box_fill</span> <span class="o">=</span> <span class="kc">True</span>

                    <span class="n">box_x</span> <span class="o">=</span> <span class="n">box_x_vec</span><span class="p">[</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>

                    <span class="n">patches</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="n">Rectangle</span><span class="p">(</span>
                            <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="n">box_x</span><span class="p">,</span> <span class="n">current_y</span> <span class="o">-</span> <span class="n">box_height_list</span><span class="p">[</span><span class="n">panel_index</span><span class="p">]),</span>
                            <span class="n">width</span><span class="o">=</span><span class="n">panel_box_width</span><span class="p">,</span>
                            <span class="n">height</span><span class="o">=</span><span class="n">box_height_list</span><span class="p">[</span><span class="n">panel_index</span><span class="p">],</span>
                            <span class="n">fill</span><span class="o">=</span><span class="n">box_fill</span><span class="p">,</span>
                            <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                            <span class="n">linestyle</span><span class="o">=</span><span class="n">box_linestyle</span><span class="p">,</span>
                            <span class="n">linewidth</span><span class="o">=</span><span class="n">box_linewidth</span><span class="p">,</span>
                            <span class="n">edgecolor</span><span class="o">=</span><span class="n">box_edgecolor</span><span class="p">,</span>
                            <span class="n">facecolor</span><span class="o">=</span><span class="n">box_color</span><span class="p">,</span>
                        <span class="p">),</span>
                    <span class="p">)</span>

                    <span class="c1"># text</span>
                    <span class="n">text_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="p">(</span>
                            <span class="n">box_x</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">panel_box_width</span><span class="p">,</span>
                            <span class="n">current_y</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">box_height_list</span><span class="p">[</span><span class="n">panel_index</span><span class="p">],</span>
                            <span class="nb">str</span><span class="p">(</span><span class="n">box_value</span><span class="p">),</span>
                            <span class="mi">16</span><span class="p">,</span>
                        <span class="p">),</span>
                    <span class="p">)</span>

                <span class="c1"># make next panel_y</span>
                <span class="n">current_y</span> <span class="o">=</span> <span class="n">current_y</span> <span class="o">-</span> <span class="p">(</span>
                    <span class="n">box_height_list</span><span class="p">[</span><span class="n">panel_index</span><span class="p">]</span> <span class="o">+</span> <span class="n">panel_space_list</span><span class="p">[</span><span class="n">panel_index</span><span class="p">]</span>
                <span class="p">)</span>

            <span class="k">elif</span> <span class="n">panel_name</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;A&quot;</span><span class="p">,</span> <span class="s2">&quot;G&quot;</span><span class="p">,</span> <span class="s2">&quot;C&quot;</span><span class="p">,</span> <span class="s2">&quot;T&quot;</span><span class="p">,</span> <span class="s2">&quot;Del&quot;</span><span class="p">,</span> <span class="s2">&quot;Ins&quot;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">panel_name</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;Del&quot;</span><span class="p">,</span> <span class="s2">&quot;Ins&quot;</span><span class="p">]:</span>
                    <span class="n">box_ratio</span> <span class="o">=</span> <span class="n">plot_data_list</span><span class="p">[</span><span class="n">panel_index</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">total_sum_count</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">box_ratio</span> <span class="o">=</span> <span class="n">plot_data_list</span><span class="p">[</span><span class="n">panel_index</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">base_sum_count</span>

                <span class="n">box_color_list</span> <span class="o">=</span> <span class="n">map_color</span><span class="p">(</span><span class="n">box_ratio</span><span class="p">,</span> <span class="n">color_break</span><span class="p">,</span> <span class="n">color_list</span><span class="p">)</span>
                <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;get box_color_list for </span><span class="si">{</span><span class="n">panel_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">box_value</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">plot_data_list</span><span class="p">[</span><span class="n">panel_index</span><span class="p">][</span><span class="mi">1</span><span class="p">]):</span>
                    <span class="n">box_color</span> <span class="o">=</span> <span class="n">box_color_list</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
                    <span class="n">box_x</span> <span class="o">=</span> <span class="n">box_x_vec</span><span class="p">[</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>

                    <span class="n">patches</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="n">Rectangle</span><span class="p">(</span>
                            <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="n">box_x</span><span class="p">,</span> <span class="n">current_y</span> <span class="o">-</span> <span class="n">box_height_list</span><span class="p">[</span><span class="n">panel_index</span><span class="p">]),</span>
                            <span class="n">width</span><span class="o">=</span><span class="n">panel_box_width</span><span class="p">,</span>
                            <span class="n">height</span><span class="o">=</span><span class="n">box_height_list</span><span class="p">[</span><span class="n">panel_index</span><span class="p">],</span>
                            <span class="n">fill</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                            <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                            <span class="n">linestyle</span><span class="o">=</span><span class="n">box_linestyle</span><span class="p">,</span>
                            <span class="n">linewidth</span><span class="o">=</span><span class="n">box_linewidth</span><span class="p">,</span>
                            <span class="n">edgecolor</span><span class="o">=</span><span class="n">box_edgecolor</span><span class="p">,</span>
                            <span class="n">facecolor</span><span class="o">=</span><span class="n">box_color</span><span class="p">,</span>
                        <span class="p">),</span>
                    <span class="p">)</span>

                    <span class="c1"># text</span>
                    <span class="n">text_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="p">(</span>
                            <span class="n">box_x</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">panel_box_width</span><span class="p">,</span>
                            <span class="n">current_y</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">box_height_list</span><span class="p">[</span><span class="n">panel_index</span><span class="p">],</span>
                            <span class="nb">str</span><span class="p">(</span><span class="n">box_value</span><span class="p">),</span>
                            <span class="mi">6</span><span class="p">,</span>
                        <span class="p">),</span>
                    <span class="p">)</span>

                <span class="c1"># make next panel_y</span>
                <span class="n">current_y</span> <span class="o">=</span> <span class="n">current_y</span> <span class="o">-</span> <span class="p">(</span>
                    <span class="n">box_height_list</span><span class="p">[</span><span class="n">panel_index</span><span class="p">]</span> <span class="o">+</span> <span class="n">panel_space_list</span><span class="p">[</span><span class="n">panel_index</span><span class="p">]</span>
                <span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">box_color_list</span> <span class="o">=</span> <span class="n">map_color</span><span class="p">(</span>
                    <span class="n">plot_data_list</span><span class="p">[</span><span class="n">panel_index</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">color_break</span><span class="p">,</span> <span class="n">color_list</span>
                <span class="p">)</span>
                <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">box_value</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">plot_data_list</span><span class="p">[</span><span class="n">panel_index</span><span class="p">][</span><span class="mi">1</span><span class="p">]):</span>
                    <span class="n">box_color</span> <span class="o">=</span> <span class="n">box_color_list</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
                    <span class="n">box_x</span> <span class="o">=</span> <span class="n">box_x_vec</span><span class="p">[</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>

                    <span class="n">patches</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="n">Rectangle</span><span class="p">(</span>
                            <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="n">box_x</span><span class="p">,</span> <span class="n">current_y</span> <span class="o">-</span> <span class="n">box_height_list</span><span class="p">[</span><span class="n">panel_index</span><span class="p">]),</span>
                            <span class="n">width</span><span class="o">=</span><span class="n">panel_box_width</span><span class="p">,</span>
                            <span class="n">height</span><span class="o">=</span><span class="n">box_height_list</span><span class="p">[</span><span class="n">panel_index</span><span class="p">],</span>
                            <span class="n">fill</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                            <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                            <span class="n">linestyle</span><span class="o">=</span><span class="n">box_linestyle</span><span class="p">,</span>
                            <span class="n">linewidth</span><span class="o">=</span><span class="n">box_linewidth</span><span class="p">,</span>
                            <span class="n">edgecolor</span><span class="o">=</span><span class="n">box_edgecolor</span><span class="p">,</span>
                            <span class="n">facecolor</span><span class="o">=</span><span class="n">box_color</span><span class="p">,</span>
                        <span class="p">),</span>
                    <span class="p">)</span>

                    <span class="c1"># text</span>
                    <span class="n">text_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="p">(</span>
                            <span class="n">box_x</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">panel_box_width</span><span class="p">,</span>
                            <span class="n">current_y</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">box_height_list</span><span class="p">[</span><span class="n">panel_index</span><span class="p">],</span>
                            <span class="nb">round</span><span class="p">(</span><span class="n">box_value</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
                            <span class="mi">6</span><span class="p">,</span>
                        <span class="p">),</span>
                    <span class="p">)</span>

                <span class="c1"># make next panel_y</span>
                <span class="k">if</span> <span class="n">panel_index</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">panel_space_list</span><span class="p">):</span>
                    <span class="n">current_y</span> <span class="o">=</span> <span class="n">current_y</span> <span class="o">-</span> <span class="p">(</span>
                        <span class="n">box_height_list</span><span class="p">[</span><span class="n">panel_index</span><span class="p">]</span> <span class="o">+</span> <span class="n">panel_space_list</span><span class="p">[</span><span class="n">panel_index</span><span class="p">]</span>
                    <span class="p">)</span>

        <span class="c1"># plot box</span>
        <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;plot rectangles&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">add_collection</span><span class="p">(</span><span class="n">PatchCollection</span><span class="p">(</span><span class="n">patches</span><span class="p">,</span> <span class="n">match_original</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>

        <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;plot text on each rectangle&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">text_x</span><span class="p">,</span> <span class="n">text_y</span><span class="p">,</span> <span class="n">text_info</span><span class="p">,</span> <span class="n">text_fontsize</span> <span class="ow">in</span> <span class="n">text_list</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
                <span class="n">x</span><span class="o">=</span><span class="n">text_x</span><span class="p">,</span>
                <span class="n">y</span><span class="o">=</span><span class="n">text_y</span><span class="p">,</span>
                <span class="n">s</span><span class="o">=</span><span class="n">text_info</span><span class="p">,</span>
                <span class="n">horizontalalignment</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
                <span class="n">verticalalignment</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
                <span class="n">fontsize</span><span class="o">=</span><span class="n">text_fontsize</span><span class="p">,</span>
                <span class="n">fontname</span><span class="o">=</span><span class="s2">&quot;Arial&quot;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="c1"># output plot</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span>
            <span class="n">fname</span><span class="o">=</span><span class="n">output_fig</span><span class="p">,</span>
            <span class="n">bbox_inches</span><span class="o">=</span><span class="s2">&quot;tight&quot;</span><span class="p">,</span>
            <span class="n">dpi</span><span class="o">=</span><span class="n">output_fig_dpi</span><span class="p">,</span>
            <span class="nb">format</span><span class="o">=</span><span class="n">output_fig_fmt</span><span class="p">,</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="TargetSeq.region_heatmap_compare">
<a class="viewcode-back" href="../../bioat.html#bioat.target_seq.TargetSeq.region_heatmap_compare">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">region_heatmap_compare</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">input_tables</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">labels</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">target_seq</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># sgRNA</span>
        <span class="n">reference_seq</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># target locus</span>
        <span class="n">output_fig_heatmap</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">output_fig_count_ratio</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">output_table_heatmap</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">output_table_count_ratio</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">output_fig_fmt</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;pdf&quot;</span><span class="p">,</span>
        <span class="n">input_table_header</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">to_base</span><span class="p">:</span> <span class="nb">tuple</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;A&quot;</span><span class="p">,</span> <span class="s2">&quot;G&quot;</span><span class="p">,</span> <span class="s2">&quot;C&quot;</span><span class="p">,</span> <span class="s2">&quot;T&quot;</span><span class="p">,</span> <span class="s2">&quot;Ins&quot;</span><span class="p">,</span> <span class="s2">&quot;Del&quot;</span><span class="p">),</span>
        <span class="n">heatmap_mut_direction</span><span class="p">:</span> <span class="nb">tuple</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;CT&quot;</span><span class="p">,</span> <span class="s2">&quot;GA&quot;</span><span class="p">),</span>
        <span class="n">count_ratio</span><span class="o">=</span><span class="s2">&quot;all&quot;</span><span class="p">,</span>
        <span class="n">region_extend_length</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
        <span class="n">output_fig_dpi</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
        <span class="n">show_indel</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">show_index</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">block_ref</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">box_border</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">box_space</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.03</span><span class="p">,</span>
        <span class="n">min_color</span><span class="p">:</span> <span class="nb">tuple</span> <span class="o">=</span> <span class="p">(</span><span class="mi">250</span><span class="p">,</span> <span class="mi">239</span><span class="p">,</span> <span class="mi">230</span><span class="p">),</span>
        <span class="n">max_color</span><span class="p">:</span> <span class="nb">tuple</span> <span class="o">=</span> <span class="p">(</span><span class="mi">154</span><span class="p">,</span> <span class="mi">104</span><span class="p">,</span> <span class="mi">57</span><span class="p">),</span>
        <span class="n">min_ratio</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.001</span><span class="p">,</span>
        <span class="n">max_ratio</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.99</span><span class="p">,</span>
        <span class="n">local_alignment_scoring_matrix</span><span class="p">:</span> <span class="nb">tuple</span> <span class="o">=</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="o">-</span><span class="mi">4</span><span class="p">,</span> <span class="o">-</span><span class="mi">24</span><span class="p">,</span> <span class="o">-</span><span class="mi">8</span><span class="p">),</span>
        <span class="n">local_alignment_min_score</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">15</span><span class="p">,</span>
        <span class="n">PAM_priority_weight</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
        <span class="n">get_built_in_target_seq</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">log_level</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;INFO&quot;</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Plot region mutation information for multiple conditions.</span>

<span class="sd">        This function generates a comparison of mutation information across multiple conditions</span>
<span class="sd">        using tables generated by `bioat bam mpileup_to_table`.</span>

<span class="sd">        Args:</span>
<span class="sd">            input_tables (str):</span>
<span class="sd">                Paths to input tables generated by `bioat bam mpileup_to_table`, separated by commas.</span>
<span class="sd">                Each table should contain mutation information for a short genomic region (≤1k nt).</span>
<span class="sd">            labels (str):</span>
<span class="sd">                Labels for the panels, separated by commas.</span>
<span class="sd">            target_seq (str, optional):</span>
<span class="sd">                Sequence to align against the reference sequence in `mpileup.table`. Examples:</span>

<span class="sd">                    - &#39;GAGTCCGAGCAGAAGAAGAA^GGG^&#39; for SpCas9-BE (PAM: ^GGG^).</span>
<span class="sd">                    - &#39;^TTTA^GCCCCAATAATCCCCACATGTCA&#39; for cpf1-BE (PAM: ^TTTA^).</span>
<span class="sd">                    - &#39;TGCTAGTAACCACGTTCTCCTGATCAAATATCACTCTCCTACTTACAGGA&#39; for no PAM.</span>

<span class="sd">                Defaults to None.</span>
<span class="sd">            reference_seq (str, optional):</span>
<span class="sd">                Custom reference sequence to overwrite the one in `mpileup.table`.</span>
<span class="sd">                Can be a FASTA file or a DNA sequence. Defaults to None.</span>
<span class="sd">            output_fig_heatmap (str, optional):</span>
<span class="sd">                Path to the heatmap output figure. Defaults to None.</span>
<span class="sd">            output_fig_count_ratio (str, optional):</span>
<span class="sd">                Path to the count/ratio output figure. Defaults to None.</span>
<span class="sd">            output_table_heatmap (str, optional):</span>
<span class="sd">                Path to the heatmap output table. Defaults to None.</span>
<span class="sd">            output_table_count_ratio (str, optional):</span>
<span class="sd">                Path to the count/ratio output table. Defaults to None.</span>
<span class="sd">            output_fig_fmt (str, optional):</span>
<span class="sd">                Format of the output figures, either &quot;pdf&quot; or &quot;png&quot;. Defaults to &quot;pdf&quot;.</span>
<span class="sd">            input_table_header (bool, optional):</span>
<span class="sd">                Whether the input tables have headers. Defaults to True.</span>
<span class="sd">            to_base (str, optional):</span>
<span class="sd">                Reference bases to convert to, separated by commas. Defaults to &quot;A,G,C,T,Ins,Del&quot;.</span>
<span class="sd">            heatmap_mut_direction (str, optional):</span>
<span class="sd">                Mutation directions to plot, specified as [from Base][to Base], separated by commas.</span>
<span class="sd">                Defaults to &quot;CT,GA&quot;.</span>
<span class="sd">            count_ratio (str, optional):</span>
<span class="sd">                Type of plot to generate: &quot;count&quot;, &quot;ratio&quot;, or &quot;all&quot;. Defaults to &quot;all&quot;.</span>
<span class="sd">            region_extend_length (int, optional):</span>
<span class="sd">                Number of base pairs to extend on both sides of the region. Defaults to 0.</span>
<span class="sd">            output_fig_dpi (int, optional):</span>
<span class="sd">                DPI for the output figures. Defaults to 300.</span>
<span class="sd">            show_indel (bool, optional):</span>
<span class="sd">                Whether to show indel information in the output figures. Defaults to True.</span>
<span class="sd">            show_index (bool, optional):</span>
<span class="sd">                Whether to display index information in the output figures. Defaults to True.</span>
<span class="sd">            block_ref (bool, optional):</span>
<span class="sd">                Whether to hide colors for reference sites in the output figures. Defaults to True.</span>
<span class="sd">            box_border (bool, optional):</span>
<span class="sd">                Whether to display box borders in the output figures. Defaults to True.</span>
<span class="sd">            box_space (int, optional):</span>
<span class="sd">                Space size between two boxes in the heatmap. Defaults to 1.</span>
<span class="sd">            min_color (tuple, optional):</span>
<span class="sd">                Minimum color for the heatmap in RGB format. Defaults to (255, 255, 255).</span>
<span class="sd">            max_color (tuple, optional):</span>
<span class="sd">                Maximum color for the heatmap in RGB format. Defaults to (0, 0, 0).</span>
<span class="sd">            min_ratio (float, optional):</span>
<span class="sd">                Mutation ratios below this value will appear white. Defaults to 0.0.</span>
<span class="sd">            max_ratio (float, optional):</span>
<span class="sd">                Mutation ratios above this value will be capped. Defaults to 1.0.</span>
<span class="sd">            local_alignment_scoring_matrix (tuple, optional):</span>
<span class="sd">                Alignment scoring parameters as a tuple:</span>
<span class="sd">                (&lt;align_match_score&gt;, &lt;align_mismatch_score&gt;, &lt;align_gap_open_score&gt;, &lt;align_gap_extension_score&gt;).</span>
<span class="sd">                Defaults to None.</span>
<span class="sd">            local_alignment_min_score (int, optional):</span>
<span class="sd">                Minimum alignment score to consider as a valid alignment. Defaults to 0.</span>
<span class="sd">            PAM_priority_weight (float, optional):</span>
<span class="sd">                Weight multiplier for PAM alignment scores. Defaults to 1.0.</span>
<span class="sd">            get_built_in_target_seq (bool, optional):</span>
<span class="sd">                Set to True to return built-in target sequence information. Defaults to False.</span>
<span class="sd">            log_level (str, optional):</span>
<span class="sd">                Logging level. One of &#39;CRITICAL&#39;, &#39;ERROR&#39;, &#39;WARNING&#39;, &#39;INFO&#39;, &#39;DEBUG&#39;, &#39;NOTSET&#39;. Defaults to &quot;INFO&quot;.</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>

<span class="sd">        Examples:</span>
<span class="sd">            &gt;&gt;&gt; # Generate mutation tables</span>
<span class="sd">            &gt;&gt;&gt; samtools mpileup test_sorted.bam --reference HK4-AOut-1.ref.upper.fa | gzip &gt; test_sorted.mpileup.gz</span>
<span class="sd">            &gt;&gt;&gt; bioat bam mpileup_to_table test_sorted.mpileup.gz &gt; test_sorted.mpileup.info1.tsv</span>
<span class="sd">            &gt;&gt;&gt; bioat bam mpileup_to_table test_sorted.mpileup.gz &gt; test_sorted.mpileup.info2.tsv</span>
<span class="sd">            &gt;&gt;&gt; bioat bam mpileup_to_table test_sorted.mpileup.gz &gt; test_sorted.mpileup.info3.tsv</span>
<span class="sd">            &gt;&gt;&gt; # Generate region heatmap comparison</span>
<span class="sd">            &gt;&gt;&gt; bioat target_seq region_heatmap_compare --input_tables test_sorted.mpileup.info1.tsv,test_sorted.mpileup.info2.tsv,test_sorted.mpileup.info3.tsv --labels condition1,condition2,condition3 --target_seq HEK4</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">lm</span><span class="o">.</span><span class="n">set_names</span><span class="p">(</span><span class="n">func_name</span><span class="o">=</span><span class="s2">&quot;region_heatmap_compare&quot;</span><span class="p">)</span>
        <span class="n">lm</span><span class="o">.</span><span class="n">set_level</span><span class="p">(</span><span class="n">log_level</span><span class="p">)</span>

        <span class="n">base_color_dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;A&quot;</span><span class="p">:</span> <span class="s2">&quot;#04E3E3&quot;</span><span class="p">,</span>
            <span class="s2">&quot;T&quot;</span><span class="p">:</span> <span class="s2">&quot;#F9B874&quot;</span><span class="p">,</span>
            <span class="s2">&quot;C&quot;</span><span class="p">:</span> <span class="s2">&quot;#B9E76B&quot;</span><span class="p">,</span>
            <span class="s2">&quot;G&quot;</span><span class="p">:</span> <span class="s2">&quot;#F53798&quot;</span><span class="p">,</span>
            <span class="s2">&quot;N&quot;</span><span class="p">:</span> <span class="s2">&quot;#DDEAF6&quot;</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">plot_agct</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>  <span class="c1"># target_seq sgRNA左右没align的位置给空值</span>
                <span class="k">return</span> <span class="s2">&quot;#FFFFFF&quot;</span>
            <span class="k">if</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;A&quot;</span><span class="p">,</span> <span class="s2">&quot;G&quot;</span><span class="p">,</span> <span class="s2">&quot;C&quot;</span><span class="p">,</span> <span class="s2">&quot;T&quot;</span><span class="p">,</span> <span class="s2">&quot;N&quot;</span><span class="p">]:</span>
                <span class="k">return</span> <span class="n">base_color_dict</span><span class="p">[</span><span class="n">x</span><span class="p">]</span>
            <span class="k">return</span> <span class="s2">&quot;#AAAAAA&quot;</span>

        <span class="c1"># check whether return built-in information</span>
        <span class="k">if</span> <span class="n">get_built_in_target_seq</span><span class="p">:</span>
            <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;You can use &lt;key&gt; in built-in &lt;target_seq&gt; to represent your target_seq:</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&lt;key&gt;</span><span class="se">\t</span><span class="s2">&lt;target_seq&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="se">\t</span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">TARGET_SEQ_LIB</span><span class="o">.</span><span class="n">items</span><span class="p">()]),</span>
            <span class="p">)</span>
            <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;exit because of the defination for get_built_in_target_seq&quot;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># set target_seq(sgRNA) info</span>
            <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;load target_seq = </span><span class="si">{</span><span class="n">target_seq</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">target_seq</span> <span class="ow">in</span> <span class="n">TARGET_SEQ_LIB</span><span class="p">:</span>
                <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;target_seq information is abtained from the &lt;key&gt;=</span><span class="si">{</span><span class="n">target_seq</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">target_seq</span> <span class="o">=</span> <span class="n">TARGET_SEQ_LIB</span><span class="p">[</span><span class="n">target_seq</span><span class="p">]</span>
                <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;target_seq is refered to </span><span class="si">{</span><span class="n">target_seq</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">target_seq</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">target_seq</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;target_seq is refered to </span><span class="si">{</span><span class="n">target_seq</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="s2">&quot;&lt;target_seq&gt; should be set as:&quot;</span>
                    <span class="s2">&quot;DNA sequence / &lt;key&gt; in &lt;get_built_in_target_seq&gt; / None,&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;but your &lt;target_seq&gt; is </span><span class="si">{</span><span class="n">target_seq</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1"># check if nothing to output</span>
        <span class="n">outputs</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">output_fig_heatmap</span><span class="p">,</span>
            <span class="n">output_fig_count_ratio</span><span class="p">,</span>
            <span class="n">output_table_heatmap</span><span class="p">,</span>
            <span class="n">output_table_count_ratio</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">outputs</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]:</span>
            <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s2">&quot;outputs should be set as free combination of (output_fig_heatmap, output_fig_count_ratio, &quot;</span>
                <span class="s2">&quot;output_table_heatmap, output_table_count_ratio), but none of outputs was defined&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1"># check parameter: to_base</span>
        <span class="c1"># check to_base:  tuple for A G C T Ins Del or combine like A G T Ins</span>
        <span class="n">default_bases</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;A&quot;</span><span class="p">,</span> <span class="s2">&quot;G&quot;</span><span class="p">,</span> <span class="s2">&quot;C&quot;</span><span class="p">,</span> <span class="s2">&quot;T&quot;</span><span class="p">,</span> <span class="s2">&quot;Ins&quot;</span><span class="p">,</span> <span class="s2">&quot;Del&quot;</span><span class="p">)</span>
        <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;check to_base parameter&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">base</span> <span class="ow">in</span> <span class="n">to_base</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">base</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">default_bases</span><span class="p">:</span>
                <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;check to_base parameter&quot;</span><span class="p">)</span>
                <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">base</span><span class="si">}</span><span class="s2"> not in </span><span class="si">{</span><span class="n">default_bases</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">BioatInvalidOptionError</span>
        <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;to_base was defined as </span><span class="si">{</span><span class="n">to_base</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># check parameter: count_ratio</span>
        <span class="n">default_count_ratio_choices</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;count&quot;</span><span class="p">,</span> <span class="s2">&quot;ratio&quot;</span><span class="p">,</span> <span class="s2">&quot;all&quot;</span><span class="p">)</span>
        <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;check count_ratio parameter&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">count_ratio</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">default_count_ratio_choices</span><span class="p">:</span>
            <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;check count_ratio parameter&quot;</span><span class="p">)</span>
            <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">count_ratio</span><span class="si">}</span><span class="s2"> not in </span><span class="si">{</span><span class="n">default_count_ratio_choices</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">BioatInvalidOptionError</span>
        <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;count_ratio was defined as </span><span class="si">{</span><span class="n">count_ratio</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># parse parameter: input_tables</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">input_tables</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
            <span class="n">input_tables</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">input_tables</span><span class="p">]</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">input_tables</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">input_tables</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">input_tables</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">BioatInvalidInputError</span>
        <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;parse tables... </span><span class="si">{</span><span class="n">input_tables</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># parse parameter: labels, if labels is None, labels value will be input_tables names</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">labels</span><span class="p">]</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">labels</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">labels</span>
                <span class="k">else</span> <span class="n">input_tables</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">BioatInvalidInputError</span>
        <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;parse labels... </span><span class="si">{</span><span class="n">labels</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># set alignment</span>
        <span class="n">aligner</span> <span class="o">=</span> <span class="n">instantiate_pairwise_aligner</span><span class="p">(</span><span class="o">*</span><span class="n">local_alignment_scoring_matrix</span><span class="p">)</span>

        <span class="c1"># load &amp; merge bmat files &amp; set treatment names</span>
        <span class="n">ls</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">input_table</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">input_tables</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
            <span class="n">df</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">input_table</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">input_table_header</span>
                <span class="k">else</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">input_table</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">df</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">label</span>
            <span class="n">ls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        <span class="n">df_bases</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">ls</span><span class="p">)</span>
        <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;df_bases.head(10):</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="o">+</span> <span class="n">tabulate</span><span class="p">(</span><span class="n">df_bases</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span> <span class="n">headers</span><span class="o">=</span><span class="s2">&quot;keys&quot;</span><span class="p">,</span> <span class="n">tablefmt</span><span class="o">=</span><span class="s2">&quot;psql&quot;</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="c1"># parse parameter: reference_seq, if reference_seq is None, reference_seq value will be derived from df_bases</span>
        <span class="k">if</span> <span class="n">reference_seq</span><span class="p">:</span>
            <span class="c1"># fa file or seq str to seq str</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">reference_seq</span><span class="p">):</span>
                <span class="n">f</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="nb">open</span><span class="p">(</span><span class="n">reference_seq</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">reference_seq</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.gz&quot;</span><span class="p">)</span>
                    <span class="k">else</span> <span class="n">gzip</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">reference_seq</span><span class="p">,</span> <span class="s2">&quot;rt&quot;</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="n">reference_seq</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">i</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()[</span><span class="mi">1</span><span class="p">:]])</span>
                <span class="k">if</span> <span class="n">reference_seq</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s2">&quot;&gt;&quot;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">BioatFileFormatError</span>

            <span class="n">ref_seq</span> <span class="o">=</span> <span class="n">Seq</span><span class="p">(</span><span class="n">reference_seq</span><span class="p">)</span>
            <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;load ref_seq from parameter:</span><span class="se">\n</span><span class="si">{</span><span class="n">ref_seq</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ref_seq</span> <span class="o">=</span> <span class="n">Seq</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">df_bases</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;label==@labels[0]&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">ref_base</span><span class="p">))</span>
            <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;load ref_seq from df_bases.ref_base:</span><span class="se">\n</span><span class="si">{</span><span class="n">ref_seq</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Seq object for ref_seq:</span><span class="se">\n</span><span class="si">{</span><span class="n">ref_seq</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">ref_seq_rc</span> <span class="o">=</span> <span class="n">ref_seq</span><span class="o">.</span><span class="n">reverse_complement</span><span class="p">()</span>
        <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Seq object for ref_seq_rc (reverse_complement):</span><span class="se">\n</span><span class="si">{</span><span class="n">ref_seq_rc</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># parse parameter: target_seq</span>
        <span class="k">if</span> <span class="n">target_seq</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">target_seq</span> <span class="o">=</span> <span class="n">ref_seq</span>
            <span class="n">PAM</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">elif</span> <span class="s2">&quot;^&quot;</span> <span class="ow">in</span> <span class="n">target_seq</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">target_seq</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;^&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">PAM</span><span class="p">,</span> <span class="n">target_seq</span> <span class="o">=</span> <span class="n">target_seq</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;^&quot;</span><span class="p">)</span>
                <span class="n">target_seq</span> <span class="o">=</span> <span class="n">Seq</span><span class="p">(</span><span class="n">target_seq</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>
                <span class="n">PAM</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;PAM&quot;</span><span class="p">:</span> <span class="n">PAM</span><span class="p">,</span> <span class="s2">&quot;position&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;weight&quot;</span><span class="p">:</span> <span class="n">PAM_priority_weight</span><span class="p">}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">target_seq</span><span class="p">,</span> <span class="n">PAM</span> <span class="o">=</span> <span class="n">target_seq</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;^&quot;</span><span class="p">)</span>
                <span class="n">target_seq</span> <span class="o">=</span> <span class="n">Seq</span><span class="p">(</span><span class="n">target_seq</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>
                <span class="n">PAM</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;PAM&quot;</span><span class="p">:</span> <span class="n">PAM</span><span class="p">,</span>
                    <span class="s2">&quot;position&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">target_seq</span><span class="p">),</span>
                    <span class="s2">&quot;weight&quot;</span><span class="p">:</span> <span class="n">PAM_priority_weight</span><span class="p">,</span>
                <span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;no PAM sequence is defined from target_seq = </span><span class="si">{</span><span class="n">target_seq</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">target_seq</span> <span class="o">=</span> <span class="n">Seq</span><span class="p">(</span><span class="n">target_seq</span><span class="p">)</span>
            <span class="n">PAM</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;parse target_seq: target_seq=</span><span class="si">{</span><span class="n">target_seq</span><span class="si">}</span><span class="s2">, PAM=</span><span class="si">{</span><span class="n">PAM</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># fwd alignment &amp; rev alignment</span>
        <span class="c1"># 为了判断target_seq (sgRNA) 是设计在fwd还是rev链上</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">PAM</span><span class="p">:</span>
            <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;use PAMless mode to align&quot;</span><span class="p">)</span>
            <span class="n">fwd</span> <span class="o">=</span> <span class="n">run_target_seq_align</span><span class="p">(</span><span class="n">ref_seq</span><span class="p">,</span> <span class="n">target_seq</span><span class="p">,</span> <span class="n">aligner</span><span class="p">)</span>
            <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;final_align_forward:</span><span class="se">\n</span><span class="si">{</span><span class="n">fwd</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">rev</span> <span class="o">=</span> <span class="n">run_target_seq_align</span><span class="p">(</span><span class="n">ref_seq_rc</span><span class="p">,</span> <span class="n">target_seq</span><span class="p">,</span> <span class="n">aligner</span><span class="p">)</span>
            <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;final_align_reverse:</span><span class="se">\n</span><span class="si">{</span><span class="n">rev</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;use PAM mode to align&quot;</span><span class="p">)</span>
            <span class="n">fwd</span> <span class="o">=</span> <span class="n">run_target_seq_align</span><span class="p">(</span><span class="n">ref_seq</span><span class="p">,</span> <span class="n">target_seq</span><span class="p">,</span> <span class="n">aligner</span><span class="p">,</span> <span class="n">PAM</span><span class="o">=</span><span class="n">PAM</span><span class="p">)</span>
            <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;final_align_forward:</span><span class="se">\n</span><span class="si">{</span><span class="n">fwd</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">rev</span> <span class="o">=</span> <span class="n">run_target_seq_align</span><span class="p">(</span><span class="n">ref_seq_rc</span><span class="p">,</span> <span class="n">target_seq</span><span class="p">,</span> <span class="n">aligner</span><span class="p">,</span> <span class="n">PAM</span><span class="o">=</span><span class="n">PAM</span><span class="p">)</span>
            <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;final_align_reverse:</span><span class="se">\n</span><span class="si">{</span><span class="n">rev</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># get fwd alignment info</span>
        <span class="n">reference_seq</span> <span class="o">=</span> <span class="n">fwd</span><span class="p">[</span><span class="s2">&quot;alignment&quot;</span><span class="p">][</span><span class="s2">&quot;reference_seq&quot;</span><span class="p">][</span>
            <span class="n">fwd</span><span class="p">[</span><span class="s2">&quot;ref_aln_start&quot;</span><span class="p">]</span> <span class="p">:</span> <span class="n">fwd</span><span class="p">[</span><span class="s2">&quot;ref_aln_end&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="p">]</span>
        <span class="n">align_info</span> <span class="o">=</span> <span class="n">fwd</span><span class="p">[</span><span class="s2">&quot;alignment&quot;</span><span class="p">][</span><span class="s2">&quot;aln_info&quot;</span><span class="p">][</span>
            <span class="n">fwd</span><span class="p">[</span><span class="s2">&quot;ref_aln_start&quot;</span><span class="p">]</span> <span class="p">:</span> <span class="n">fwd</span><span class="p">[</span><span class="s2">&quot;ref_aln_end&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="p">]</span>
        <span class="n">target_seq</span> <span class="o">=</span> <span class="n">fwd</span><span class="p">[</span><span class="s2">&quot;alignment&quot;</span><span class="p">][</span><span class="s2">&quot;target_seq&quot;</span><span class="p">][</span>
            <span class="n">fwd</span><span class="p">[</span><span class="s2">&quot;ref_aln_start&quot;</span><span class="p">]</span> <span class="p">:</span> <span class="n">fwd</span><span class="p">[</span><span class="s2">&quot;ref_aln_end&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="p">]</span>
        <span class="n">aln_score</span> <span class="o">=</span> <span class="n">fwd</span><span class="p">[</span><span class="s2">&quot;aln_score&quot;</span><span class="p">]</span>
        <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Forward best alignment:</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;reference  : </span><span class="si">{</span><span class="n">reference_seq</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;align_info : </span><span class="si">{</span><span class="n">align_info</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;target_seq : </span><span class="si">{</span><span class="n">target_seq</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;align_score: </span><span class="si">{</span><span class="n">aln_score</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># get rev alignment info</span>
        <span class="n">reference_seq_rev</span> <span class="o">=</span> <span class="n">rev</span><span class="p">[</span><span class="s2">&quot;alignment&quot;</span><span class="p">][</span><span class="s2">&quot;reference_seq&quot;</span><span class="p">][</span>
            <span class="n">rev</span><span class="p">[</span><span class="s2">&quot;ref_aln_start&quot;</span><span class="p">]</span> <span class="p">:</span> <span class="n">rev</span><span class="p">[</span><span class="s2">&quot;ref_aln_end&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="p">]</span>
        <span class="n">align_info_rev</span> <span class="o">=</span> <span class="n">rev</span><span class="p">[</span><span class="s2">&quot;alignment&quot;</span><span class="p">][</span><span class="s2">&quot;aln_info&quot;</span><span class="p">][</span>
            <span class="n">rev</span><span class="p">[</span><span class="s2">&quot;ref_aln_start&quot;</span><span class="p">]</span> <span class="p">:</span> <span class="n">rev</span><span class="p">[</span><span class="s2">&quot;ref_aln_end&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="p">]</span>
        <span class="n">target_seq_rev</span> <span class="o">=</span> <span class="n">rev</span><span class="p">[</span><span class="s2">&quot;alignment&quot;</span><span class="p">][</span><span class="s2">&quot;target_seq&quot;</span><span class="p">][</span>
            <span class="n">rev</span><span class="p">[</span><span class="s2">&quot;ref_aln_start&quot;</span><span class="p">]</span> <span class="p">:</span> <span class="n">rev</span><span class="p">[</span><span class="s2">&quot;ref_aln_end&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="p">]</span>
        <span class="n">aln_score_rev</span> <span class="o">=</span> <span class="n">rev</span><span class="p">[</span><span class="s2">&quot;aln_score&quot;</span><span class="p">]</span>
        <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Reverse best alignment:</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;reference  : </span><span class="si">{</span><span class="n">reference_seq_rev</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;align_info : </span><span class="si">{</span><span class="n">align_info_rev</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;target_seq : </span><span class="si">{</span><span class="n">target_seq_rev</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;align_score: </span><span class="si">{</span><span class="n">aln_score_rev</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># define align direction and final align res</span>
        <span class="c1"># make alignment info</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span>
            <span class="n">x</span> <span class="o">&gt;=</span> <span class="n">local_alignment_min_score</span>
                <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">(</span><span class="n">fwd</span><span class="p">[</span><span class="s2">&quot;aln_score&quot;</span><span class="p">],</span> <span class="n">rev</span><span class="p">[</span><span class="s2">&quot;aln_score&quot;</span><span class="p">])</span>
        <span class="p">):</span>
            <span class="k">if</span> <span class="n">fwd</span><span class="p">[</span><span class="s2">&quot;aln_score&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">rev</span><span class="p">[</span><span class="s2">&quot;aln_score&quot;</span><span class="p">]:</span>
                <span class="n">aln_direction</span> <span class="o">=</span> <span class="s2">&quot;Forward Alignment&quot;</span>
                <span class="n">aln</span> <span class="o">=</span> <span class="n">fwd</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">aln_direction</span> <span class="o">=</span> <span class="s2">&quot;Reverse Alignment&quot;</span>
                <span class="n">aln</span> <span class="o">=</span> <span class="n">rev</span>
                <span class="n">reference_seq</span> <span class="o">=</span> <span class="n">reference_seq_rev</span>
                <span class="n">align_info</span> <span class="o">=</span> <span class="n">align_info_rev</span>
                <span class="n">target_seq</span> <span class="o">=</span> <span class="n">target_seq_rev</span>
                <span class="n">aln_score</span> <span class="o">=</span> <span class="n">aln_score_rev</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s2">&quot;Alignment Error!&quot;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># mark aligned all bases in target_seq</span>
        <span class="n">ref_seq_length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ref_seq</span><span class="p">)</span>
        <span class="n">target_seq_aln</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">ref_seq_length</span>
        <span class="c1"># mark inserted bases in target_seq</span>
        <span class="n">target_seq_aln_insert</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">ref_seq_length</span>
        <span class="n">DNA_rev_cmp_dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;A&quot;</span><span class="p">:</span> <span class="s2">&quot;T&quot;</span><span class="p">,</span>
            <span class="s2">&quot;T&quot;</span><span class="p">:</span> <span class="s2">&quot;A&quot;</span><span class="p">,</span>
            <span class="s2">&quot;C&quot;</span><span class="p">:</span> <span class="s2">&quot;G&quot;</span><span class="p">,</span>
            <span class="s2">&quot;G&quot;</span><span class="p">:</span> <span class="s2">&quot;C&quot;</span><span class="p">,</span>
            <span class="s2">&quot;N&quot;</span><span class="p">:</span> <span class="s2">&quot;N&quot;</span><span class="p">,</span>
            <span class="s2">&quot;-&quot;</span><span class="p">:</span> <span class="s2">&quot;-&quot;</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="n">reference_seq</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">)</span>
        <span class="n">target_seq</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">)</span>

        <span class="n">ref_gap_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">ref_del_str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

        <span class="n">aln_start</span> <span class="o">=</span> <span class="n">aln</span><span class="p">[</span><span class="s2">&quot;ref_aln_start&quot;</span><span class="p">]</span>
        <span class="n">aln_end</span> <span class="o">=</span> <span class="n">aln</span><span class="p">[</span><span class="s2">&quot;ref_aln_end&quot;</span><span class="p">]</span>

        <span class="c1"># update target_seq_aln</span>
        <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;target_seq_aln (before update) = </span><span class="si">{</span><span class="n">target_seq_aln</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;target_seq_aln_insert (before update) = </span><span class="si">{</span><span class="n">target_seq_aln_insert</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">ref_base</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">reference_seq</span><span class="p">):</span>
            <span class="c1"># reference  : GCCTCTGGAGAGGGAGGAGGG</span>
            <span class="c1"># align_info : |.|.|||..|..|||||.||-</span>
            <span class="c1"># target_seq : GGCACTGCGGCTGGAGGTGG-</span>
            <span class="k">if</span> <span class="n">ref_base</span> <span class="o">!=</span> <span class="s2">&quot;-&quot;</span><span class="p">:</span>
                <span class="n">ref_gap_count</span> <span class="o">+=</span> <span class="mi">0</span>
                <span class="n">ref_del_str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                <span class="n">target_seq_aln</span><span class="p">[</span><span class="n">aln_start</span> <span class="o">+</span> <span class="n">idx</span> <span class="o">-</span> <span class="n">ref_gap_count</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">ref_del_str</span> <span class="o">+</span> <span class="n">target_seq</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ref_gap_count</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">ref_del_str</span> <span class="o">+=</span> <span class="n">target_seq</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>  <span class="c1"># for continuous gap</span>
                <span class="n">target_seq_aln_insert</span><span class="p">[</span><span class="n">aln_start</span> <span class="o">+</span> <span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">target_seq</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;update target_seq_aln: show &#39;&#39;.join(target_seq_aln)</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;target_seq_aln = </span><span class="si">{</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">target_seq_aln</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;target_seq     = </span><span class="si">{</span><span class="n">target_seq</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;update target_seq_aln: Done&quot;</span><span class="p">)</span>
        <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;target_seq_aln (after update) = </span><span class="si">{</span><span class="n">target_seq_aln</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;target_seq_aln_insert (after update) = </span><span class="si">{</span><span class="n">target_seq_aln_insert</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># if reverse alignment</span>
        <span class="k">if</span> <span class="n">aln_direction</span> <span class="o">==</span> <span class="s2">&quot;Reverse Alignment&quot;</span><span class="p">:</span>
            <span class="c1"># illustrate reverse alignment as forward alignment</span>
            <span class="n">target_seq_aln</span> <span class="o">=</span> <span class="n">target_seq_aln</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">target_seq_aln_insert</span> <span class="o">=</span> <span class="n">target_seq_aln_insert</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;use reverse alignment&quot;</span><span class="p">)</span>
            <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;target_seq_aln = </span><span class="si">{</span><span class="n">target_seq_aln</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;target_seq_aln_insert = </span><span class="si">{</span><span class="n">target_seq_aln_insert</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">possible_target_region_start</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">aln_start</span> <span class="o">-</span> <span class="n">region_extend_length</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">possible_target_region_end</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span>
            <span class="n">aln_end</span> <span class="o">+</span> <span class="n">region_extend_length</span><span class="p">,</span> <span class="n">ref_seq_length</span>
        <span class="p">)</span>  <span class="c1"># 266: 0~255 266 - 1</span>
        <span class="n">plot_region</span> <span class="o">=</span> <span class="p">(</span><span class="n">possible_target_region_start</span><span class="p">,</span> <span class="n">possible_target_region_end</span><span class="p">)</span>
        <span class="n">df_bases_select</span> <span class="o">=</span> <span class="n">df_bases</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">plot_region</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">:</span> <span class="n">plot_region</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">:]</span>
        <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;df_bases_select:</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="o">+</span> <span class="n">tabulate</span><span class="p">(</span><span class="n">df_bases_select</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="s2">&quot;keys&quot;</span><span class="p">,</span> <span class="n">tablefmt</span><span class="o">=</span><span class="s2">&quot;psql&quot;</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="c1"># ----------------------------------------------------------------&gt;&gt;&gt;&gt;&gt;</span>
        <span class="c1"># load .bmat file</span>
        <span class="c1"># ----------------------------------------------------------------&gt;&gt;&gt;&gt;&gt;</span>
        <span class="n">label_panel</span> <span class="o">=</span> <span class="n">labels</span>
        <span class="n">ls_bmat</span> <span class="o">=</span> <span class="n">input_tables</span>
        <span class="n">ls_bmat_table</span> <span class="o">=</span> <span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">path_bmat</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">path_bmat</span> <span class="ow">in</span> <span class="n">ls_bmat</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">bmat</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ls_bmat_table</span><span class="p">):</span>
            <span class="n">bmat</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">label_panel</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
            <span class="n">bmat</span> <span class="o">=</span> <span class="n">bmat</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">&quot;chr_name&quot;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">df_tmp</span> <span class="o">=</span> <span class="n">ls_bmat_table</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">bmat_table</span> <span class="o">=</span> <span class="n">ls_bmat_table</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">df_bmat</span> <span class="ow">in</span> <span class="n">ls_bmat_table</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
            <span class="n">suffixes</span> <span class="o">=</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;_</span><span class="si">{</span><span class="n">df_tmp</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;_</span><span class="si">{</span><span class="n">df_bmat</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">df_tmp</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
                <span class="n">df_tmp</span><span class="p">,</span> <span class="n">df_bmat</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;chr_index&quot;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;outer&quot;</span><span class="p">,</span> <span class="n">suffixes</span><span class="o">=</span><span class="n">suffixes</span>
            <span class="p">)</span>

        <span class="n">ls_columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;chr_index&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">label_panel</span><span class="p">:</span>
            <span class="n">str_tmp</span> <span class="o">=</span> <span class="s2">&quot;ref_base_ A_ G_ C_ T_ del_count_ insert_count_ ambiguous_count_ deletion_ insertion_ ambiguous_ mut_num_ label_ &quot;</span>
            <span class="n">ls_tmp</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">str_tmp</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_ &quot;</span><span class="p">,</span> <span class="s2">&quot;_</span><span class="si">{label}</span><span class="s2"> &quot;</span><span class="p">)</span>
                <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">)</span>
                <span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">ls_columns</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">ls_tmp</span><span class="p">)</span>

        <span class="n">df_tmp</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">ls_columns</span>
        <span class="c1"># print(f&#39;df_tmp = \n{df_tmp}&#39;)</span>
        <span class="c1"># define ref_seq as the referencing sequence</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ls_bmat_table</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">ref_seq</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">bmat_table</span><span class="p">[</span><span class="s2">&quot;ref_base_&quot;</span> <span class="o">+</span> <span class="n">label_panel</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>

        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">ls_bmat_table</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">ref_seq</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">bmat_table</span><span class="o">.</span><span class="n">ref_base</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;ref info gets wrong!&quot;</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="n">df_bmat_all</span> <span class="o">=</span> <span class="n">df_tmp</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="c1"># print(f&#39;df_bmat_all = \n{df_bmat_all}&#39;)</span>
        <span class="c1"># print(f&#39;ref_seq = \n{ref_seq}&#39;)</span>
        <span class="c1"># make alignment info</span>
        <span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">ref_seq</span><span class="p">)</span>
        <span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">ref_seq</span><span class="p">)</span>

        <span class="n">possible_target_region_start</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">aln_start</span> <span class="o">-</span> <span class="n">region_extend_length</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">possible_target_region_end</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span>
            <span class="n">aln_end</span> <span class="o">+</span> <span class="n">region_extend_length</span><span class="p">,</span> <span class="n">ref_seq_length</span>
        <span class="p">)</span>  <span class="c1"># 266: 0~255 266 - 1</span>
        <span class="n">plot_region</span> <span class="o">=</span> <span class="p">(</span><span class="n">possible_target_region_start</span><span class="p">,</span> <span class="n">possible_target_region_end</span><span class="p">)</span>
        <span class="n">df_bases_select</span> <span class="o">=</span> <span class="n">df_bmat_all</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">plot_region</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">:</span> <span class="n">plot_region</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">:]</span>
        <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;df_bases_select:</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="o">+</span> <span class="n">tabulate</span><span class="p">(</span><span class="n">df_bases_select</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="s2">&quot;keys&quot;</span><span class="p">,</span> <span class="n">tablefmt</span><span class="o">=</span><span class="s2">&quot;psql&quot;</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="c1"># make plot</span>
        <span class="c1"># set color</span>
        <span class="c1"># show indel</span>
        <span class="n">mpl</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s2">&quot;Agg&quot;</span><span class="p">)</span>
        <span class="n">np</span><span class="o">.</span><span class="n">set_printoptions</span><span class="p">(</span><span class="n">suppress</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">box_border_plot_state</span> <span class="o">=</span> <span class="n">box_border</span>

        <span class="c1"># set panel size</span>
        <span class="n">panel_box_width</span> <span class="o">=</span> <span class="mf">0.4</span>
        <span class="n">panel_box_heigth</span> <span class="o">=</span> <span class="mf">0.4</span>
        <span class="n">panel_space</span> <span class="o">=</span> <span class="mf">0.05</span>
        <span class="n">panel_box_space</span> <span class="o">=</span> <span class="n">box_space</span>

        <span class="c1"># color part</span>

        <span class="c1"># make color breaks</span>
        <span class="n">color_break_num</span> <span class="o">=</span> <span class="mi">20</span>
        <span class="n">break_step</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">color_break_num</span>
        <span class="c1"># mutation ratio of box lower than min_ratio will show as white</span>
        <span class="n">min_color_value</span> <span class="o">=</span> <span class="n">min_ratio</span>
        <span class="c1"># mutation ratio of box lower than max_ratio will show as white</span>
        <span class="n">max_color_value</span> <span class="o">=</span> <span class="n">max_ratio</span>
        <span class="n">color_break</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">min_color_value</span><span class="p">,</span> <span class="n">max_color_value</span><span class="p">,</span> <span class="n">break_step</span><span class="p">),</span> <span class="mi">5</span>
        <span class="p">)</span>
        <span class="c1"># min_color: min color to plot heatmap with RGB format</span>
        <span class="c1"># max_color: max color to plot heatmap with RGB format</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">min_color</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
            <span class="n">low_color</span> <span class="o">=</span> <span class="n">min_color</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">BioatInvalidOptionError</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">max_color</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
            <span class="n">high_color</span> <span class="o">=</span> <span class="n">max_color</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">BioatInvalidOptionError</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">color_list</span> <span class="o">=</span> <span class="n">make_color_list</span><span class="p">(</span>
                <span class="n">low_color</span><span class="p">,</span> <span class="n">high_color</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">color_break</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;Hex&quot;</span>
            <span class="p">)</span>
            <span class="n">color_list</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;#FFFFFF&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">color_list</span><span class="p">]</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">low_color</span><span class="p">,</span> <span class="n">high_color</span><span class="p">)</span>
            <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">color_break</span><span class="p">)</span>

        <span class="c1"># get plot info</span>
        <span class="n">total_box_count</span> <span class="o">=</span> <span class="n">plot_region</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">plot_region</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># calculate base info and fix zero</span>
        <span class="n">ls_base_sum_count</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">ls_total_sum_count</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">label_panel</span><span class="p">:</span>
            <span class="n">base_sum_count</span> <span class="o">=</span> <span class="n">df_bases_select</span><span class="p">[</span>
                <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;A_</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;G_</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;C_</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;T_</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>
            <span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="c1"># print base_sum_count</span>
            <span class="n">total_sum_count</span> <span class="o">=</span> <span class="n">df_bases_select</span><span class="p">[</span>
                <span class="p">[</span>
                    <span class="sa">f</span><span class="s2">&quot;A_</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="sa">f</span><span class="s2">&quot;G_</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="sa">f</span><span class="s2">&quot;C_</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="sa">f</span><span class="s2">&quot;T_</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="sa">f</span><span class="s2">&quot;del_count_</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="sa">f</span><span class="s2">&quot;insert_count_</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="p">]</span>
            <span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

            <span class="n">base_sum_count</span><span class="p">[</span><span class="n">base_sum_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">base_sum_count</span> <span class="o">=</span> <span class="n">base_sum_count</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">total_sum_count</span> <span class="o">=</span> <span class="n">total_sum_count</span> <span class="o">+</span> <span class="mi">1</span>

            <span class="n">ls_base_sum_count</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">base_sum_count</span><span class="p">)</span>
            <span class="n">ls_total_sum_count</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">total_sum_count</span><span class="p">)</span>
        <span class="c1"># make plot size</span>
        <span class="n">plot_data_list</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">panel_space_coef</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">panel_height_coef</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">count_ratio</span> <span class="o">==</span> <span class="s2">&quot;all&quot;</span><span class="p">:</span>
            <span class="n">panel_height_coef</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">ls_bmat_table</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span>
                <span class="n">default_bases</span>
            <span class="p">)</span> <span class="o">*</span> <span class="mi">2</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">panel_height_coef</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">ls_bmat_table</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span>
                <span class="n">default_bases</span>
            <span class="p">)</span>
        <span class="c1"># 根据bmat表格个数来控制方格高度</span>
        <span class="c1"># panel_space_coef = [1, 1, 1] + [0.3] * 3 + [1, 0.3, 1] + [0.3] * 3 + [1, 0.3]</span>
        <span class="k">if</span> <span class="n">count_ratio</span> <span class="o">==</span> <span class="s2">&quot;all&quot;</span><span class="p">:</span>
            <span class="n">panel_space_coef</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span>
                <span class="p">[</span><span class="mf">0.3</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ls_bmat_table</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="mi">4</span><span class="p">]</span>
            <span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">default_bases</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">panel_space_coef</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span>
                <span class="p">[</span><span class="mf">0.3</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ls_bmat_table</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="mi">4</span><span class="p">]</span>
            <span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">default_bases</span><span class="p">)</span>
        <span class="c1"># 更正heatmap align错误</span>
        <span class="c1">#     plot_heatmap_index = bmat_table_select.chr_index</span>
        <span class="n">plot_data_list</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">[</span><span class="s2">&quot;Ref_index&quot;</span><span class="p">,</span> <span class="n">df_bases_select</span><span class="o">.</span><span class="n">chr_index</span><span class="p">],</span>
            <span class="p">[</span><span class="s2">&quot;Target_seq&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">target_seq_aln</span><span class="p">[</span><span class="n">plot_region</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">:</span> <span class="n">plot_region</span><span class="p">[</span><span class="mi">1</span><span class="p">]])],</span>
            <span class="p">[</span><span class="s2">&quot;Ref_seq&quot;</span><span class="p">,</span> <span class="n">df_bases_select</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;ref_base_</span><span class="si">{</span><span class="n">label_panel</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]],</span>
        <span class="p">]</span>
        <span class="k">if</span> <span class="n">count_ratio</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;count&quot;</span><span class="p">,</span> <span class="s2">&quot;all&quot;</span><span class="p">}:</span>
            <span class="k">for</span> <span class="n">to_base</span> <span class="ow">in</span> <span class="n">default_bases</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">to_base</span> <span class="o">==</span> <span class="s2">&quot;A&quot;</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">label_panel</span><span class="p">:</span>
                        <span class="n">plot_data_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2">: to A&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">df_bases_select</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;A_</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">])],</span>
                        <span class="p">)</span>
                <span class="k">if</span> <span class="n">to_base</span> <span class="o">==</span> <span class="s2">&quot;G&quot;</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">label_panel</span><span class="p">:</span>
                        <span class="n">plot_data_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2">: to G&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">df_bases_select</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;G_</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">])],</span>
                        <span class="p">)</span>
                <span class="k">if</span> <span class="n">to_base</span> <span class="o">==</span> <span class="s2">&quot;C&quot;</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">label_panel</span><span class="p">:</span>
                        <span class="n">plot_data_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2">: to C&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">df_bases_select</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;C_</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">])],</span>
                        <span class="p">)</span>
                <span class="k">if</span> <span class="n">to_base</span> <span class="o">==</span> <span class="s2">&quot;T&quot;</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">label_panel</span><span class="p">:</span>
                        <span class="n">plot_data_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2">: to T&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">df_bases_select</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;T_</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">])],</span>
                        <span class="p">)</span>
                <span class="k">if</span> <span class="n">to_base</span> <span class="o">==</span> <span class="s2">&quot;Del&quot;</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">label_panel</span><span class="p">:</span>
                        <span class="n">plot_data_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="p">[</span>
                                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2">: to Del&quot;</span><span class="p">,</span>
                                <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">df_bases_select</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;del_count_</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]),</span>
                            <span class="p">],</span>
                        <span class="p">)</span>
                <span class="k">if</span> <span class="n">to_base</span> <span class="o">==</span> <span class="s2">&quot;Ins&quot;</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">label_panel</span><span class="p">:</span>
                        <span class="n">plot_data_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="p">[</span>
                                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2">: to Ins&quot;</span><span class="p">,</span>
                                <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">df_bases_select</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;insert_count_</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]),</span>
                            <span class="p">],</span>
                        <span class="p">)</span>
        <span class="k">if</span> <span class="n">count_ratio</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;ratio&quot;</span><span class="p">,</span> <span class="s2">&quot;all&quot;</span><span class="p">}:</span>
            <span class="k">for</span> <span class="n">to_base</span> <span class="ow">in</span> <span class="n">default_bases</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">to_base</span> <span class="o">==</span> <span class="s2">&quot;A&quot;</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">label_panel</span><span class="p">):</span>
                        <span class="n">plot_data_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="p">[</span>
                                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2">: to A(%)&quot;</span><span class="p">,</span>
                                <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                                    <span class="n">df_bases_select</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;A_</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>
                                    <span class="o">/</span> <span class="n">ls_base_sum_count</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
                                <span class="p">),</span>
                            <span class="p">],</span>
                        <span class="p">)</span>
                <span class="k">if</span> <span class="n">to_base</span> <span class="o">==</span> <span class="s2">&quot;G&quot;</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">label_panel</span><span class="p">):</span>
                        <span class="n">plot_data_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="p">[</span>
                                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2">: to G(%)&quot;</span><span class="p">,</span>
                                <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                                    <span class="n">df_bases_select</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;G_</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>
                                    <span class="o">/</span> <span class="n">ls_base_sum_count</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
                                <span class="p">),</span>
                            <span class="p">],</span>
                        <span class="p">)</span>
                <span class="k">if</span> <span class="n">to_base</span> <span class="o">==</span> <span class="s2">&quot;C&quot;</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">label_panel</span><span class="p">):</span>
                        <span class="n">plot_data_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="p">[</span>
                                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2">: to C(%)&quot;</span><span class="p">,</span>
                                <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                                    <span class="n">df_bases_select</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;C_</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>
                                    <span class="o">/</span> <span class="n">ls_base_sum_count</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
                                <span class="p">),</span>
                            <span class="p">],</span>
                        <span class="p">)</span>
                <span class="k">if</span> <span class="n">to_base</span> <span class="o">==</span> <span class="s2">&quot;T&quot;</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">label_panel</span><span class="p">):</span>
                        <span class="n">plot_data_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="p">[</span>
                                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2">: to T(%)&quot;</span><span class="p">,</span>
                                <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                                    <span class="n">df_bases_select</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;T_</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>
                                    <span class="o">/</span> <span class="n">ls_base_sum_count</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
                                <span class="p">),</span>
                            <span class="p">],</span>
                        <span class="p">)</span>
                <span class="k">if</span> <span class="n">to_base</span> <span class="o">==</span> <span class="s2">&quot;Del&quot;</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">label_panel</span><span class="p">):</span>
                        <span class="n">plot_data_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="p">[</span>
                                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2">: to Del(%)&quot;</span><span class="p">,</span>
                                <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                                    <span class="n">df_bases_select</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;del_count_</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>
                                    <span class="o">/</span> <span class="n">ls_total_sum_count</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
                                <span class="p">),</span>
                            <span class="p">],</span>
                        <span class="p">)</span>
                <span class="k">if</span> <span class="n">to_base</span> <span class="o">==</span> <span class="s2">&quot;Ins&quot;</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">label_panel</span><span class="p">):</span>
                        <span class="n">plot_data_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="p">[</span>
                                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2">: to Ins(%)&quot;</span><span class="p">,</span>
                                <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                                    <span class="n">df_bases_select</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;insert_count_</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>
                                    <span class="o">/</span> <span class="n">ls_total_sum_count</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
                                <span class="p">),</span>
                            <span class="p">],</span>
                        <span class="p">)</span>

        <span class="c1"># get box and space info</span>
        <span class="n">box_height_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">panel_height_coef</span><span class="p">)</span> <span class="o">*</span> <span class="n">panel_box_heigth</span>
        <span class="n">panel_space_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">panel_space_coef</span><span class="p">)</span> <span class="o">*</span> <span class="n">panel_space</span>
        <span class="c1"># for i, j in enumerate(panel_space_coef):</span>
        <span class="c1">#     print i,j</span>
        <span class="c1"># print panel_space</span>
        <span class="c1"># calculate figure total width and height</span>
        <span class="n">figure_width</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">total_box_count</span> <span class="o">*</span> <span class="n">panel_box_width</span>
            <span class="o">+</span> <span class="p">(</span><span class="n">total_box_count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">panel_box_space</span>
            <span class="o">+</span> <span class="n">panel_box_width</span> <span class="o">*</span> <span class="mi">2</span>
        <span class="p">)</span>
        <span class="n">figure_height</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">box_height_list</span><span class="p">)</span> <span class="o">+</span> <span class="nb">sum</span><span class="p">(</span><span class="n">panel_space_list</span><span class="p">)</span>

        <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;figure_width = </span><span class="si">{</span><span class="n">figure_width</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;figure_height = </span><span class="si">{</span><span class="n">figure_height</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># make all box_x</span>
        <span class="n">box_x_vec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span>
            <span class="mi">0</span><span class="p">,</span> <span class="n">figure_width</span> <span class="o">+</span> <span class="n">panel_box_width</span><span class="p">,</span> <span class="n">panel_box_width</span> <span class="o">+</span> <span class="n">panel_box_space</span>
        <span class="p">)</span>
        <span class="n">box_x_vec</span> <span class="o">=</span> <span class="n">box_x_vec</span><span class="p">[:</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ref_seq</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span>

        <span class="c1"># make box border</span>
        <span class="k">if</span> <span class="n">box_border_plot_state</span><span class="p">:</span>
            <span class="n">box_edgecolor</span> <span class="o">=</span> <span class="s2">&quot;#AAAAAA&quot;</span>
            <span class="n">box_linestyle</span> <span class="o">=</span> <span class="s2">&quot;-&quot;</span>
            <span class="n">box_linewidth</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">box_edgecolor</span> <span class="o">=</span> <span class="s2">&quot;#FFFFFF&quot;</span>
            <span class="n">box_linestyle</span> <span class="o">=</span> <span class="s2">&quot;None&quot;</span>
            <span class="n">box_linewidth</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># make box_y initialize</span>
        <span class="n">current_y</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">df_matrix</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
            <span class="p">[[</span><span class="s2">&quot;&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">plot_data_list</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">])]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">panel_height_coef</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">ls_row_name</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">panel_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">panel_height_coef</span><span class="p">)):</span>
            <span class="n">ls_row_name</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">plot_data_list</span><span class="p">[</span><span class="n">panel_index</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">df_matrix</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">panel_index</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">df_matrix</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">panel_index</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">str_</span>
            <span class="p">)</span>

            <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">box_value</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">plot_data_list</span><span class="p">[</span><span class="n">panel_index</span><span class="p">][</span><span class="mi">1</span><span class="p">]):</span>
                <span class="n">row</span> <span class="o">=</span> <span class="n">panel_index</span>
                <span class="n">col</span> <span class="o">=</span> <span class="n">index</span>
                <span class="n">df_matrix</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">box_value</span>
                <span class="c1"># print(f&#39;box_value = {box_value}, row = {row}, col = {col}&#39;)</span>
                <span class="c1"># print(f&#39;df_matrix.iloc[row, col] = {df_matrix.iloc[row, col]}&#39;)</span>
                <span class="c1"># if box_value == &#39;&#39;:</span>
                <span class="c1">#     raise ValueError</span>
        <span class="n">df_matrix</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">ls_row_name</span>

        <span class="c1"># plot heatmap</span>
        <span class="k">if</span> <span class="n">output_fig_heatmap</span><span class="p">:</span>
            <span class="c1"># 预设参数</span>
            <span class="n">num_extend</span> <span class="o">=</span> <span class="n">region_extend_length</span>
            <span class="c1"># rename columns of df_matrix</span>
            <span class="n">df_matrix</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">df_matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">dt_base</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;A&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;G&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;C&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;T&quot;</span><span class="p">:</span> <span class="p">[]}</span>
            <span class="k">for</span> <span class="n">info</span> <span class="ow">in</span> <span class="n">heatmap_mut_direction</span><span class="p">:</span>
                <span class="n">dt_base</span><span class="p">[</span><span class="n">info</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">+=</span> <span class="n">info</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[mut_direction] for heatmap: </span><span class="si">{</span><span class="n">dt_base</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[label_panel] for heatmap: </span><span class="si">{</span><span class="n">label_panel</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;[region_extend_length] for heatmap: </span><span class="si">{</span><span class="n">region_extend_length</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[block_ref] for Target-seq multiplot: </span><span class="si">{</span><span class="n">block_ref</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="n">ls_col_not_null</span> <span class="o">=</span> <span class="n">df_matrix</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span>
                <span class="o">-</span><span class="p">(</span><span class="n">df_matrix</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">&quot;Target_seq&quot;</span><span class="p">,</span> <span class="p">:]</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="n">df_matrix</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="n">ls_plot_range</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
                <span class="nb">range</span><span class="p">(</span><span class="n">ls_col_not_null</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">num_extend</span><span class="p">,</span> <span class="n">ls_col_not_null</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">num_extend</span><span class="p">)</span>
            <span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">df_matrix</span> <span class="o">=</span> <span class="n">df_matrix</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">ls_plot_range</span><span class="p">]</span>
                <span class="c1"># 有不在的就不为空，不为空则判断成立</span>
                <span class="c1"># print &#39;testTTTTTTTTTTTTTTT&#39;</span>

            <span class="k">except</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;The param [num_extend] is too large or &lt;0, it must be a integer&gt;=0&quot;</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="n">msg</span>
                <span class="p">)</span>
            <span class="n">df_matrix</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">&quot;Target_seq&quot;</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="n">ls_ref</span> <span class="o">=</span> <span class="n">df_matrix</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">&quot;Ref_seq&quot;</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

            <span class="n">ls_ratio</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">label_panel</span><span class="p">:</span>
                <span class="n">df_sample</span> <span class="o">=</span> <span class="n">df_matrix</span><span class="p">[</span>
                    <span class="p">[</span>
                        <span class="n">label</span> <span class="o">==</span> <span class="n">i</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;: to&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> <span class="s2">&quot;(%)&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">i</span>
                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">df_matrix</span><span class="o">.</span><span class="n">index</span>
                    <span class="p">]</span>
                <span class="p">]</span>
                <span class="n">df_sample</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;A&quot;</span><span class="p">,</span> <span class="s2">&quot;G&quot;</span><span class="p">,</span> <span class="s2">&quot;C&quot;</span><span class="p">,</span> <span class="s2">&quot;T&quot;</span><span class="p">,</span> <span class="s2">&quot;Ins&quot;</span><span class="p">,</span> <span class="s2">&quot;Del&quot;</span><span class="p">]</span>
                <span class="n">ls_A</span> <span class="o">=</span> <span class="n">df_sample</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="s2">&quot;A&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                <span class="n">ls_G</span> <span class="o">=</span> <span class="n">df_sample</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="s2">&quot;G&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                <span class="n">ls_C</span> <span class="o">=</span> <span class="n">df_sample</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="s2">&quot;C&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                <span class="n">ls_T</span> <span class="o">=</span> <span class="n">df_sample</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="s2">&quot;T&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                <span class="n">ls_bool</span> <span class="o">=</span> <span class="p">[]</span>

                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ls_A</span><span class="p">)):</span>
                    <span class="k">if</span> <span class="n">ls_A</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">ls_C</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">ls_G</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">ls_T</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                        <span class="n">ls_bool</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">ls_bool</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">ls_bl_select_df_sample</span> <span class="o">=</span> <span class="n">ls_bool</span>
                <span class="n">df_sample</span> <span class="o">=</span> <span class="n">df_sample</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">ls_bl_select_df_sample</span><span class="p">]</span>
                <span class="n">df_sample</span> <span class="o">=</span> <span class="n">df_sample</span><span class="o">.</span><span class="n">loc</span><span class="p">[[</span><span class="s2">&quot;A&quot;</span><span class="p">,</span> <span class="s2">&quot;G&quot;</span><span class="p">,</span> <span class="s2">&quot;C&quot;</span><span class="p">,</span> <span class="s2">&quot;T&quot;</span><span class="p">],</span> <span class="p">:]</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">df_sample</span> <span class="o">=</span> <span class="n">df_sample</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
                <span class="n">df_sample</span><span class="p">[</span><span class="s2">&quot;sum&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">df_sample</span><span class="p">[</span><span class="s2">&quot;A&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">df_sample</span><span class="p">[</span><span class="s2">&quot;G&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">df_sample</span><span class="p">[</span><span class="s2">&quot;C&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">df_sample</span><span class="p">[</span><span class="s2">&quot;T&quot;</span><span class="p">]</span>
                <span class="p">)</span>
                <span class="n">df_sample</span><span class="p">[</span><span class="s2">&quot;Ref_seq&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ls_ref</span><span class="p">)[</span><span class="n">ls_bl_select_df_sample</span><span class="p">]</span>
                <span class="n">df_sample</span><span class="p">[</span><span class="s2">&quot;To_base&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_sample</span><span class="p">[</span><span class="s2">&quot;Ref_seq&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">dt_base</span><span class="p">[</span><span class="n">x</span><span class="p">])</span>
                <span class="n">df_sample</span><span class="p">[</span><span class="s2">&quot;Mut_count&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

                <span class="k">for</span> <span class="n">recode</span> <span class="ow">in</span> <span class="n">df_sample</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
                    <span class="n">index_row</span> <span class="o">=</span> <span class="n">recode</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">to_base</span> <span class="ow">in</span> <span class="n">recode</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;To_base&quot;</span><span class="p">]:</span>
                        <span class="n">df_sample</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">index_row</span><span class="p">,</span> <span class="s2">&quot;Mut_count&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">recode</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">to_base</span><span class="p">]</span>

                <span class="n">df_sample</span><span class="p">[</span><span class="s2">&quot;Mut_ratio&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_sample</span><span class="p">[</span><span class="s2">&quot;Mut_count&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">df_sample</span><span class="p">[</span><span class="s2">&quot;sum&quot;</span><span class="p">]</span>
                <span class="n">ls_sample_ratio</span> <span class="o">=</span> <span class="n">df_sample</span><span class="p">[</span><span class="s2">&quot;Mut_ratio&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                <span class="n">ls_ratio</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ls_sample_ratio</span><span class="p">)</span>
            <span class="n">df_ratio_all</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">ls_ratio</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
            <span class="n">df_ratio_all</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">label_panel</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Catch NA: </span><span class="si">{</span><span class="n">df_ratio_all</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">df_ratio_all</span><span class="o">.</span><span class="n">head</span><span class="p">())</span>
                <span class="c1"># print(f&#39;df_matrix.T = \n{df_matrix.T}&#39;)</span>
                <span class="n">df_ratio_all</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">df_matrix</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="s2">&quot;Ref_index&quot;</span><span class="p">][</span><span class="n">ls_bl_select_df_sample</span><span class="p">]</span>
                    <span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
                    <span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
                    <span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                <span class="p">)</span>
                <span class="n">df_ratio_all</span><span class="p">[</span><span class="s2">&quot;Target_seq&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_matrix</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="s2">&quot;Target_seq&quot;</span><span class="p">][</span>
                    <span class="n">ls_bl_select_df_sample</span>
                <span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                <span class="n">df_ratio_all</span><span class="p">[</span><span class="s2">&quot;Ref_seq&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_matrix</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="s2">&quot;Ref_seq&quot;</span><span class="p">][</span>
                    <span class="n">ls_bl_select_df_sample</span>
                <span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                <span class="c1"># print(f&#39;df_ratio_all.T = \n{df_ratio_all.T}&#39;)</span>
                <span class="c1"># exit()</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="n">start_idx</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">df_matrix</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="s2">&quot;Ref_index&quot;</span><span class="p">][</span><span class="n">ls_bl_select_df_sample</span><span class="p">]</span>
                    <span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
                    <span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
                    <span class="o">.</span><span class="n">tolist</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
                <span class="p">)</span>
                <span class="n">end_idx</span> <span class="o">=</span> <span class="n">start_idx</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_ratio_all</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
                <span class="n">df_ratio_all</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">start_idx</span><span class="p">,</span> <span class="n">end_idx</span><span class="p">)</span>
                <span class="n">df_ratio_all</span><span class="p">[</span><span class="s2">&quot;Target_seq&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_matrix</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="s2">&quot;Target_seq&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                <span class="n">df_ratio_all</span><span class="p">[</span><span class="s2">&quot;Ref_seq&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_matrix</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="s2">&quot;Ref_seq&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

            <span class="n">df_ratio_all</span><span class="p">[</span><span class="s2">&quot;On-Target&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="n">df_ratio_all</span><span class="p">[</span><span class="s2">&quot;Reference&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="n">df_ratio_all</span> <span class="o">=</span> <span class="n">df_ratio_all</span><span class="p">[</span>
                <span class="p">[</span><span class="s2">&quot;Target_seq&quot;</span><span class="p">,</span> <span class="s2">&quot;Ref_seq&quot;</span><span class="p">,</span> <span class="s2">&quot;On-Target&quot;</span><span class="p">,</span> <span class="s2">&quot;Reference&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">label_panel</span><span class="p">]</span>
            <span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

            <span class="n">df_onTarget_Ref</span> <span class="o">=</span> <span class="n">df_ratio_all</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="mi">2</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
            <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;df_onTarget_Ref: </span><span class="se">\n</span><span class="si">{</span><span class="n">df_onTarget_Ref</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="c1"># exit()</span>
            <span class="c1"># print(df_onTarget_Ref == &#39;&#39;)</span>
            <span class="n">df_onTarget_Ref_color</span> <span class="o">=</span> <span class="n">df_ratio_all</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="mi">2</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">plot_agct</span><span class="p">)</span>
            <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;df_onTarget_Ref_color: </span><span class="se">\n</span><span class="si">{</span><span class="n">df_onTarget_Ref_color</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="c1"># exit()</span>
            <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;df_ratio_all: </span><span class="se">\n</span><span class="si">{</span><span class="n">df_ratio_all</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="c1"># exit()</span>
            <span class="n">df_plot</span> <span class="o">=</span> <span class="n">df_ratio_all</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">2</span><span class="p">:,</span> <span class="p">:]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;df_plot: </span><span class="se">\n</span><span class="si">{</span><span class="n">df_plot</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="c1"># print(f&#39;df_plot: \n{df_plot}&#39;)</span>
            <span class="c1"># exit()</span>
            <span class="n">df_plot</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">2</span><span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">df_plot</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">2</span><span class="p">:,</span> <span class="p">:]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
            <span class="n">ls_max</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">df_plot</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">2</span><span class="p">:,</span> <span class="p">:]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">():</span>
                <span class="n">ls_max</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">ls_break</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">ls_max</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">ls_max</span><span class="p">)</span> <span class="o">/</span> <span class="mi">100</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">ZeroDivisionError</span><span class="p">:</span>
                <span class="n">ls_break</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="mi">0</span><span class="p">,</span>
                    <span class="mf">0.003</span><span class="p">,</span>
                    <span class="mf">0.006</span><span class="p">,</span>
                    <span class="mf">0.009</span><span class="p">,</span>
                    <span class="mf">0.012</span><span class="p">,</span>
                    <span class="mf">0.015</span><span class="p">,</span>
                    <span class="mf">0.018</span><span class="p">,</span>
                    <span class="mf">0.022</span><span class="p">,</span>
                    <span class="mf">0.026</span><span class="p">,</span>
                    <span class="mf">0.030</span><span class="p">,</span>
                    <span class="mf">0.035</span><span class="p">,</span>
                    <span class="mf">0.040</span><span class="p">,</span>
                    <span class="mf">0.05</span><span class="p">,</span>
                    <span class="mf">0.06</span><span class="p">,</span>
                    <span class="mf">0.07</span><span class="p">,</span>
                    <span class="mf">0.08</span><span class="p">,</span>
                    <span class="mf">1.00</span><span class="p">,</span>
                    <span class="mf">2.00</span><span class="p">,</span>
                    <span class="mf">3.00</span><span class="p">,</span>
                <span class="p">]</span>
            <span class="n">ls_color_middle</span> <span class="o">=</span> <span class="n">make_color_list</span><span class="p">(</span>
                <span class="n">low_color_RGB</span><span class="o">=</span><span class="n">convert_hex_to_rgb</span><span class="p">(</span><span class="s2">&quot;#87BDDB&quot;</span><span class="p">),</span>
                <span class="n">high_color_RGB</span><span class="o">=</span><span class="n">convert_hex_to_rgb</span><span class="p">(</span><span class="s2">&quot;#0A306A&quot;</span><span class="p">),</span>
                <span class="n">length_out</span><span class="o">=</span><span class="mi">80</span><span class="p">,</span>
                <span class="n">return_fmt</span><span class="o">=</span><span class="s2">&quot;Hex&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">ls_color_top</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;#0A306A&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">20</span>
            <span class="n">ls_color_bottom</span> <span class="o">=</span> <span class="p">(</span>
                <span class="p">[</span><span class="s2">&quot;#EFEFEF&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">5</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;#DDEAF6&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">5</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;#A9CEE4&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">5</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;#87BDDB&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">5</span>
            <span class="p">)</span>
            <span class="n">ls_color</span> <span class="o">=</span> <span class="n">ls_color_bottom</span> <span class="o">+</span> <span class="n">ls_color_middle</span> <span class="o">+</span> <span class="n">ls_color_top</span>
            <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ls_color: </span><span class="si">{</span><span class="n">ls_color</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="c1"># exit()</span>

            <span class="n">df_onTarget_Ref_tmp</span> <span class="o">=</span> <span class="n">df_onTarget_Ref</span><span class="o">.</span><span class="n">T</span>
            <span class="n">df_onTarget_Ref_tmp</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                <span class="n">df_onTarget_Ref_tmp</span><span class="p">[</span><span class="s2">&quot;Target_seq&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">(),</span> <span class="s2">&quot;Target_seq&quot;</span>
            <span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">NA</span>
            <span class="n">df_onTarget_Ref</span> <span class="o">=</span> <span class="n">df_onTarget_Ref_tmp</span><span class="o">.</span><span class="n">T</span>
            <span class="n">df_plot_rec</span> <span class="o">=</span> <span class="n">df_plot</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="s2">&quot;df_plot_rec:</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="o">+</span> <span class="n">tabulate</span><span class="p">(</span><span class="n">df_plot_rec</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="s2">&quot;keys&quot;</span><span class="p">,</span> <span class="n">tablefmt</span><span class="o">=</span><span class="s2">&quot;psql&quot;</span><span class="p">),</span>
            <span class="p">)</span>

            <span class="c1"># heatmap颜色，去map_hex_for_matrix函数中调整</span>
            <span class="k">def</span><span class="w"> </span><span class="nf">map_hex_for_matrix</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
                <span class="c1"># 判断value范围并返回颜色的Hex值</span>
                <span class="n">value</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">ls_break</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">value</span><span class="p">:</span>
                        <span class="k">break</span>
                    <span class="k">continue</span>
                <span class="k">return</span> <span class="n">ls_color</span><span class="p">[</span><span class="n">ls_break</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>

            <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;df_plot_rec: </span><span class="se">\n</span><span class="si">{</span><span class="n">df_plot_rec</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="c1"># print(f&#39;df_plot_rec: \n{df_plot_rec}&#39;)</span>
            <span class="c1"># exit()</span>
            <span class="n">df_plot_rec_cmap</span> <span class="o">=</span> <span class="n">df_plot_rec</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">df_plot_rec_cmap</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">2</span><span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">df_plot_rec_cmap</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">2</span><span class="p">:,</span> <span class="p">:]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">map_hex_for_matrix</span><span class="p">)</span>
            
            <span class="c1"># print(df_plot_rec_cmap)</span>
            <span class="c1"># exit()</span>

            <span class="c1"># print(f&#39;df_plot_rec = \n{df_plot_rec}&#39;)</span>
            <span class="c1"># print(df_plot_rec.loc[&#39;On-Target&#39;, :])</span>
            <span class="c1"># print(df_plot_rec.loc[&#39;On-Target&#39;, :].dtype)</span>
            <span class="c1"># df_matrix = pd.DataFrame([[&#39;&#39;] * len(plot_data_list[0][1])] * len(panel_height_coef))</span>
            <span class="c1"># print(f&quot;df_onTarget_Ref.loc[&#39;Target_seq&#39;, :] = \n{df_onTarget_Ref.loc[&#39;Target_seq&#39;, :]}&quot;)</span>
            <span class="c1"># print(&#39;df_onTarget_Ref&#39;, df_onTarget_Ref.loc[&#39;Target_seq&#39;, :] == &#39;&#39;)</span>
            <span class="c1"># print(f&quot;df_plot_rec.loc[&#39;On-Target&#39;, :] = \n{df_plot_rec.loc[&#39;On-Target&#39;, :]}&quot;)</span>
            <span class="c1"># print(&#39;df_plot_rec&#39;, df_plot_rec.loc[&#39;On-Target&#39;, :] == &#39;&#39;)</span>
            <span class="c1"># exit()</span>
            <span class="n">df_plot_rec</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">&quot;On-Target&quot;</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">df_onTarget_Ref</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">&quot;Target_seq&quot;</span><span class="p">,</span> <span class="p">:]</span>
            <span class="c1"># print(df_plot_rec.loc[&#39;On-Target&#39;, :])</span>
            <span class="c1"># print(df_onTarget_Ref.loc[&#39;Target_seq&#39;, :])</span>
            <span class="n">df_plot_rec</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">&quot;Reference&quot;</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">df_onTarget_Ref</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">&quot;Ref_seq&quot;</span><span class="p">,</span> <span class="p">:]</span>
            <span class="n">df_plot_rec_cmap</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">&quot;On-Target&quot;</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">df_onTarget_Ref</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                <span class="s2">&quot;Target_seq&quot;</span><span class="p">,</span> <span class="p">:</span>
            <span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">plot_agct</span><span class="p">)</span>
            <span class="n">df_plot_rec_cmap</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">&quot;Reference&quot;</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">df_onTarget_Ref</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                <span class="s2">&quot;Ref_seq&quot;</span><span class="p">,</span> <span class="p">:</span>
            <span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">plot_agct</span><span class="p">)</span>

            <span class="n">figure_width_heatmap</span> <span class="o">=</span> <span class="n">df_plot_rec</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">figure_height_heatmap</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">df_plot_rec</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">len</span><span class="p">(</span><span class="n">ls_break</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.8</span><span class="p">)</span>
            <span class="n">scale</span> <span class="o">=</span> <span class="mf">1.1</span>  <span class="c1"># 1.1</span>
            <span class="n">fig_heatmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span>
                <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">figure_width_heatmap</span> <span class="o">*</span> <span class="n">scale</span><span class="p">,</span> <span class="n">figure_height_heatmap</span> <span class="o">*</span> <span class="n">scale</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">fig_heatmap</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="s2">&quot;equal&quot;</span><span class="p">)</span>

            <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="n">figure_width_heatmap</span> <span class="o">+</span> <span class="mi">5</span><span class="p">])</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">([</span><span class="o">-</span><span class="n">figure_height_heatmap</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>

            <span class="c1"># export heatmap values</span>
            <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;export heatmap reference table...&quot;</span><span class="p">)</span>
            <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;df_plot_rec: </span><span class="se">\n</span><span class="si">{</span><span class="n">df_plot_rec</span><span class="o">.</span><span class="n">index</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="c1"># exit()</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">df_plot_rec</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="n">row_name</span> <span class="o">=</span> <span class="n">df_plot_rec</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">row</span><span class="p">]</span>

                <span class="c1"># add panel name</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
                    <span class="n">x</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
                    <span class="n">y</span><span class="o">=</span><span class="mf">0.55</span> <span class="o">-</span> <span class="n">row</span> <span class="o">-</span> <span class="mf">1.1</span><span class="p">,</span>
                    <span class="n">s</span><span class="o">=</span><span class="n">row_name</span><span class="p">,</span>
                    <span class="n">horizontalalignment</span><span class="o">=</span><span class="s2">&quot;right&quot;</span><span class="p">,</span>
                    <span class="n">verticalalignment</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
                    <span class="n">fontsize</span><span class="o">=</span><span class="mi">34</span> <span class="o">/</span> <span class="mf">1.1</span> <span class="o">*</span> <span class="n">scale</span><span class="p">,</span>
                    <span class="n">fontname</span><span class="o">=</span><span class="s2">&quot;DejaVu Sans&quot;</span><span class="p">,</span>
                    <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="c1"># add Target_seq and ref</span>
                <span class="k">if</span> <span class="n">row_name</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;On-Target&quot;</span><span class="p">,</span> <span class="s2">&quot;Reference&quot;</span><span class="p">]:</span>
                    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">df_plot</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                        <span class="c1"># plot Rectangle</span>
                        <span class="n">site_x</span> <span class="o">=</span> <span class="n">col</span>
                        <span class="n">site_y</span> <span class="o">=</span> <span class="o">-</span><span class="n">row</span> <span class="o">+</span> <span class="mf">0.05</span> <span class="o">-</span> <span class="mf">1.05</span>
                        <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span>
                            <span class="n">mpl</span><span class="o">.</span><span class="n">patches</span><span class="o">.</span><span class="n">Rectangle</span><span class="p">(</span>
                                <span class="p">(</span><span class="n">site_x</span><span class="p">,</span> <span class="n">site_y</span><span class="p">),</span>
                                <span class="n">width</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                <span class="n">height</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;-&quot;</span><span class="p">,</span>
                                <span class="n">fill</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                <span class="n">facecolor</span><span class="o">=</span><span class="n">df_plot_rec_cmap</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">],</span>
                                <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;#AAAAAA&quot;</span>
                                <span class="k">if</span> <span class="n">df_plot_rec_cmap</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;#FFFFFF&quot;</span>
                                <span class="k">else</span> <span class="s2">&quot;#FFFFFF&quot;</span><span class="p">,</span>
                                <span class="n">linewidth</span><span class="o">=</span><span class="mf">3.5</span><span class="p">,</span>
                            <span class="p">)</span>
                        <span class="p">)</span>
                        <span class="c1"># plot text</span>
                        <span class="n">site_x</span> <span class="o">=</span> <span class="n">col</span>
                        <span class="n">site_y</span> <span class="o">=</span> <span class="o">-</span><span class="n">row</span> <span class="o">-</span> <span class="mf">0.55</span>
                        <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
                            <span class="n">x</span><span class="o">=</span><span class="n">site_x</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">,</span>
                            <span class="n">y</span><span class="o">=</span><span class="n">site_y</span><span class="p">,</span>
                            <span class="n">s</span><span class="o">=</span><span class="n">df_plot_rec</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">],</span>
                            <span class="n">horizontalalignment</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
                            <span class="n">verticalalignment</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
                            <span class="n">fontsize</span><span class="o">=</span><span class="mi">34</span> <span class="o">/</span> <span class="mi">1</span> <span class="o">*</span> <span class="n">scale</span><span class="p">,</span>
                            <span class="n">fontname</span><span class="o">=</span><span class="s2">&quot;DejaVu Sans&quot;</span><span class="p">,</span>
                            <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                        <span class="p">)</span>

                <span class="c1"># add seq panels</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">df_plot</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                        <span class="c1"># plot Rectangle</span>
                        <span class="n">site_x</span> <span class="o">=</span> <span class="n">col</span>
                        <span class="n">site_y</span> <span class="o">=</span> <span class="o">-</span><span class="n">row</span> <span class="o">-</span> <span class="mf">1.05</span>
                        <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span>
                            <span class="n">mpl</span><span class="o">.</span><span class="n">patches</span><span class="o">.</span><span class="n">Rectangle</span><span class="p">(</span>
                                <span class="p">(</span><span class="n">site_x</span><span class="p">,</span> <span class="n">site_y</span><span class="p">),</span>
                                <span class="n">width</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                <span class="n">height</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;-&quot;</span><span class="p">,</span>
                                <span class="n">fill</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                <span class="n">facecolor</span><span class="o">=</span><span class="n">df_plot_rec_cmap</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">],</span>
                                <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;#FFFFFF&quot;</span><span class="p">,</span>
                                <span class="n">linewidth</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                            <span class="p">)</span>
                        <span class="p">)</span>

            <span class="c1"># add cbar</span>
            <span class="c1"># start from this site</span>
            <span class="n">site_x</span> <span class="o">=</span> <span class="n">df_plot</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">site_y</span> <span class="o">=</span> <span class="o">-</span><span class="n">figure_height_heatmap</span> <span class="o">*</span> <span class="mf">0.1</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="n">step_scale</span> <span class="o">=</span> <span class="mf">0.1</span>
            <span class="n">lm</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[cbar_scale]: </span><span class="si">{</span><span class="n">step_scale</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">color</span> <span class="ow">in</span> <span class="n">ls_color</span><span class="p">:</span>
                <span class="n">site_y</span> <span class="o">+=</span> <span class="n">step_scale</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span>
                    <span class="n">mpl</span><span class="o">.</span><span class="n">patches</span><span class="o">.</span><span class="n">Rectangle</span><span class="p">(</span>
                        <span class="p">(</span><span class="n">site_x</span><span class="p">,</span> <span class="n">site_y</span><span class="p">),</span>
                        <span class="n">width</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                        <span class="n">height</span><span class="o">=</span><span class="n">step_scale</span><span class="p">,</span>
                        <span class="n">fill</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                        <span class="n">facecolor</span><span class="o">=</span><span class="n">color</span><span class="p">,</span>
                        <span class="n">edgecolor</span><span class="o">=</span><span class="n">color</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">)</span>

            <span class="c1"># add cbar text</span>
            <span class="c1"># start from this site</span>
            <span class="n">site_x</span> <span class="o">=</span> <span class="n">df_plot</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">site_y</span> <span class="o">=</span> <span class="o">-</span><span class="n">figure_height_heatmap</span> <span class="o">*</span> <span class="mf">0.1</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ls_break</span><span class="p">):</span>
                <span class="n">site_y</span> <span class="o">+=</span> <span class="n">step_scale</span>
                <span class="k">if</span> <span class="n">idx</span> <span class="o">%</span> <span class="mi">10</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
                        <span class="n">x</span><span class="o">=</span><span class="n">site_x</span> <span class="o">+</span> <span class="mf">1.1</span><span class="p">,</span>
                        <span class="n">y</span><span class="o">=</span><span class="n">site_y</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
                        <span class="n">s</span><span class="o">=</span><span class="nb">round</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
                        <span class="n">horizontalalignment</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span>
                        <span class="n">verticalalignment</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
                        <span class="n">fontsize</span><span class="o">=</span><span class="mi">34</span> <span class="o">/</span> <span class="mf">1.5</span><span class="p">,</span>
                        <span class="c1">#             fontsize=34 / 1.5 * step_scale,</span>
                        <span class="n">fontname</span><span class="o">=</span><span class="s2">&quot;DejaVu Sans&quot;</span><span class="p">,</span>
                        <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                    <span class="p">)</span>
            <span class="n">fig_heatmap</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">output_fig_heatmap</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s2">&quot;tight&quot;</span><span class="p">)</span>  <span class="c1"># 减少边缘空白</span>
            <span class="c1"># plt.show()</span>

        <span class="k">if</span> <span class="n">output_table_heatmap</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">output_table_heatmap</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.csv&quot;</span><span class="p">):</span>
                <span class="n">df_plot_rec</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">output_table_heatmap</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">output_table_heatmap</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.tsv&quot;</span><span class="p">):</span>
                <span class="n">df_plot_rec</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">output_table_heatmap</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">output_fig_count_ratio</span><span class="p">:</span>
            <span class="c1"># set new figure</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">figure_width</span> <span class="o">*</span> <span class="mf">1.1</span><span class="p">,</span> <span class="n">figure_height</span> <span class="o">*</span> <span class="mf">1.1</span><span class="p">))</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="s2">&quot;equal&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="n">figure_width</span><span class="p">])</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">([</span><span class="o">-</span><span class="n">figure_height</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>

            <span class="n">text_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">patches</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="c1"># print panel_height_coef</span>
            <span class="k">for</span> <span class="n">panel_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">panel_height_coef</span><span class="p">)):</span>
                <span class="c1"># print &#39;panel index:&#39;, panel_index</span>
                <span class="c1"># panel name</span>
                <span class="n">panel_name</span> <span class="o">=</span> <span class="n">plot_data_list</span><span class="p">[</span><span class="n">panel_index</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">panel_name_x</span> <span class="o">=</span> <span class="n">box_x_vec</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="c1"># print panel_name</span>
                <span class="c1"># print panel_name_x</span>
                <span class="n">panel_name_y</span> <span class="o">=</span> <span class="n">current_y</span> <span class="o">-</span> <span class="n">box_height_list</span><span class="p">[</span><span class="n">panel_index</span><span class="p">]</span> <span class="o">*</span> <span class="mf">0.5</span>
                <span class="c1"># print panel_name_y</span>
                <span class="n">text_list</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">panel_name_x</span><span class="p">,</span> <span class="n">panel_name_y</span><span class="p">,</span> <span class="n">panel_name</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>

                <span class="c1"># plot panel box</span>
                <span class="c1"># plot Index行</span>
                <span class="k">if</span> <span class="n">panel_name</span> <span class="o">==</span> <span class="s2">&quot;Ref_index&quot;</span><span class="p">:</span>
                    <span class="c1"># don&#39;t draw box, only add text</span>
                    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">box_value</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">plot_data_list</span><span class="p">[</span><span class="n">panel_index</span><span class="p">][</span><span class="mi">1</span><span class="p">]):</span>
                        <span class="n">box_x</span> <span class="o">=</span> <span class="n">box_x_vec</span><span class="p">[</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
                        <span class="n">text_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="p">(</span>
                                <span class="n">box_x</span> <span class="o">+</span> <span class="n">panel_box_width</span> <span class="o">*</span> <span class="mf">0.5</span><span class="p">,</span>
                                <span class="n">current_y</span> <span class="o">-</span> <span class="n">box_height_list</span><span class="p">[</span><span class="n">panel_index</span><span class="p">]</span> <span class="o">*</span> <span class="mf">0.5</span><span class="p">,</span>
                                <span class="nb">str</span><span class="p">(</span><span class="n">box_value</span><span class="p">),</span>
                                <span class="mi">6</span><span class="p">,</span>
                            <span class="p">)</span>
                        <span class="p">)</span>

                    <span class="c1"># make next panel_y</span>
                    <span class="n">current_y</span> <span class="o">=</span> <span class="n">current_y</span> <span class="o">-</span> <span class="p">(</span>
                        <span class="n">box_height_list</span><span class="p">[</span><span class="n">panel_index</span><span class="p">]</span> <span class="o">+</span> <span class="n">panel_space_list</span><span class="p">[</span><span class="n">panel_index</span><span class="p">]</span>
                    <span class="p">)</span>
                <span class="c1"># plot Target_seq和Ref_seq行</span>
                <span class="k">elif</span> <span class="n">panel_name</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;Target_seq&quot;</span><span class="p">,</span> <span class="s2">&quot;Ref_seq&quot;</span><span class="p">]:</span>
                    <span class="c1"># if panel_name = Ref, form a new list to store plot info for checking the block_ref param</span>
                    <span class="k">if</span> <span class="n">panel_name</span> <span class="o">==</span> <span class="s2">&quot;Ref_seq&quot;</span><span class="p">:</span>
                        <span class="n">plot_data_list_ref</span> <span class="o">=</span> <span class="n">plot_data_list</span><span class="p">[</span><span class="n">panel_index</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">box_value</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">plot_data_list</span><span class="p">[</span><span class="n">panel_index</span><span class="p">][</span><span class="mi">1</span><span class="p">]):</span>
                        <span class="c1"># print(index, box_value)</span>
                        <span class="k">if</span> <span class="n">box_value</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                            <span class="n">box_fill</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="n">box_color</span> <span class="o">=</span> <span class="s2">&quot;#FFFFFF&quot;</span>

                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">aln_direction</span> <span class="o">==</span> <span class="s2">&quot;Reverse Alignment&quot;</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">panel_name</span> <span class="o">==</span> <span class="s2">&quot;Ref_seq&quot;</span><span class="p">:</span>
                                    <span class="n">box_value</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                                        <span class="p">[</span><span class="n">DNA_rev_cmp_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">box_value</span><span class="p">]</span>
                                    <span class="p">)</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="c1">### fix bug</span>
                                    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">box_value</span><span class="p">:</span>
                                        <span class="n">box_value</span> <span class="o">=</span> <span class="n">DNA_rev_cmp_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

                                <span class="n">box_color</span> <span class="o">=</span> <span class="n">base_color_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">box_value</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">box_color</span> <span class="o">=</span> <span class="n">base_color_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">box_value</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

                            <span class="k">if</span> <span class="ow">not</span> <span class="n">box_color</span><span class="p">:</span>
                                <span class="n">box_fill</span> <span class="o">=</span> <span class="kc">False</span>
                                <span class="n">box_color</span> <span class="o">=</span> <span class="s2">&quot;#FFFFFF&quot;</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">box_fill</span> <span class="o">=</span> <span class="kc">True</span>

                        <span class="n">box_x</span> <span class="o">=</span> <span class="n">box_x_vec</span><span class="p">[</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>

                        <span class="n">patches</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="n">Rectangle</span><span class="p">(</span>
                                <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="n">box_x</span><span class="p">,</span> <span class="n">current_y</span> <span class="o">-</span> <span class="n">box_height_list</span><span class="p">[</span><span class="n">panel_index</span><span class="p">]),</span>
                                <span class="n">width</span><span class="o">=</span><span class="n">panel_box_width</span><span class="p">,</span>
                                <span class="n">height</span><span class="o">=</span><span class="n">box_height_list</span><span class="p">[</span><span class="n">panel_index</span><span class="p">],</span>
                                <span class="n">fill</span><span class="o">=</span><span class="n">box_fill</span><span class="p">,</span>
                                <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                <span class="n">linestyle</span><span class="o">=</span><span class="n">box_linestyle</span><span class="p">,</span>
                                <span class="n">linewidth</span><span class="o">=</span><span class="n">box_linewidth</span><span class="p">,</span>
                                <span class="n">edgecolor</span><span class="o">=</span><span class="n">box_edgecolor</span><span class="p">,</span>
                                <span class="n">facecolor</span><span class="o">=</span><span class="n">box_color</span><span class="p">,</span>
                            <span class="p">),</span>
                        <span class="p">)</span>

                        <span class="c1"># text</span>
                        <span class="n">text_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="p">(</span>
                                <span class="n">box_x</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">panel_box_width</span><span class="p">,</span>
                                <span class="n">current_y</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">box_height_list</span><span class="p">[</span><span class="n">panel_index</span><span class="p">],</span>
                                <span class="nb">str</span><span class="p">(</span><span class="n">box_value</span><span class="p">),</span>
                                <span class="mi">16</span><span class="p">,</span>
                            <span class="p">)</span>
                        <span class="p">)</span>

                    <span class="c1"># make next panel_y</span>
                    <span class="n">current_y</span> <span class="o">=</span> <span class="n">current_y</span> <span class="o">-</span> <span class="p">(</span>
                        <span class="n">box_height_list</span><span class="p">[</span><span class="n">panel_index</span><span class="p">]</span> <span class="o">+</span> <span class="n">panel_space_list</span><span class="p">[</span><span class="n">panel_index</span><span class="p">]</span>
                    <span class="p">)</span>
                <span class="c1"># 用来plot Sample行的</span>
                <span class="c1"># 这里plot counts</span>
                <span class="k">elif</span> <span class="n">panel_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;to &quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="n">default_bases</span><span class="p">:</span>
                    <span class="c1"># print &#39;panel name:&#39;, panel_name.split(&#39;to &#39;)[-1].replace(&#39;(%)&#39;, &#39;&#39;)</span>
                    <span class="c1"># print panel_name, &#39;check panel name&#39;</span>
                    <span class="c1"># 改进了这里total 和 base的值的引用</span>
                    <span class="k">if</span> <span class="n">count_ratio</span> <span class="o">==</span> <span class="s2">&quot;all&quot;</span><span class="p">:</span>
                        <span class="n">ls_base_sum_count_all</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="n">ls_base_sum_count</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">default_bases</span><span class="p">)</span>
                        <span class="p">)</span>
                        <span class="n">ls_total_sum_count_all</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="n">ls_total_sum_count</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">default_bases</span><span class="p">)</span>
                        <span class="p">)</span>
                        <span class="n">total_sum_count</span> <span class="o">=</span> <span class="n">ls_total_sum_count_all</span><span class="p">[</span><span class="n">panel_index</span> <span class="o">-</span> <span class="mi">3</span><span class="p">]</span>
                        <span class="n">base_sum_count</span> <span class="o">=</span> <span class="n">ls_base_sum_count_all</span><span class="p">[</span><span class="n">panel_index</span> <span class="o">-</span> <span class="mi">3</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">ls_base_sum_count_all</span> <span class="o">=</span> <span class="n">ls_base_sum_count</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">default_bases</span><span class="p">)</span>
                        <span class="n">ls_total_sum_count_all</span> <span class="o">=</span> <span class="n">ls_total_sum_count</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">default_bases</span><span class="p">)</span>
                        <span class="n">total_sum_count</span> <span class="o">=</span> <span class="n">ls_total_sum_count_all</span><span class="p">[</span><span class="n">panel_index</span> <span class="o">-</span> <span class="mi">3</span><span class="p">]</span>
                        <span class="n">base_sum_count</span> <span class="o">=</span> <span class="n">ls_base_sum_count_all</span><span class="p">[</span><span class="n">panel_index</span> <span class="o">-</span> <span class="mi">3</span><span class="p">]</span>

                    <span class="n">panel_name</span> <span class="o">=</span> <span class="n">panel_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;to &quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

                    <span class="k">if</span> <span class="n">panel_name</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;Del&quot;</span><span class="p">,</span> <span class="s2">&quot;Ins&quot;</span><span class="p">]:</span>
                        <span class="n">box_ratio</span> <span class="o">=</span> <span class="n">plot_data_list</span><span class="p">[</span><span class="n">panel_index</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">total_sum_count</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">box_ratio</span> <span class="o">=</span> <span class="n">plot_data_list</span><span class="p">[</span><span class="n">panel_index</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">base_sum_count</span>

                    <span class="n">box_color_list</span> <span class="o">=</span> <span class="n">map_color</span><span class="p">(</span><span class="n">box_ratio</span><span class="p">,</span> <span class="n">color_break</span><span class="p">,</span> <span class="n">color_list</span><span class="p">)</span>
                    <span class="n">base_sum_count</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">box_value</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">plot_data_list</span><span class="p">[</span><span class="n">panel_index</span><span class="p">][</span><span class="mi">1</span><span class="p">]):</span>
                        <span class="c1"># if count_ratio == &#39;all&#39;:</span>
                        <span class="n">box_color</span> <span class="o">=</span> <span class="n">box_color_list</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
                        <span class="c1"># check block_ref state: count plot</span>
                        <span class="k">if</span> <span class="n">block_ref</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">plot_data_list_ref</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">==</span> <span class="n">panel_name</span><span class="p">:</span>
                                <span class="c1"># if box_value &gt;= ls_base_sum[index] * 0.8:</span>
                                <span class="c1"># box_fill = False</span>
                                <span class="n">box_color</span> <span class="o">=</span> <span class="s2">&quot;#FFFFFF&quot;</span>

                        <span class="n">box_x</span> <span class="o">=</span> <span class="n">box_x_vec</span><span class="p">[</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
                        <span class="n">patches</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="n">Rectangle</span><span class="p">(</span>
                                <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="n">box_x</span><span class="p">,</span> <span class="n">current_y</span> <span class="o">-</span> <span class="n">box_height_list</span><span class="p">[</span><span class="n">panel_index</span><span class="p">]),</span>
                                <span class="n">width</span><span class="o">=</span><span class="n">panel_box_width</span><span class="p">,</span>
                                <span class="n">height</span><span class="o">=</span><span class="n">box_height_list</span><span class="p">[</span><span class="n">panel_index</span><span class="p">],</span>
                                <span class="n">fill</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                <span class="n">linestyle</span><span class="o">=</span><span class="n">box_linestyle</span><span class="p">,</span>
                                <span class="n">linewidth</span><span class="o">=</span><span class="n">box_linewidth</span><span class="p">,</span>
                                <span class="n">edgecolor</span><span class="o">=</span><span class="n">box_edgecolor</span><span class="p">,</span>
                                <span class="n">facecolor</span><span class="o">=</span><span class="n">box_color</span><span class="p">,</span>
                            <span class="p">),</span>
                        <span class="p">)</span>
                        <span class="c1"># text</span>
                        <span class="n">text_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="p">(</span>
                                <span class="n">box_x</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">panel_box_width</span><span class="p">,</span>
                                <span class="n">current_y</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">box_height_list</span><span class="p">[</span><span class="n">panel_index</span><span class="p">],</span>
                                <span class="nb">str</span><span class="p">(</span><span class="n">box_value</span><span class="p">),</span>
                                <span class="mi">6</span><span class="p">,</span>
                            <span class="p">)</span>
                        <span class="p">)</span>
                        <span class="c1"># print box_value</span>
                    <span class="c1"># make next panel_y</span>
                    <span class="n">current_y</span> <span class="o">=</span> <span class="n">current_y</span> <span class="o">-</span> <span class="p">(</span>
                        <span class="n">box_height_list</span><span class="p">[</span><span class="n">panel_index</span><span class="p">]</span> <span class="o">+</span> <span class="n">panel_space_list</span><span class="p">[</span><span class="n">panel_index</span><span class="p">]</span>
                    <span class="p">)</span>

                <span class="c1"># 这里plot ratio(剩下的都是base(%))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">box_color_list</span> <span class="o">=</span> <span class="n">map_color</span><span class="p">(</span>
                        <span class="n">plot_data_list</span><span class="p">[</span><span class="n">panel_index</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">color_break</span><span class="p">,</span> <span class="n">color_list</span>
                    <span class="p">)</span>
                    <span class="c1"># print box_color_list</span>
                    <span class="n">panel_name</span> <span class="o">=</span> <span class="n">panel_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;to &quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;(%)&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

                    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">box_value</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">plot_data_list</span><span class="p">[</span><span class="n">panel_index</span><span class="p">][</span><span class="mi">1</span><span class="p">]):</span>
                        <span class="c1"># ratio</span>
                        <span class="n">box_color</span> <span class="o">=</span> <span class="n">box_color_list</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>

                        <span class="c1"># check block_ref state: ratio plot</span>
                        <span class="k">if</span> <span class="n">block_ref</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">plot_data_list_ref</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">==</span> <span class="n">panel_name</span><span class="p">:</span>
                                <span class="c1"># if box_value &gt;= 0.85:</span>
                                <span class="c1"># box_fill = False</span>
                                <span class="n">box_color</span> <span class="o">=</span> <span class="s2">&quot;#FFFFFF&quot;</span>

                        <span class="n">box_x</span> <span class="o">=</span> <span class="n">box_x_vec</span><span class="p">[</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
                        <span class="n">patches</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="n">Rectangle</span><span class="p">(</span>
                                <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="n">box_x</span><span class="p">,</span> <span class="n">current_y</span> <span class="o">-</span> <span class="n">box_height_list</span><span class="p">[</span><span class="n">panel_index</span><span class="p">]),</span>
                                <span class="n">width</span><span class="o">=</span><span class="n">panel_box_width</span><span class="p">,</span>
                                <span class="n">height</span><span class="o">=</span><span class="n">box_height_list</span><span class="p">[</span><span class="n">panel_index</span><span class="p">],</span>
                                <span class="n">fill</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                <span class="n">linestyle</span><span class="o">=</span><span class="n">box_linestyle</span><span class="p">,</span>
                                <span class="n">linewidth</span><span class="o">=</span><span class="n">box_linewidth</span><span class="p">,</span>
                                <span class="n">edgecolor</span><span class="o">=</span><span class="n">box_edgecolor</span><span class="p">,</span>
                                <span class="n">facecolor</span><span class="o">=</span><span class="n">box_color</span><span class="p">,</span>
                            <span class="p">),</span>
                        <span class="p">)</span>

                        <span class="k">if</span> <span class="s2">&quot;(%)&quot;</span> <span class="ow">in</span> <span class="n">plot_data_list</span><span class="p">[</span><span class="n">panel_index</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span>
                            <span class="c1"># text</span>
                            <span class="c1"># ref</span>
                            <span class="c1"># print &#39;test&#39;, box_value</span>
                            <span class="c1"># if ARGS.block_ref == True:</span>
                            <span class="c1">#     if box_value &gt;= 0.99:</span>
                            <span class="c1">#         box_value = 0</span>

                            <span class="n">text_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                                <span class="p">(</span>
                                    <span class="n">box_x</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">panel_box_width</span><span class="p">,</span>
                                    <span class="n">current_y</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">box_height_list</span><span class="p">[</span><span class="n">panel_index</span><span class="p">],</span>
                                    <span class="nb">round</span><span class="p">(</span><span class="n">box_value</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
                                    <span class="mi">6</span><span class="p">,</span>
                                <span class="p">)</span>
                            <span class="p">)</span>

                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">text_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                                <span class="p">(</span>
                                    <span class="n">box_x</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">panel_box_width</span><span class="p">,</span>
                                    <span class="n">current_y</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">box_height_list</span><span class="p">[</span><span class="n">panel_index</span><span class="p">],</span>
                                    <span class="n">box_value</span><span class="p">,</span>
                                    <span class="mi">6</span><span class="p">,</span>
                                <span class="p">)</span>
                            <span class="p">)</span>

                    <span class="c1"># make next panel_y</span>
                    <span class="k">if</span> <span class="n">panel_index</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">panel_space_list</span><span class="p">):</span>
                        <span class="n">current_y</span> <span class="o">=</span> <span class="n">current_y</span> <span class="o">-</span> <span class="p">(</span>
                            <span class="n">box_height_list</span><span class="p">[</span><span class="n">panel_index</span><span class="p">]</span> <span class="o">+</span> <span class="n">panel_space_list</span><span class="p">[</span><span class="n">panel_index</span><span class="p">]</span>
                        <span class="p">)</span>

            <span class="c1"># plot box</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">add_collection</span><span class="p">(</span><span class="n">PatchCollection</span><span class="p">(</span><span class="n">patches</span><span class="p">,</span> <span class="n">match_original</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>

            <span class="c1"># add text</span>
            <span class="k">for</span> <span class="n">text_x</span><span class="p">,</span> <span class="n">text_y</span><span class="p">,</span> <span class="n">text_info</span><span class="p">,</span> <span class="n">text_fontsize</span> <span class="ow">in</span> <span class="n">text_list</span><span class="p">:</span>
                <span class="k">if</span> <span class="s2">&quot; to &quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">text_info</span><span class="p">):</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
                        <span class="n">x</span><span class="o">=</span><span class="n">text_x</span> <span class="o">+</span> <span class="mf">0.3</span><span class="p">,</span>
                        <span class="n">y</span><span class="o">=</span><span class="n">text_y</span><span class="p">,</span>
                        <span class="n">s</span><span class="o">=</span><span class="n">text_info</span><span class="p">,</span>
                        <span class="n">horizontalalignment</span><span class="o">=</span><span class="s2">&quot;right&quot;</span><span class="p">,</span>
                        <span class="n">verticalalignment</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
                        <span class="n">fontsize</span><span class="o">=</span><span class="n">text_fontsize</span><span class="p">,</span>
                        <span class="n">fontname</span><span class="o">=</span><span class="s2">&quot;DejaVu Sans&quot;</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
                        <span class="n">x</span><span class="o">=</span><span class="n">text_x</span><span class="p">,</span>
                        <span class="n">y</span><span class="o">=</span><span class="n">text_y</span><span class="p">,</span>
                        <span class="n">s</span><span class="o">=</span><span class="n">text_info</span><span class="p">,</span>
                        <span class="n">horizontalalignment</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
                        <span class="n">verticalalignment</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
                        <span class="n">fontsize</span><span class="o">=</span><span class="n">text_fontsize</span><span class="p">,</span>
                        <span class="n">fontname</span><span class="o">=</span><span class="s2">&quot;DejaVu Sans&quot;</span><span class="p">,</span>
                    <span class="p">)</span>

            <span class="c1"># output plot</span>
            <span class="k">if</span> <span class="n">output_fig_fmt</span><span class="o">.</span><span class="n">upper</span> <span class="o">==</span> <span class="s2">&quot;PNG&quot;</span><span class="p">:</span>
                <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span>
                    <span class="n">fname</span><span class="o">=</span><span class="n">output_fig_count_ratio</span><span class="p">,</span>
                    <span class="n">bbox_inches</span><span class="o">=</span><span class="s2">&quot;tight&quot;</span><span class="p">,</span>
                    <span class="n">dpi</span><span class="o">=</span><span class="n">output_fig_dpi</span><span class="p">,</span>
                    <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;png&quot;</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span>
                    <span class="n">fname</span><span class="o">=</span><span class="n">output_fig_count_ratio</span><span class="p">,</span>
                    <span class="n">bbox_inches</span><span class="o">=</span><span class="s2">&quot;tight&quot;</span><span class="p">,</span>
                    <span class="n">dpi</span><span class="o">=</span><span class="n">output_fig_dpi</span><span class="p">,</span>
                    <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;pdf&quot;</span><span class="p">,</span>
                <span class="p">)</span>

        <span class="k">if</span> <span class="n">output_table_count_ratio</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">output_table_count_ratio</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.csv&quot;</span><span class="p">):</span>
                <span class="n">df_bases_select</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">output_table_count_ratio</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">output_table_count_ratio</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.tsv&quot;</span><span class="p">):</span>
                <span class="n">df_bases_select</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">output_table_count_ratio</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)</span></div>
</div>



<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="k">pass</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright .</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>